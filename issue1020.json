{
  "title": "sometimes shell tool crashes out of llxprt",
  "body": "### What happened?\n\n╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮\n │ ⊷  Shell cd /Users/acoliver/projects/llxprt/branch-2/llxprt-code/packages/core && npm test -- task.test.ts --reporter=verbose (Run task tests with verbose output)             │\n │                                                                                                                                                                                │\n │    Press 'ctrl+r' to show running command                                                                                                                                      │\n │                                                                                                                                                                                │\n │                                                                                                                                                                                │\n │    > @vybestack/llxprt-code-core@0.8.0 test                                                                                                                                    │\n │    > vitest run task.test.ts --reporter=verbose                                                                                                                                │\n │                                                                                                                                                                                │\n │                                                                                                                                                                                │\n │     RUN  v3.2.4 /Users/acoliver/projects/llxprt/branch-2/llxprt-code/packages/core                                                                                             │\n │          Coverage enabled with v8                                                                                                                                              │\n │                                                                                                                                                                                │\n │     [OK] src/tools/task.test.ts > TaskTool > launches the orchestrator and returns subagent output 15ms                                                                           │\n ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────█\n\n⠸ I want you to hit me as hard as you can. (esc to cancel, 3m 25s)\n\nUsing: 2 LLXPRT.md files                                                                                                                             YOLO mode (ctrl + y to toggle)\n╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮\n│ >   Type your message or @path/to/file                                                                                                                                          │\n╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯\n(issue920*)                                                                                                      Context: 30,319/190,000 tokens | TPM: 2.55k | Wait: 0ms | 02:10:40\n~/projects/llxprt/branch-2/llxprt-code  [no sandbox (see /docs)]                                           hf:zai-org/GLM-4.7 | Tokens: 4,043,479 |  2 errors (ctrl+o for details)\nnode:events:486\n      throw er; // Unhandled 'error' event\n      ^\n\nError: read EIO\n    at TTY.onStreamRead (node:internal/stream_base_commons:216:20)\nEmitted 'error' event on ReadStream instance at:\n    at emitErrorNT (node:internal/streams/destroy:170:8)\n    at emitErrorCloseNT (node:internal/streams/destroy:129:3)\n    at process.processTicksAndRejections (node:internal/process/task_queues:89:21) {\n  errno: -5,\n  code: 'EIO',\n  syscall: 'read'\n}\n\nNode.js v25.2.1\n\n\n### What did you expect to happen?\n\nnot crash\n\n### Client information\n\nAbout LLxprt Code\n\n CLI Version                                                  0.8.0\n Git Commit                                                   ec5819117\n Model                                                        openai:hf:zai-org/GLM-4.7\n Provider                                                     openai\n Base URL                                                     https://api.synthetic.new/openai/v1\n Sandbox                                                      no sandbox\n OS                                                           darwin\n Auth Method\n",
  "comments": [
    {
      "id": "IC_kwDOPB5qbc7dUj8O",
      "author": "acoliver",
      "date": "2026-01-06T05:20:26Z",
      "body": "@coderabbit -- look into this -- why is thsi happening"
    },
    {
      "id": "IC_kwDOPB5qbc7dUkWd",
      "author": "coderabbitai",
      "date": "2026-01-06T05:21:26Z",
      "body": "@acoliver I found the issue! The crash is caused by a **missing error event handler on the PTY process**.\n\n## Root Cause\n\nWhen you run a shell command using the PTY path (node-pty/lydell-node-pty), the code in `shellExecutionService.ts` registers handlers for:\n- `ptyProcess.onData()` (line 512)\n- `ptyProcess.onExit()` (line 517)\n\nHowever, it's **missing an error handler**. When the PTY encounters an I/O error (like \"read EIO\"), it emits an 'error' event. Since there's no listener registered, Node.js throws it as an unhandled exception, crashing your entire process.\n\n## The Fix\n\nThe PTY path needs an error handler similar to the child_process path (which has one at line 305). Here's what needs to be added in the `executeWithPty` method around line 517:\n\n```typescript\nptyProcess.onData((data: string) => {\n  const bufferData = Buffer.from(data, 'utf-8');\n  handleOutput(bufferData);\n});\n\n// ADD THIS ERROR HANDLER\nif (ptyProcess.on) {\n  ptyProcess.on('error', (err: Error) => {\n    // Log or handle the error gracefully instead of crashing\n    // The onExit handler will still be called and resolve the promise\n  });\n}\n\nptyProcess.onExit(\n  ({ exitCode, signal }: { exitCode: number; signal?: number }) => {\n    // ... existing code\n  },\n);\n```\n\nThe error handler should store the error and let the `onExit` handler include it in the final result, similar to how the child_process path handles errors.\n\nWould you like me to provide a complete code fix showing exactly how to integrate the error handling into the existing promise resolution logic?"
    },
    {
      "id": "IC_kwDOPB5qbc7damBo",
      "author": "acoliver",
      "date": "2026-01-06T13:39:11Z",
      "body": "@coderabbit here it looks like it threw during shell and then threw and executed after. I'm not clear but from the output:\n\n⊶  Shell sleep 180 && gh pr checks 1021 2>&1 | grep \"Test (windows\" (Wait for Windows tests and check status)                                                                                                                                  │\n │                                                                                                                                                                                │\n │    Press 'ctrl+r' to show running command                                                                                                                                      │\n ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────█\n\n⠸ It is not necessary for the public to know whether I am joking or whether I am serious, just as it is not necessary for me to know it myself. (esc to cancel, 28m 53s)\n\nUsing: 2 LLXPRT.md files                                                                                                                             YOLO mode (ctrl + y to toggle)\n╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮\n│ >   Type your message or @path/to/file                                                                                                                                          │\n╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯\n(issue920*)                                                                                                     Context: 102,280/190,000 tokens | TPM: 2.44k | Wait: 0ms | 02:57:33\n~/projects/llxprt/branch-2/llxprt-code  [no sandbox (see /docs)]                                          hf:zai-org/GLM-4.7 | Tokens: 10,114,109 |  6 errors (ctrl+o for details)\nnode:events:486\n      throw er; // Unhandled 'error' event\n      ^\n\nError: read EIO\n    at TTY.onStreamRead (node:internal/stream_base_commons:216:20)\nEmitted 'error' event on ReadStream instance at:\n    at emitErrorNT (node:internal/streams/destroy:170:8)\n    at emitErrorCloseNT (node:internal/streams/destroy:129:3)\n    at process.processTicksAndRejections (node:internal/process/task_queues:89:21) {\n  errno: -5,\n  code: 'EIO',\n  syscall: 'read'\n}\n\nNode.js v25.2.1\n\n\nacoliver@Andrews-MacBook-Pro llxprt-code % node scripts/start.js --profile-load syntheticglm47\nChecking build status...\nBuild is up-to-date.\nWarning: `--localstorage-file` was provided without a valid path\n    at Object.get (node:internal/webstorage:32:25)\n    at getIsReloadAndProfileSupported (/Users/acoliver/projects/llxprt/branch-2/llxprt-code/node_modules/react-devtools-core/dist/backend.js:4579:18)\n    at Module.connectToDevTools (/Users/acoliver/projects/llxprt/branch-2/llxprt-code/node_modules/react-devtools-core/dist/backend.js:18017:72)\n    at file:///Users/acoliver/projects/llxprt/branch-2/llxprt-code/node_modules/ink/build/devtools.js:10:10\n    at ModuleJob.run (node:internal/modules/esm/module_job:413:25)\n    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:654:26)\n    at async file:///Users/acoliver/projects/llxprt/branch-2/llxprt-code/node_modules/ink/build/reconciler.js:13:9\n      - Implemented timeout logic with AbortController and setTimeout\n      - Handles -1 for unlimited timeout\n      - Clamps requested timeout to max setting\n      - Returns ToolErrorType.TIMEOUT for timeouts (distinct from ToolErrorType.EXECUTION_FAILED for user aborts)\n      - Includes partial output in timeout message\n\n   3. Implemented timeout_ms for TaskTool (packages/core/src/tools/task.ts):\n      - Added timeout_ms? parameter to TaskToolParams interface\n      - Added constants: DEFAULT_TASK_TIMEOUT_MS (60s) and MAX_TASK_TIMEOUT_MS (300s)\n      - Implemented same timeout pattern as ShellTool\n      - Passes max_time_minutes to subagent orchestrator\n      - Distinguishes between timeout and user abort with distinct error types\n\n   4. Comprehensive Testing:\n      - shell.test.ts: Added 5 new timeout tests covering defaults, max enforcement, -1 unlimited, TIMEOUT error, and user abort distinction\n      - task.test.ts: Added 5 new timeout tests with same coverage\n      - All 55 tests pass for shell and task tools\n      - Full test suite passes: 2550 tests across all packages\n\n   5. Code Quality:\n      - [OK] TypeScript compilation passes (npm run typecheck)\n      - [OK] Linting passes (npm run lint)\n      - [OK] Code formatted (npm run format)\n      - [OK] Build successful (npm run build)\n      - Fixed CodeRabbit nitpick: removed unnecessary removeEventListener call\n\n   6. Git & PR Status:\n      - Created 2 commits on issue920 branch:\n        - beef1eb0d: \"feat: implement timeout_ms parameter for shell and task tools\"\n        - df47aa238: \"refactor: remove unnecessary removeEventListener call before listener is added\"\n      - Both commits pushed to origin/issue9\n20\n      - Existing PR #1021 is being updated with these changes\n      - CI checks are running and passing so far (E2E tests still in progress)\n\n  Key Features\n\n   - YOLO mode: -1 value means unlimited timeout\n   - Clamping: Configurable max timeouts prevent runaway execution\n   - Distinct errors: ToolErrorType.TIMEOUT vs ToolErrorType.EXECUTION_FAILED for proper error handling\n   - Partial output: Timeout messages include any partial output collected\n   - Integration: Works with ephemeral settings added in PR #1021\n\n  The implementation follows the established pattern from GrepTool and all tests pass. The PR is ready for review and all CI checks are proceeding successfully.\n\nUsing: 2 LLXPRT.md files                                                                                                                             YOLO mode (ctrl + y to toggle)\n╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮\n│ >   Type your message or @path/to/file                                                                                                                                          │\n╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯\n(issue920*)                                                                                                     Context: 102,169/190,000 tokens | TPM: 4.46k | Wait: 0ms | 10:36:14\n~/projects/llxprt/branch-2/llxprt-code  [no sandbox (see /docs)]                                                                            hf:zai-org/GLM-4.7 | Tokens: 40,662,113\nnode:events:486\n      throw er; // Unhandled 'error' event\n      ^\n\nError: read EIO\n    at TTY.onStreamRead (node:internal/stream_base_commons:216:20)\nEmitted 'error' event on ReadStream instance at:\n    at emitErrorNECloseNT (node:internal/streams/destroy:129:3)\n    at process.processTicksAndRejections (node:internal/process/task_queues:89:21) {\n  errno: -5,\n  code: 'EIO',\n  syscall: 'read'\n}\n\nNode.js v25.2.1\n"
    },
    {
      "id": "IC_kwDOPB5qbc7dana9",
      "author": "coderabbitai",
      "date": "2026-01-06T13:41:04Z",
      "body": "@acoliver I found the root cause! This is a different issue from the PTY error handler I mentioned before.\n\n## Root Cause\n\nThe crash is happening on **the main process's `process.stdin`**, not the shell tool's PTY. When you look at the stack trace:\n\n```\nError: read EIO\n    at TTY.onStreamRead (node:internal/stream_base_commons:216:20)\nEmitted 'error' event on ReadStream instance at:\n```\n\nThis is `process.stdin` (the main Ink app's input stream) encountering an I/O error. On macOS, after long-running sessions (28+ minutes in your case), the terminal can experience transient I/O errors that cause the stdin stream to emit an 'error' event.\n\n## The Problem\n\nIn `packages/cli/src/gemini.tsx`, the code sets stdin to raw mode:\n\n```typescript\nprocess.stdin.setRawMode(true);\n```\n\nBut there's **no global error handler** registered on `process.stdin`. So when the terminal has an I/O hiccup, the 'error' event is unhandled and Node.js crashes the entire process.\n\nThe `readStdin.ts` utility does have an error handler (line 66), but that's only active during the initial stdin reading phase. Once the interactive app starts, that handler is removed and there's no global protection.\n\n## The Fix\n\nAdd a global error handler for `process.stdin` in `gemini.tsx` after setting raw mode. Here's what needs to be added around line 578 (after `process.stdin.setRawMode(true)`):\n\n```typescript\nif (\n  config.isInteractive() &&\n  !argv.experimentalUi &&\n  !wasRaw &&\n  process.stdin.isTTY\n) {\n  await drainStdinBuffer(process.stdin, 50);\n  process.stdin.setRawMode(true);\n\n  // ADD THIS: Handle stdin I/O errors gracefully\n  process.stdin.on('error', (err) => {\n    // Log the error but don't crash the app\n    // The app can often recover from transient I/O errors\n    if (config.getDebugMode()) {\n      console.error('[stdin] I/O error (non-fatal):', err);\n    }\n    // Attempt to resume stdin if it was paused\n    if (process.stdin.isPaused()) {\n      try {\n        process.stdin.resume();\n      } catch {\n        // Ignore if resume fails\n      }\n    }\n  });\n\n  // Existing cleanup code...\n  process.on('SIGTERM', async () => {\n    // ...\n  });\n}\n```\n\nThis will:\n1. Catch I/O errors on stdin\n2. Log them in debug mode for diagnostics\n3. Try to resume stdin if it was paused\n4. **Most importantly**: prevent the entire process from crashing\n\nThe error is transient (which is why restarting works), so gracefully handling it is the right approach rather than crashing.\n\nWould you like me to create an issue for this fix?"
    }
  ]
}
