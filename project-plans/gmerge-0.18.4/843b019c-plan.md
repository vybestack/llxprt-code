# Reimplement Plan: 843b019c — Loading Indicator + Inactivity Timer + Shell Focus Hints

## Upstream Commit
- **SHA:** `843b019cef382b2c`
- **Subject:** fix(patch): cherry-pick d351f07 — loading indicator, phrase cycler, inactivity timer
- **Files touched:** 13 files, +416/−103

## Why REIMPLEMENT (not PICK)

LLxprt's `usePhraseCycler` and `useLoadingIndicator` have diverged from upstream:

- **LLxprt uses WittyPhraseStyle system** — `getPhraseCollection(style, customPhrases)` via `phrasesCollections.js`. Upstream uses `INFORMATIVE_TIPS` / `WITTY_LOADING_PHRASES` with a 1/6 random tip chance. These are different APIs.
- **LLxprt's useLoadingIndicator has `wittyPhraseStyle` parameter** — upstream doesn't have this concept.
- **LLxprt has no `useInactivityTimer` hook** — this is a new file.
- **LLxprt has no `ToolShared.tsx`, `ToolResultDisplay.tsx`, or `ShellToolMessage.tsx`** — upstream's ToolMessage uses these extracted components. LLxprt's ToolMessage is monolithic.

Cherry-picking would conflict on nearly every file.

## What Upstream Does (Behavioral Goal)

1. **New `useInactivityTimer` hook** — generic timer that returns `true` after N ms of no trigger changes
2. **Shell focus hints** — when an interactive shell is running but not focused, after 5s inactivity show "press Ctrl+f to focus shell" in:
   - The loading phrase cycler (loading indicator level)
   - The ToolMessage header (per-tool level)
3. **`lastOutputTime` plumbing** — tracks the most recent output from tool scheduler and shell processor, plumbed through `useGeminiStream` → `AppContainer` → `useLoadingIndicator`
4. **`SHELL_FOCUS_HINT_DELAY_MS`** constant (5000ms) added to `constants.ts`

## LLxprt Adaptation

### Files to create:
1. `packages/cli/src/ui/hooks/useInactivityTimer.ts` — take directly from upstream (it's a pure utility hook with no LLxprt divergence). Update copyright to Vybestack.

### Files to modify:
1. `packages/cli/src/ui/constants.ts` — add `SHELL_FOCUS_HINT_DELAY_MS = 5000`
2. `packages/cli/src/ui/hooks/usePhraseCycler.ts` — add `isInteractiveShellWaiting` and `lastOutputTime` params, add `showShellFocusHint` logic using `useInactivityTimer`, restructure effect to early-return pattern. **Preserve WittyPhraseStyle system** (LLxprt's `getPhraseCollection` replaces upstream's INFORMATIVE_TIPS/WITTY_LOADING_PHRASES logic).
3. `packages/cli/src/ui/hooks/useLoadingIndicator.ts` — add `isInteractiveShellWaiting` and `lastOutputTime` params, pass through to `usePhraseCycler`. **Preserve `wittyPhraseStyle` parameter.**
4. `packages/cli/src/ui/hooks/useReactToolScheduler.ts` — add `lastToolOutputTime` state, set it on output updates, return it in the tuple.
5. `packages/cli/src/ui/hooks/shellCommandProcessor.ts` — add `lastShellOutputTime` state, set it on throttled output updates, return it from hook.
6. `packages/cli/src/ui/hooks/useGeminiStream.ts` — destructure `lastToolOutputTime` from `useReactToolScheduler`, `lastShellOutputTime` from `useShellCommandProcessor`, compute `lastOutputTime = Math.max(...)`, return it.
7. `packages/cli/src/ui/AppContainer.tsx` — destructure `lastOutputTime` from `useGeminiStream`, pass `isInteractiveShellWaiting` and `lastOutputTime` to `useLoadingIndicator`.
8. `packages/cli/src/ui/components/LoadingIndicator.tsx` — import `INTERACTIVE_SHELL_WAITING_PHRASE` from usePhraseCycler, prioritize it over thought.subject when active.
9. `packages/cli/src/ui/components/messages/ToolMessage.tsx` — add shell focus hint to header (Ctrl+f hint text when shell is executing but not focused). Add `activeShellPtyId`, `embeddedShellFocused`, `ptyId`, `config` props. Use `useInactivityTimer` for per-tool focus hint display.

### Files NOT modified (upstream-specific):
- `packages/cli/src/ui/hooks/usePhraseCycler.test.tsx` — tests will need to be written for LLxprt's modified API (different params)
- `packages/cli/src/ui/hooks/useLoadingIndicator.test.tsx` — same

## Execution Order

### Step 1: Create useInactivityTimer
Copy upstream implementation verbatim (it's a clean utility). Fix copyright.

### Step 2: Add SHELL_FOCUS_HINT_DELAY_MS to constants.ts
Add `export const SHELL_FOCUS_HINT_DELAY_MS = 5000;` to constants.ts.

### Step 3: Modify usePhraseCycler.ts
Add new parameters after existing ones:
```typescript
export const INTERACTIVE_SHELL_WAITING_PHRASE =
  'Interactive shell awaiting input... press Ctrl+f to focus shell';

export const usePhraseCycler = (
  isActive: boolean,
  isWaiting: boolean,
  style: WittyPhraseStyle = 'default',         // LLxprt-specific — KEEP
  isInteractiveShellWaiting: boolean = false,   // NEW from upstream
  lastOutputTime: number = 0,                    // NEW from upstream
  customPhrases?: string[],
) => {
```

Add `useInactivityTimer` for shell focus detection. Restructure the effect to early-return pattern (upstream's cleaner approach). **Keep `loadingPhrases` from `getPhraseCollection(style, customPhrases)`** — do NOT switch to upstream's INFORMATIVE_TIPS/WITTY_LOADING_PHRASES.

### Step 4: Modify useLoadingIndicator.ts
Add params after `wittyPhraseStyle`:
```typescript
export const useLoadingIndicator = (
  streamingState: StreamingState,
  wittyPhraseStyle: WittyPhraseStyle = 'default',  // LLxprt-specific — KEEP
  customWittyPhrases?: string[],
  isInteractiveShellWaiting: boolean = false,       // NEW
  lastOutputTime: number = 0,                        // NEW
) => {
```
Pass through to `usePhraseCycler`.

### Step 5: Plumb lastOutputTime
1. `useReactToolScheduler` — add `lastToolOutputTime` state + `setLastToolOutputTime(Date.now())` in `outputUpdateHandler`. Append to return tuple.
2. `shellCommandProcessor` — add `lastShellOutputTime` state + set in throttled update. Return from hook.
3. `useGeminiStream` — destructure both, compute `Math.max(...)`, add to return object.

### Step 6: Wire AppContainer
Destructure `lastOutputTime` from `useGeminiStream`. Pass to `useLoadingIndicator`:
```typescript
const { elapsedTime, currentLoadingPhrase } = useLoadingIndicator(
  streamingState,
  settings.merged.ui?.wittyPhraseStyle,       // LLxprt-specific
  settings.merged.ui?.customWittyPhrases,
  !!activePtyId && !embeddedShellFocused,     // NEW
  lastOutputTime,                              // NEW
);
```

### Step 7: LoadingIndicator + ToolMessage focus hints
1. `LoadingIndicator.tsx` — prioritize `INTERACTIVE_SHELL_WAITING_PHRASE` over `thought?.subject`.
2. `ToolMessage.tsx` — add shell focus hint in header using `useInactivityTimer`. Add props: `activeShellPtyId`, `embeddedShellFocused`, `ptyId`, `config`. Display "(Focused)" or "(ctrl+f to focus)" text when applicable.

### Step 8: Tests
Update `usePhraseCycler.test.tsx` and `useLoadingIndicator.test.tsx` for new parameters. Add test for `useInactivityTimer`.

## Preservation Checklist

- [ ] `WittyPhraseStyle` parameter kept in `usePhraseCycler` and `useLoadingIndicator`
- [ ] `getPhraseCollection(style, customPhrases)` kept (not replaced by upstream's INFORMATIVE_TIPS logic)
- [ ] `useMemo` for `loadingPhrases` kept
- [ ] `wittyPhraseStyle` setting from `phrasesCollections.js` kept
- [ ] Vybestack copyright on new/modified files
- [ ] No `@google/gemini-cli-core` imports (use `@vybestack/llxprt-code-core`)

## Risk Assessment

- **Medium risk** — Many files modified but changes are mostly additive (new params, new state, new hook)
- **Main conflict area**: `usePhraseCycler` effect restructuring must be done carefully to preserve WittyPhraseStyle while adopting upstream's cleaner early-return pattern
- **ToolMessage.tsx** in LLxprt doesn't have `ToolShared.tsx` extracted components — the focus hint needs to be added directly to LLxprt's monolithic ToolMessage (but this is straightforward, just add a `<Text>` element in the header)
