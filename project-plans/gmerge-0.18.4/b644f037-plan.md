# REIMPLEMENT: b644f037 — Escape clears input when idle

## Upstream Summary

When the user presses Escape while the model is NOT executing tools, the input prompt should be cleared (not restored to the previous prompt). When the model IS executing tools, just clear the prompt. When context overflows, restore the prompt.

## What Upstream Changed

1. `cancelHandlerRef` type: `() => void` → `(shouldRestorePrompt?: boolean) => void`
2. `onCancelSubmit` gains the same optional param
3. Cancel handler logic: if `shouldRestorePrompt` is false (or omitted), don't restore previous user message
4. `useGeminiStream.ts`: `onCancelSubmit` param type updated; calls `onCancelSubmit(false)` on normal cancel, `onCancelSubmit(true)` on context overflow

## LLxprt Differences

- LLxprt's cancel handler is `() => void` (AppContainer.tsx ~line 1625)
- LLxprt uses `inputHistoryStore.inputHistory` instead of `userMessages`
- LLxprt's AppContainer is much larger/different from upstream

## Implementation Steps

1. **Read** current `packages/cli/src/ui/AppContainer.tsx` — find `cancelHandlerRef` declaration and the cancel handler callback
2. **Read** current `packages/cli/src/ui/hooks/useGeminiStream.ts` — find `onCancelSubmit` parameter and its call sites
3. **Modify** `cancelHandlerRef` type to `(shouldRestorePrompt?: boolean) => void`
4. **Modify** `onCancelSubmit` wrapper to accept and forward `shouldRestorePrompt`
5. **Modify** the cancel handler callback to use `shouldRestorePrompt` parameter:
   - When `shouldRestorePrompt` is false/undefined: set text to empty string
   - When `shouldRestorePrompt` is true: restore previous message from `inputHistoryStore`
   - When tools are executing: always just clear (existing behavior)
6. **Modify** `useGeminiStream.ts`:
   - Update `onCancelSubmit` parameter type to `(shouldRestorePrompt?: boolean) => void`
   - Change normal cancel call to `onCancelSubmit(false)`
   - Change context overflow call to `onCancelSubmit(true)`
7. **Add/update tests** in AppContainer.test.tsx to verify:
   - Escape while idle clears input (doesn't restore)
   - Context overflow restores prompt

## Branding: N/A (no branding issues)

## Verification

```bash
npm run lint && npm run typecheck
```
