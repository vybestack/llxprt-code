# REIMPLEMENT: 2e8d7831 — Move stdio to core + terminal utils

## Upstream Summary

Moves `stdio.ts` from `packages/cli/src/utils/` to `packages/core/src/utils/`, adds a new `terminal.ts` utility in core, and makes various auth/dialog changes. 17 files, 354+/189-.

## Why REIMPLEMENT

- Auth dialog changes (`AuthDialog.tsx`) are completely different — LLxprt has multi-provider auth at a different file path (`packages/cli/src/ui/components/AuthDialog.tsx`)
- The stdio move is mechanical but needs to update all import paths
- The `terminal.ts` utility is new and useful
- `oauth2.ts` changes are Gemini-specific

## Dependencies

- **Batch 11 (d1e35f86) MUST be applied first** — `stdio.ts` must exist in cli before it can be moved to core

## What to TAKE

1. **Move `stdio.ts` from cli to core**: Update `packages/core/src/utils/stdio.ts` with the content from `packages/cli/src/utils/stdio.ts`, update all imports
2. **Create `terminal.ts`**: New utility in `packages/core/src/utils/terminal.ts` with terminal detection/capability functions
3. **`packages/core/src/index.ts`**: Export new utilities
4. **`useBracketedPaste.ts`**: Import path update for stdio
5. **`kittyProtocolDetector.ts`**: Import path update
6. **`mouse.ts`**: Import path update
7. **`stdio.test.ts`**: Move test to core, update imports

## What to SKIP

1. **`AuthDialog.tsx`** changes — completely different in LLxprt (different path, multi-provider)
2. **`AuthDialog.test.tsx`** — same reason
3. **`oauth2.ts` / `oauth2.test.ts`** changes — Gemini-specific auth
4. **`DialogManager.tsx`** auth-related changes
5. **`gemini.tsx` / `gemini.test.tsx`** auth flow changes
6. **`packages/cli/index.ts`** — check if changes are auth-related before skipping

## Implementation Steps

### Phase 1: Create terminal.ts in core

1. **Read** upstream `terminal.ts`: `git show 2e8d7831:packages/core/src/utils/terminal.ts`
2. **Create** `packages/core/src/utils/terminal.ts` — adapt to LLxprt
3. **Export** from `packages/core/src/index.ts`

### Phase 2: Move stdio.ts to core

4. **Read** current `packages/cli/src/utils/stdio.ts` (created by d1e35f86)
5. **Read** upstream `packages/core/src/utils/stdio.ts`: `git show 2e8d7831:packages/core/src/utils/stdio.ts`
6. **Create** `packages/core/src/utils/stdio.ts` with the updated content
7. **Update** `packages/core/src/index.ts` to export stdio utilities
8. **Delete** `packages/cli/src/utils/stdio.ts` (now in core)
9. **Move** `packages/cli/src/utils/stdio.test.ts` to `packages/core/src/utils/stdio.test.ts`

### Phase 3: Update imports

10. **Search** for all imports of `../utils/stdio` or `../../utils/stdio` in cli package
11. **Update** each to import from `@vybestack/llxprt-code-core`
12. Key files to update:
    - `useBracketedPaste.ts`
    - `kittyProtocolDetector.ts`
    - `mouse.ts`
    - Any other files importing from the old path

### Phase 4: Non-auth changes from cli/index.ts and gemini.tsx

13. **Read** upstream diffs for `packages/cli/index.ts` and `packages/cli/src/gemini.tsx`
14. **Apply** only non-auth changes (e.g., import path updates, exit cleanup)
15. **Skip** auth dialog/oauth2 changes entirely

### Phase 5: Tests

16. **Update** `stdio.test.ts` in its new location
17. **Run** tests to verify imports resolve correctly

## Branding

- All imports use `@vybestack/llxprt-code-core`
- `terminal.ts` is generic — no branding issues

## Verification

```bash
npm run lint && npm run typecheck && npm run test && npm run format && npm run build && node scripts/start.js --profile-load synthetic --prompt "write me a haiku"
```
