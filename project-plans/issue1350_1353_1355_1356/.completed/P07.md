# Phase 07: Wrapper Contract Tests — COMPLETED

@plan PLAN-20260211-SECURESTORE.P07

## Summary

Created forward-looking integration tests that verify SecureStore can serve as
the backend for the three thin wrappers (ToolKeyStorage, KeychainTokenStorage,
ExtensionSettingsStorage) when they are refactored in Phase 08.

## Test File

`packages/core/src/storage/secure-store-integration.test.ts` — 17 tests

## Test Inventory

### ToolKeyStorage Pattern Tests (5)
1. **Store raw string value and retrieve it** — Round-trips raw API key strings
2. **Delete a stored key** — delete() removes and get() returns null
3. **Has returns true for existing key** — has() detects presence/absence
4. **Service name scoping isolates data** — Different service names keep data separate
5. **maskKeyForDisplay works on retrieved values** — Wrapper display helper works on SecureStore values

### KeychainTokenStorage Pattern Tests (4)
6. **Store JSON-serialized credentials and retrieve + parse** — JSON round-trip for OAuthCredentials
7. **Account name with special chars** — Sanitized server names with dots/dashes/underscores
8. **findCredentials lists all stored entries via list()** — list() enumerates all keys
9. **Delete credentials by account name** — delete() by account key

### ExtensionSettingsStorage Pattern Tests (2)
10. **Store and retrieve with extension-specific service name** — Long service names like "LLxprt Code Extension {name}"
11. **fallbackPolicy 'deny' throws UNAVAILABLE when keyring absent** — Policy enforcement

### Cross-Wrapper Isolation (2)
12. **Different service names don't interfere** — Three stores with different services are isolated
13. **Same key name in different services are independent** — Delete in one doesn't affect another

### Legacy Format Detection (4)
14. **File that doesn't parse as JSON → CORRUPT error** — Old iv:authTag:hex format detected
15. **File with wrong envelope version → CORRUPT error with upgrade** — Future version envelope
16. **Plain text file → CORRUPT error** — Old plaintext .key format
17. **Valid envelope but tampered data → CORRUPT error** — AES-GCM auth tag verification

## Test Results

```
 [OK] src/storage/secure-store-integration.test.ts (17 tests) 133ms
 Tests  17 passed (17)
```

## Verification

- All 17 integration tests pass
- Existing secure-store.test.ts: 46 tests pass (unchanged)
- Existing tool-key-storage.test.ts: 41 tests pass (unchanged)
- Core package typechecks: `tsc --noEmit` (exit 0)
- No existing source files modified

## Completed

- Date: 2026-02-11
- Phase: P07
