# Phase 09: Eliminate FileTokenStorage + HybridTokenStorage — COMPLETED

**Date:** 2026-02-11
**Plan:** PLAN-20260211-SECURESTORE.P09

## Caller Inventory (Pre-Elimination)

### FileTokenStorage consumers (non-test):
| File | Lines | Usage |
|------|-------|-------|
| `packages/core/src/mcp/token-storage/file-token-storage.ts` | 14 | Class definition (deleted) |
| `packages/core/src/mcp/token-storage/hybrid-token-storage.ts` | 8, 44 | Import + instantiation (deleted) |

### HybridTokenStorage consumers (non-test):
| File | Lines | Usage | Migration |
|------|-------|-------|-----------|
| `packages/core/src/mcp/token-storage/hybrid-token-storage.ts` | 14 | Class definition | Deleted |
| `packages/core/src/mcp/oauth-token-storage.ts` | 7, 23, 27 | Import + default tokenStore | → KeychainTokenStorage |
| `packages/core/src/code_assist/oauth-credential-storage.ts` | 8, 30 | Import + constructor default | → KeychainTokenStorage |

### Barrel exports (index.ts):
- Neither FileTokenStorage nor HybridTokenStorage were exported from `packages/core/src/index.ts` — no changes needed.

### @napi-rs/keyring direct imports (R7.7 violations):
| File | Line | Usage | Migration |
|------|------|-------|-----------|
| `packages/cli/src/config/extensions/settingsStorage.ts` | 47 | Direct `import('@napi-rs/keyring')` | → SecureStore from @vybestack/llxprt-code-core |

## Actions Taken

### Step 1: Migrated consumers
- `oauth-token-storage.ts`: Replaced `HybridTokenStorage` import/usage with `KeychainTokenStorage`
- `oauth-credential-storage.ts`: Replaced `HybridTokenStorage` import/usage with `KeychainTokenStorage` (typed as `TokenStorage`)
- `oauth-credential-storage.test.ts`: Updated mock from `hybrid-token-storage.js` to `keychain-token-storage.js`, updated all test descriptions

### Step 2: Deleted legacy files
- `packages/core/src/mcp/token-storage/file-token-storage.ts` — DELETED
- `packages/core/src/mcp/token-storage/file-token-storage.test.ts` — DELETED
- `packages/core/src/mcp/token-storage/hybrid-token-storage.ts` — DELETED
- `packages/core/src/mcp/token-storage/hybrid-token-storage.test.ts` — DELETED

### Step 3: Refactored ExtensionSettingsStorage (R7.7)
- `packages/cli/src/config/extensions/settingsStorage.ts`:
  - Removed entire `getKeytar()` function and `Keytar` interface
  - Removed direct `@napi-rs/keyring` import
  - Added `SecureStore` import from `@vybestack/llxprt-code-core`
  - Class now uses `SecureStore` instance (set/get/delete/list) instead of raw keytar
- `packages/cli/src/config/extensions/settingsStorage.test.ts`:
  - Updated mock from `@napi-rs/keyring` to `@vybestack/llxprt-code-core` with in-memory SecureStore
  - Tests now use `mockStore` Map for setup/assertion
- `packages/cli/src/config/extensions/settingsIntegration.test.ts`:
  - Updated mock from `@napi-rs/keyring` to `@vybestack/llxprt-code-core` with in-memory SecureStore
  - Three tests updated to use `mockSecureStore.set()` instead of AsyncEntry mock manipulation

### Step 4: Cleaned stale dist artifacts
- Removed stale `.js` and `.d.ts` files from `packages/core/dist/` for deleted modules
- Rebuilt core package

## Verification Results

- **typecheck**: All workspaces pass (core, cli, a2a-server, test-utils)
- **core tests**: 404 files passed, 6 skipped (6532 tests passed, 95 skipped)
- **cli settingsStorage.test.ts**: 21/21 passed
- **cli settingsIntegration.test.ts**: 14/14 passed
- **No remaining FileTokenStorage/HybridTokenStorage references**: Confirmed via grep
- **R7.7 compliance**: Only `secure-store.ts` imports `@napi-rs/keyring` directly; all other references are string literals in error messages/comments or test file assertions
