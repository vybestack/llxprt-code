# P11 — Settings & Configuration TDD

**Status:** [OK] Complete (RED phase — tests fail as expected)
**Date:** 2026-02-11

## Summary

Added failing TDD tests for compression settings registry entries (`compression.strategy`,
`compression.profile`) and runtime context ephemeral accessors (`compressionStrategy()`,
`compressionProfile()`). All 12 new tests fail because the implementation does not exist yet
(Phase 12).

## Files Modified

- `packages/core/src/settings/__tests__/settingsRegistry.test.ts` — added `describe('compression settings')` block with 8 tests
- `packages/core/src/runtime/createAgentRuntimeContext.test.ts` — added `describe('ephemerals.compressionStrategy()')` and `describe('ephemerals.compressionProfile()')` blocks with 4 tests

## Test Details

### A. Settings Registry Tests (8 failing)

| Test | Asserts |
|---|---|
| `compression.strategy` returns spec with type enum | `spec?.type` → `'enum'` |
| `compression.strategy` returns spec with default middle-out | `spec?.default` → `'middle-out'` |
| `compression.strategy` returns spec with enumValues matching COMPRESSION_STRATEGIES | `spec?.enumValues` → `['middle-out', 'top-down-truncation']` |
| `compression.strategy` returns spec with persistToProfile true | `spec?.persistToProfile` → `true` |
| `compression.profile` returns spec with type string | `spec?.type` → `'string'` |
| `compression.profile` returns spec with persistToProfile true | `spec?.persistToProfile` → `true` |
| includes compression.strategy in direct setting specs | `getDirectSettingSpecs()` contains entry |
| includes compression.profile in direct setting specs | `getDirectSettingSpecs()` contains entry |

### B. Runtime Context Tests (4 failing)

| Test | Asserts |
|---|---|
| compressionStrategy() returns ephemeral when set | `'top-down-truncation'` from settings |
| compressionStrategy() falls back to persistent default | `'middle-out'` when settings empty |
| compressionProfile() returns ephemeral when set | `'my-profile'` from settings |
| compressionProfile() returns undefined when neither set | `undefined` when settings empty |

## Requirements Covered

| Requirement | Description |
|---|---|
| REQ-CS-008.1 | compression.strategy setting spec in registry |
| REQ-CS-008.2 | compression.profile setting spec in registry |
| REQ-CS-008.3 | Default strategy is 'middle-out' |
| REQ-CS-010.1 | Ephemeral accessors on AgentRuntimeContext |

## Verification

```
$ npx vitest run packages/core/src/ -t "compression"
 Tests  12 failed | 42 passed | 5952 skipped (6006)

Settings registry: 8 failed | 56 passed (64)
Runtime context:   4 failed | 19 passed (23)
```

All existing tests continue to pass. New tests fail because implementation doesn't exist yet.
