# P07 — TopDownTruncationStrategy Tests

**Status:** [OK] Complete
**Date:** 2026-02-11

## Summary

Created `packages/core/src/core/compression/TopDownTruncationStrategy.test.ts` with
15 behavioral tests covering:

- **REQ-CS-003.1** — Interface contract: name is `"top-down-truncation"`, `requiresLLM` is `false`
- **REQ-CS-003.2** — Removes oldest messages until token count < target (`compressionThreshold × contextLimit × 0.6`)
- **REQ-CS-003.3** — Never calls LLM (throwing provider proves this)
- **REQ-CS-003.4** — Returns ONLY surviving messages (no summary, no ack)
- **REQ-CS-003.5** — Keeps at least `min(2, history.length)` messages

## Test categories

| Category | Count | Description |
|---|---|---|
| Interface contract | 2 | name + requiresLLM |
| Removes oldest until under target | 3 | truncation, already-under, specific count |
| Never calls LLM | 1 | throwing provider, metadata check |
| Returns only surviving messages | 2 | no summary/ack, contiguous from end |
| Minimum preservation | 3 | ≥2 messages, 1-message history, 2-message history |
| Tool-call boundary adjustment | 2 | orphaned responses, consecutive responses |
| Metadata completeness | 2 | all fields, no-truncation counts |
| Edge cases | 1 | empty history |

## Verification

Tests fail with `Cannot find module './TopDownTruncationStrategy.js'` — expected since
the implementation (P08) has not been written yet. No `toHaveBeenCalled` patterns used.
Fake `estimateTokens` returns predictable per-message token values.
