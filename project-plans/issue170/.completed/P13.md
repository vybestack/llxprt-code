# P13 — Dispatcher Integration TDD (RED phase)

**Status:** [OK] Complete (tests written, expected failures confirmed)
**Date:** 2026-02-11

## Summary

Created TDD tests for how `performCompression()` in `GeminiChat` should delegate to
compression strategies via the factory. Tests follow the exact same patterns as
`sandwich-compression.test.ts` (HistoryService, runtimeContext creation, mockContentGenerator,
GeminiChat instantiation, `vi.spyOn(chat as never, ...)` for private methods).

All tests verify **outputs** (history state after compression) rather than using
`toHaveBeenCalled` spy assertions.

## Files Created

| File | Description |
|---|---|
| `packages/core/src/core/__tests__/compression-dispatcher.test.ts` | 8 tests covering strategy delegation, result application, error propagation, atomicity, and context boundary |

## Test Results (RED phase — expected)

```
  compression-dispatcher.test.ts (8 tests | 1 failed)
   × should use top-down-truncation when compressionStrategy is "top-down-truncation"
   [OK] should use middle-out (default) when compressionStrategy is "middle-out"
   [OK] should default to middle-out when no strategy is explicitly set
   [OK] should rebuild history with messages in correct order after compression
   [OK] should propagate strategy errors and still call endCompression
   [OK] should unlock historyService after error (endCompression called in finally)
   [OK] should unlock historyService after successful compression
   [OK] CompressionContext type should not include historyService

 Test Files  1 failed (1)
      Tests  1 failed | 7 passed (8)
```

### Why the failure is expected

The top-down-truncation test fails because `performCompression()` currently has **inline**
middle-out logic — it always calls `directCompressionCall()` (LLM summary) and
`applyCompression()` (inserts summary + ack message). It ignores the `compressionStrategy`
ephemeral setting entirely. The test asserts:

1. No `state_snapshot` text in resulting history (top-down just truncates)
2. History is shorter than original (messages removed from top)
3. No synthetic "Got it. Thanks for the additional context!" ack message

Once P14 refactors `performCompression()` to read `compressionStrategy`, instantiate the
strategy via the factory, and apply the `CompressionResult.newHistory`, this test will pass.

## Requirements Covered

| Requirement | Description | Test |
|---|---|---|
| REQ-CS-006.1 | Strategy delegation based on setting | `should use top-down-truncation...`, `should use middle-out...`, `should default to middle-out...` |
| REQ-CS-006.2 | Result application (history rebuilt correctly) | `should rebuild history with messages in correct order...` |
| REQ-CS-006.3 | Error propagation from strategy | `should propagate strategy errors and still call endCompression` |
| REQ-CS-006.4 | Atomicity (endCompression always called) | `should unlock historyService after error...`, `should unlock historyService after successful...` |
| REQ-CS-001.6 | Context boundary (no historyService in CompressionContext) | `CompressionContext type should not include historyService` |

## Design Decisions

- **Output-based assertions only:** No `toHaveBeenCalled` — all tests verify the resulting history state after `performCompression()` completes.
- **Same mock patterns as sandwich-compression.test.ts:** Uses `vi.spyOn(chat as never, 'resolveProviderForRuntime')` and `vi.spyOn(chat as never, 'providerSupportsIContent')` for private method access.
- **Helper functions:** `buildRuntimeContext`, `buildMockProvider`, `populateHistory` extract shared setup to reduce duplication while following the same factory patterns.
- **7 passing tests already:** Middle-out delegation, result ordering, error handling, and atomicity tests pass because the current inline logic happens to match middle-out behavior. Only the top-down-truncation test fails, confirming the inline code doesn't dispatch by strategy.
