# Phase 01: Preflight Verification — PLAN-20260211-COMPRESSION.P01

**Status:** [OK] COMPLETE  
**Date:** 2026-02-11  
**Phase:** Preflight / Read-only investigation

---

## 1. Dependency Verification

### vitest
[OK] **CONFIRMED** — vitest@3.2.4 is installed and available across all packages:
- Root workspace, `@vybestack/llxprt-code-core`, `@vybestack/llxprt-code` (CLI), a2a-server, vscode-ide-companion
- Also present: `@fast-check/vitest@0.2.4`, `@vitest/coverage-v8@3.2.4`, `@vitest/eslint-plugin@1.3.4`

### typecheck
[OK] **CONFIRMED** — `npm run typecheck` passes cleanly (exit code 0, no errors).

---

## 2. Type/Interface Verification

### IContent (`packages/core/src/services/history/IContent.ts`)
[OK] **CONFIRMED** — Has expected shape:
```typescript
export interface IContent {
  speaker: 'human' | 'ai' | 'tool';
  blocks: ContentBlock[];
  metadata?: ContentMetadata;
}
```
- `speaker` field: [OK] (lines 28)
- `blocks` field: [OK] (line 34)
- Also has `ContentMetadata` with `isSummary`, `synthetic`, `reason` fields which are relevant for compression.

### HistoryService (`packages/core/src/services/history/HistoryService.ts`)
[OK] **CONFIRMED** — All expected methods exist:
- `getCurated()` → line 594, returns `IContent[]`
- `clear()` → line 549
- `add(content: IContent, modelName?: string)` → line 241
- `startCompression()` → line 1483
- `endCompression()` → line 1492
- `estimateTokensForContents(contents: IContent[], modelName?: string)` → line 444
- Additional useful: `getTotalTokens()` (line 148), `addAll()` (line 435), `waitForTokenUpdates()` (line 516)

### AgentRuntimeContext (`packages/core/src/runtime/AgentRuntimeContext.ts`)
[OK] **CONFIRMED** — Has `ephemerals` sub-object (line 183):
```typescript
readonly ephemerals: {
  compressionThreshold(): number;
  contextLimit(): number;
  preserveThreshold(): number;
  topPreserveThreshold(): number;
  toolFormatOverride(): string | undefined;
  reasoning: { ... };
};
```
- Key finding: `ephemerals.compressionThreshold()`, `ephemerals.contextLimit()`, `ephemerals.preserveThreshold()`, `ephemerals.topPreserveThreshold()` are all function accessors (not plain properties).

### AgentRuntimeState (`packages/core/src/runtime/AgentRuntimeState.ts`)
[OK] **CONFIRMED** — Has expected fields:
```typescript
export interface AgentRuntimeState {
  readonly runtimeId: string;
  readonly provider: string;  // [OK] line 29
  readonly model: string;      // [OK] line 30
  readonly baseUrl?: string;
  readonly proxyUrl?: string;
  readonly modelParams?: ModelParams;
  readonly sessionId: string;
  readonly updatedAt: number;
}
```
- Helper functions: `getProvider(state)` (line 504), `getModel(state)` (line 508)

### EphemeralSettings (`packages/core/src/types/modelParams.ts`)
[OK] **CONFIRMED** — Has `'compression-threshold'`:
```typescript
export interface EphemeralSettings {
  'context-limit'?: number;      // line 61
  'compression-threshold'?: number; // line 63
  'auth-key'?: string;
  // ... many more settings
}
```

### ChatCompressionSettings (`packages/core/src/config/config.ts`)
[OK] **CONFIRMED** — Has `contextPercentageThreshold`:
```typescript
export interface ChatCompressionSettings {
  contextPercentageThreshold?: number; // lines 144-146
}
```
- Used via `Config.getChatCompression()` (line 1730)

### SettingsRegistry (`packages/core/src/settings/settingsRegistry.ts`)
[OK] **CONFIRMED** — All expected exports exist:
- `SETTINGS_REGISTRY: readonly SettingSpec[]` — line 57
- `SettingSpec` interface — line 16, has fields: `key`, `aliases?`, `category`, `providers?`, `description`, `hint?`, `type`, `enumValues?`, `validate?`, `parse?`, `normalize?`, `default?`, `persistToProfile`, `completionOptions?`
- `getDirectSettingSpecs()` — line 1313
- `DirectSettingSpec` interface — line 1278, has fields: `value`, `hint`, `description?`, `options?`
- `'compression-threshold'` setting already registered at line 337 with:
  - category: `'cli-behavior'`
  - type: `'number'`
  - persistToProfile: `true`
  - validate: checks 0 ≤ value ≤ 1
  - **No `default` value** — will need one for the new `compression.strategy` setting
  - **No `enumValues`** — the new strategy setting will need them

### PromptResolver (`packages/core/src/prompt-config/prompt-resolver.ts`)
[OK] **CONFIRMED** — Supports subdirectory paths. See detailed analysis in Section 6 below.

---

## 3. Call Path Verification

### geminiChat.ts compression call chain:
| Function | Line(s) | Status |
|---|---|---|
| `performCompression(prompt_id)` | 2001 | [OK] Found — entry point |
| `getCompressionSplit()` | 2044 (def), 2010 (call) | [OK] Found — splits into top/middle/bottom |
| `directCompressionCall(toCompress, prompt_id)` | 2206 (def), 2018 (call) | [OK] Found — makes LLM call |
| `applyCompression(summary, toKeepTop, toKeepBottom)` | 2291 (def), 2021 (call) | [OK] Found — applies result |
| `adjustForToolCallBoundary(curated, index)` | 2102 (def), 2072-2073 (calls) | [OK] Found — adjusts split for tool boundaries |
| `getCompressionPrompt()` | imported from `./prompts.js` (line 51), used at line 2226 | [OK] Found — hardcoded prompt string |
| `resolveProviderForRuntime(contextLabel)` | 2978 (def), 2210 (call) | [OK] Found — gets provider for compression |

### core-defaults.ts compression references:
- `'compression.md'` is in the expected files list (line 105) and loaded into `CORE_DEFAULTS` (line 305)

---

## 4. Test Infrastructure Verification

| File | Status |
|---|---|
| `packages/core/src/core/client.test.ts` | [OK] Exists (86KB, Feb 5) |
| `packages/core/src/settings/__tests__/settingsRegistry.test.ts` | [OK] Exists (10.6KB, Feb 3) — **Note: in `__tests__/` subdirectory**, not directly in `settings/` |
| `packages/core/src/prompt-config/prompt-service.test.ts` | [OK] Exists (37.6KB, Feb 3) |
| `packages/core/src/core/compression/` | [ERROR] Does not exist yet — will be created in later phases |

---

## 5. Key Discovery: compression.md vs getCompressionPrompt()

### compression.md (in prompt-config/defaults/)
This is the **PromptService-managed** version. It is:
- Loaded via `CORE_DEFAULTS` → `ALL_DEFAULTS` → `PromptService.defaultContent`
- Installed to `~/.llxprt/prompts/compression.md` during prompt initialization
- Content: A "full history" compression prompt — instructs the model to compress the **entire** history into `<state_snapshot>` XML with sections: `overall_goal`, `key_knowledge`, `file_system_state`, `recent_actions`, `current_plan`

### getCompressionPrompt() (in core/prompts.ts, line 379)
This is a **hardcoded function** returning a different prompt. It is:
- Called directly by `geminiChat.ts` at line 2226 in `directCompressionCall()`
- Content: A "middle-out sandwich" compression prompt — instructs the model to compress the **MIDDLE portion** of history by ~50%, producing `<state_snapshot>` XML with sections: `overall_goal`, `key_knowledge`, `current_progress`, `active_tasks`, `open_questions`

### Key Differences:
| Aspect | compression.md | getCompressionPrompt() |
|---|---|---|
| Source | PromptService / file system | Hardcoded function |
| Scope | Compress ENTIRE history | Compress MIDDLE portion (~50%) |
| XML sections | `overall_goal`, `key_knowledge`, `file_system_state`, `recent_actions`, `current_plan` | `overall_goal`, `key_knowledge`, `current_progress`, `active_tasks`, `open_questions` |
| Actually used at runtime? | [ERROR] **Not used** by compression — it is loaded but never referenced by geminiChat | [OK] **Used** at runtime (line 2226) |

### Conclusion:
**`getCompressionPrompt()` is the active runtime prompt.** The `compression.md` file in PromptService is loaded and installed but **not actually consumed** by the compression pipeline. The `geminiChat.ts` directly imports and calls `getCompressionPrompt()` without going through PromptService/PromptResolver.

---

## 6. Key Discovery: PromptResolver Subdirectory Support

[OK] **PromptResolver fully supports subdirectory paths.** 

The `resolveFile()` method (line 57) takes a `relativePath` parameter and:
1. Validates it (rejects `..` paths)
2. Builds search paths with provider/model overrides: `providers/{provider}/models/{model}/{relativePath}`, `providers/{provider}/{relativePath}`, `{relativePath}`
3. Joins paths with `path.join(baseDir, searchPath)`

Evidence of existing subdirectory usage:
- `'env/git.md'` (line 144), `'env/git-repository.md'` (line 146)
- `'env/sandbox.md'` (line 178), `'env/ide-mode.md'` (line 208)
- All `env/*` paths use slash-separated subdirectory patterns

**A path like `compression/middle-out.md` would work natively** through the same mechanism. The `CORE_DEFAULTS` already uses subdirectory paths like `'env/git-repository.md'` (line 309).

---

## 7. Key Discovery: geminiChat PromptService/PromptResolver Access

[ERROR] **geminiChat has NO access to PromptService or PromptResolver.**

Grep for `promptService`, `PromptService`, `promptResolver`, `PromptResolver`, `promptConfig`, `PromptConfig` in geminiChat.ts returned **zero results**.

The compression prompt is obtained via a simple function import:
```typescript
import { getCompressionPrompt } from './prompts.js';
```

This means:
- The compression prompt is **not resolved through the PromptService file resolution system**
- It does not benefit from provider/model-specific prompt overrides
- To use PromptResolver, we would need to either:
  1. Thread PromptService/PromptResolver through to geminiChat, OR
  2. Keep the prompt accessible via a simple function call (current pattern), OR
  3. Have the compression strategy resolve its own prompt from the defaults

---

## 8. DECISION: Prompt File Path

### Decision: Keep `compression.md` as the file name (do NOT use `compression/middle-out.md` subdirectory)

### Reasoning:

1. **Current architecture**: The active runtime prompt comes from `getCompressionPrompt()` in `prompts.ts`, NOT from PromptService. geminiChat has no PromptService access.

2. **The `compression.md` file already exists** in the defaults and is installed to user's prompt directory. Changing it to a subdirectory would be a breaking change for any users who have customized it.

3. **The plan for middle-out strategy**: The middle-out strategy should get its prompt text from the hardcoded `getCompressionPrompt()` function (or a refactored version thereof). This is the prompt that's **actually used at runtime**.

4. **The plan for top-down-truncation strategy**: This strategy doesn't need an LLM prompt at all — it simply truncates history.

5. **Future extensibility**: If we later need per-strategy prompt files, we can add that in a follow-up. For now, the strategy class can embed or import its prompt text directly.

6. **Minimal disruption**: Keeping `compression.md` as-is in the PromptService defaults avoids unnecessary changes to the prompt installation pipeline. The `compression.md` content can be updated to match the active `getCompressionPrompt()` content in a future cleanup if desired.

### Summary:
- **Middle-out prompt**: Will be sourced from the existing `getCompressionPrompt()` function (moved/refactored into the strategy class)
- **compression.md**: Remains unchanged in PromptService defaults for now
- **No subdirectory paths needed** for this feature

---

## 9. Blocking Issues / Plan Updates Required

### No Blocking Issues Found [OK]

All assumptions verified successfully. The following **observations** should inform implementation:

### Observation 1: Settings Registry Test Location
The settings registry test is at `packages/core/src/settings/__tests__/settingsRegistry.test.ts` (in `__tests__/` subdirectory), not `packages/core/src/settings/settingsRegistry.test.ts` as originally referenced in the plan. Plan phases 11/12 should target the correct path.

### Observation 2: Prompt Duality
`compression.md` (PromptService) and `getCompressionPrompt()` (runtime) contain **different** prompt text. The runtime prompt (`getCompressionPrompt()`) is the authoritative one. The compression strategy should use the runtime prompt text.

### Observation 3: No PromptResolver Threading Needed
Since geminiChat doesn't use PromptResolver and we're keeping the function-based prompt approach, no PromptResolver threading is needed. The compression strategy classes will import/embed their prompt text directly.

### Observation 4: ephemerals are Function Accessors
`AgentRuntimeContext.ephemerals` fields are **functions** (e.g., `compressionThreshold()`, `contextLimit()`), not plain properties. Strategy implementations must call them as functions.

### Observation 5: Existing compression-threshold Setting
`'compression-threshold'` already exists in `SETTINGS_REGISTRY` (line 337) as a `'number'` type in `'cli-behavior'` category with `persistToProfile: true`. The new `'compression.strategy'` setting should follow this same pattern.

---

## Verification Checklist

| # | Verification Item | Status |
|---|---|---|
| 1 | vitest available | [OK] |
| 2 | typecheck passes | [OK] |
| 3 | IContent has speaker + blocks | [OK] |
| 4 | HistoryService has getCurated, clear, add, startCompression, endCompression, estimateTokensForContents | [OK] |
| 5 | AgentRuntimeContext has ephemerals sub-object | [OK] |
| 6 | AgentRuntimeState has model, provider | [OK] |
| 7 | EphemeralSettings has 'compression-threshold' | [OK] |
| 8 | ChatCompressionSettings has contextPercentageThreshold | [OK] |
| 9 | SETTINGS_REGISTRY, SettingSpec, getDirectSettingSpecs() exist | [OK] |
| 10 | PromptResolver supports subdirectory paths | [OK] |
| 11 | performCompression call chain verified in geminiChat.ts | [OK] |
| 12 | getCompressionSplit verified | [OK] |
| 13 | directCompressionCall verified | [OK] |
| 14 | applyCompression verified | [OK] |
| 15 | adjustForToolCallBoundary verified | [OK] |
| 16 | getCompressionPrompt verified | [OK] |
| 17 | resolveProviderForRuntime verified | [OK] |
| 18 | compression.md in core-defaults verified | [OK] |
| 19 | Test files exist (client.test.ts, settingsRegistry.test.ts, prompt-service.test.ts) | [OK] |
| 20 | compression/ directory does not yet exist | [OK] |
| 21 | compression.md vs getCompressionPrompt() relationship understood | [OK] |
| 22 | Prompt path decision made | [OK] |

**All 22 verification items passed. Phase 01 is complete. Ready for Phase 02.**
