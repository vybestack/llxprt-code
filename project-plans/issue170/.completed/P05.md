# Phase 05: Middle-Out Strategy TDD — COMPLETE

**Plan:** PLAN-20260211-COMPRESSION.P05
**Completed:** 2026-02-11

## What was done

Created `packages/core/src/core/compression/MiddleOutStrategy.test.ts` — 18 behavioral
tests for the MiddleOutStrategy class (which doesn't exist yet — Phase 06).

Tests cover:

1. **Interface contract** — `name === 'middle-out'`, `requiresLLM === true`
2. **Sandwich split** — 20 messages with default thresholds produce correct top/middle/bottom counts; custom thresholds respected
3. **Tool-call boundary respect** — split doesn't orphan tool responses (verified by checking top/bottom structure)
4. **LLM call** — middle section sent to provider, returned summary appears as human message in result
5. **Profile resolution** — when compressionProfile is set, profile-specific provider's output appears
6. **Default model** — without profile, resolveProvider called with `undefined`
7. **Result assembly shape** — `[...top, humanSummary, aiAck, ...bottom]` structure verified, AI ack text matches
8. **Metadata completeness** — all fields populated, consistency checks (topPreserved + middleCompressed + bottomPreserved === originalMessageCount)
9. **Minimum compressible** — < 4 middle messages returns original, llmCallMade=false
10. **Empty middle after boundary adjustment** — tool-call-heavy middle causes overlap, returns original
11. **Edge cases** — empty history, minimum boundary, multi-chunk provider aggregation

## Key decisions

- NO mock theater: zero `toHaveBeenCalled` / `toHaveBeenCalledWith` assertions
- Real `CompressionContext` objects built with real interfaces
- Fake providers are async generators yielding IContent with known text
- Tests verify outputs (result structure, metadata values, summary text) not spy calls
- One behavioral trick for profile verification: closure variable captures the profileName
  argument passed to resolveProvider, then we assert both the output text AND the argument

## Verification

- Tests fail with `Cannot find module './MiddleOutStrategy.js'` (expected — Phase 06 creates it)
- No syntax errors
- 0 occurrences of `toHaveBeenCalled`
- 18 test cases (requirement was 10+)
