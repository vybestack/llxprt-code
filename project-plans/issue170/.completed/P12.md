# P12 — Settings Implementation (GREEN phase)

**Status:** [OK] Complete
**Date:** 2026-02-11

## Summary

Made all 12 Phase 11 TDD tests pass by adding compression settings to the settings registry,
type interfaces, and runtime context ephemeral accessors. No hardcoded `'middle-out'` fallback
anywhere except SETTINGS_REGISTRY default.

## Files Modified

| File | Change |
|---|---|
| `packages/core/src/settings/settingsRegistry.ts` | Added `compression.strategy` (enum, default `'middle-out'`, enumValues from `COMPRESSION_STRATEGIES`) and `compression.profile` (string) specs to `SETTINGS_REGISTRY`; added import of `COMPRESSION_STRATEGIES` |
| `packages/core/src/types/modelParams.ts` | Added `'compression.strategy'?` and `'compression.profile'?` fields to `EphemeralSettings` |
| `packages/core/src/config/config.ts` | Added `strategy?` and `profile?` fields to `ChatCompressionSettings` |
| `packages/core/src/runtime/AgentRuntimeContext.ts` | Added `compressionStrategy()` and `compressionProfile()` to `ephemerals` interface; added `compressionStrategy?` and `compressionProfile?` to `ReadonlySettingsSnapshot` |
| `packages/core/src/runtime/createAgentRuntimeContext.ts` | Implemented `compressionStrategy()` (ephemeral → registry default) and `compressionProfile()` (ephemeral → undefined) accessors; added import of `getSettingSpec` |

## Design Decisions

- **No hardcoded fallback:** `compressionStrategy()` reads default from `getSettingSpec('compression.strategy')?.default` rather than a hardcoded `'middle-out'` string, keeping the single source of truth in `SETTINGS_REGISTRY`.
- **Category `cli-behavior`:** Both settings use `cli-behavior` category so they appear in `getDirectSettingSpecs()` (which filters out `model-param`, `custom-header`, `provider-config`).
- **`@plan PLAN-20260211-COMPRESSION.P12` markers** added to all new code.

## Verification

```
$ npx vitest run packages/core/src/settings/__tests__/settingsRegistry.test.ts packages/core/src/runtime/createAgentRuntimeContext.test.ts
 [OK] packages/core/src/settings/__tests__/settingsRegistry.test.ts (64 tests) 4ms
 [OK] packages/core/src/runtime/createAgentRuntimeContext.test.ts (23 tests) 5ms
 Test Files  2 passed (2)
      Tests  87 passed (87)

$ cd packages/core && npx tsc --noEmit   # Clean — no errors
```

## Requirements Satisfied

| Requirement | Description |
|---|---|
| REQ-CS-008.1 | `compression.strategy` setting spec in registry |
| REQ-CS-008.2 | `compression.profile` setting spec in registry |
| REQ-CS-008.3 | Default strategy is `'middle-out'` (via registry default) |
| REQ-CS-010.1 | Ephemeral accessors on `AgentRuntimeContext` |
