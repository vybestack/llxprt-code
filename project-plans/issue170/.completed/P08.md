# P08 — TopDownTruncationStrategy Implementation

**Status:** [OK] Complete
**Date:** 2026-02-11

## Summary

Created `packages/core/src/core/compression/TopDownTruncationStrategy.ts` implementing
the `CompressionStrategy` interface for simple oldest-first message removal.

## Implementation details

- **Name:** `'top-down-truncation'`
- **requiresLLM:** `false`
- **Target calculation:** `compressionThreshold() × contextLimit() × 0.6`
- **Early return:** If `currentTokenCount` ≤ target, returns history unchanged
- **Truncation loop:** Removes messages from front (oldest) one at a time, re-estimating
  tokens on the remaining slice until under target
- **Tool-call boundary:** Uses `adjustForToolCallBoundary()` from `./utils.js` to avoid
  orphaning tool responses after the cut point
- **Minimum preservation:** Keeps at least `min(2, history.length)` messages
- **No LLM calls:** Never invokes the provider; metadata always reports `llmCallMade: false`
- **Returns only surviving messages:** No synthetic summary or acknowledgment injected

## Requirements covered

| Requirement | Description |
|---|---|
| REQ-CS-003.1 | Interface contract (name, requiresLLM) |
| REQ-CS-003.2 | Removes oldest messages until under target |
| REQ-CS-003.3 | Never calls LLM |
| REQ-CS-003.4 | Returns only surviving messages |
| REQ-CS-003.5 | Keeps at least min(2, history.length) messages |

## Barrel export

Updated `packages/core/src/core/compression/index.ts` to export
`TopDownTruncationStrategy`.

## Verification

- All 16 tests pass (`npx vitest run ...TopDownTruncationStrategy.test.ts`)
- Typecheck passes (`npm run typecheck`)
