# Reimplementation Plan: Gemini 3 Launch — Selective Extraction (REVISED)

**Upstream SHA**: `86828bb56`
**Upstream subject**: feat: launch Gemini 3 in Gemini CLI (#13287)
**Scope**: Extract 7 useful sub-changes from the 79-file commit
**Methodology**: TDD — RED → GREEN → REFACTOR per extraction

---

## Deepthinker Review Resolutions

| # | Issue | Resolution |
|---|-------|------------|
| 1 | `getErrorStatus` already in `retry.ts` → httpErrors.ts duplicates | **Add `ModelNotFoundError` to `retry.ts` directly**. `getErrorStatus` has 31 import sites; moving it would be a massive refactor with no upstream benefit. Keep `retry.ts` as canonical home. No httpErrors.ts file created. |
| 2 | editor.ts must update ALL touchpoints | Plan now enumerates all 6 touchpoints: `EditorType`, `isValidEditorType`, `editorCommands`, `allowEditorTypeInSandbox`, `getDiffCommand`, `openDiff`. |
| 3 | detect-ide.ts vscode TERM_PROGRAM gate | `detectIde()` returns `undefined` when `TERM_PROGRAM !== 'vscode'`. Antigravity needs its own `TERM_PROGRAM` check OR the env-only `detectIdeFromEnv()` path must be used. Plan adds antigravity to `detectIdeFromEnv()` and notes the gate issue. |
| 4 | PREVIEW_GEMINI_MODEL existence | **Verified: does NOT exist** in codebase. Only appears in plan files. Must be added. |
| 5 | settingsSchema requires schema regen | Schema regen step included after settingsSchema.ts change. |
| 6 | config.ts storage source unclear | **Resolution**: Use constructor param + private field pattern (matches `folderTrust`, `extensionManagement`, `enablePromptCompletion`). Wire through `ConfigParameters`. Read from `SettingsService` via CLI bootstrap like other settings. |
| 7 | googleQuotaErrors depends on #1 | Now imports `ModelNotFoundError` + `getErrorStatus` from `retry.ts` (no httpErrors.ts dependency). |
| barrel | New exports needed | `ModelNotFoundError` already covered by `export * from './utils/retry.js'` in `index.ts`. No barrel update needed. |

---

## EXTRACT 1: `ModelNotFoundError` in `retry.ts` (was httpErrors.ts)

**File**: `packages/core/src/utils/retry.ts`
**Decision**: Add `ModelNotFoundError` class directly to `retry.ts`. This avoids duplicating `getErrorStatus` (which has 31 import sites across the codebase). No `httpErrors.ts` file is created.

### RED — Write failing tests

Create `packages/core/src/utils/__tests__/retry.ModelNotFoundError.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';
import { ModelNotFoundError } from '../retry.js';

describe('ModelNotFoundError', () => {
  it('is an instance of Error', () => {
    const err = new ModelNotFoundError('model not found');
    expect(err).toBeInstanceOf(Error);
  });

  it('has name ModelNotFoundError', () => {
    const err = new ModelNotFoundError('model not found');
    expect(err.name).toBe('ModelNotFoundError');
  });

  it('defaults code to 404', () => {
    const err = new ModelNotFoundError('model not found');
    expect(err.code).toBe(404);
  });

  it('accepts a custom code', () => {
    const err = new ModelNotFoundError('gone', 410);
    expect(err.code).toBe(410);
  });

  it('preserves the message', () => {
    const err = new ModelNotFoundError('gemini-99 not found');
    expect(err.message).toBe('gemini-99 not found');
  });
});
```

### GREEN — Add ModelNotFoundError to retry.ts

Append to `packages/core/src/utils/retry.ts` (after existing exports):

```typescript
/**
 * Error indicating a model was not found (HTTP 404).
 * Used by googleQuotaErrors to classify 404 responses.
 */
export class ModelNotFoundError extends Error {
  code: number;
  constructor(message: string, code?: number) {
    super(message);
    this.name = 'ModelNotFoundError';
    this.code = code ?? 404;
  }
}
```

### REFACTOR

- No refactor needed. `ModelNotFoundError` is already exported via `export * from './utils/retry.js'` in `index.ts`.
- Barrel export: **already covered** — no changes to `packages/core/src/index.ts`.

---

## EXTRACT 2: `editor.ts` — Antigravity editor support

**File**: `packages/core/src/utils/editor.ts`

### RED — Write failing tests

Create `packages/core/src/utils/__tests__/editor.antigravity.test.ts`:

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';

// Must mock child_process before importing editor
vi.mock('child_process', () => ({
  execSync: vi.fn(),
  execFileSync: vi.fn(),
  spawn: vi.fn(() => ({
    on: vi.fn((event: string, cb: (code: number) => void) => {
      if (event === 'close') cb(0);
    }),
  })),
}));

import { getDiffCommand, checkHasEditorType, allowEditorTypeInSandbox } from '../editor.js';
import type { EditorType } from '../editor.js';

describe('editor.ts antigravity support', () => {
  it('antigravity is a valid EditorType', () => {
    // Type assertion: if this compiles, the type includes antigravity
    const editor: EditorType = 'antigravity';
    expect(editor).toBe('antigravity');
  });

  it('getDiffCommand returns --wait --diff for antigravity', () => {
    const cmd = getDiffCommand('/old', '/new', 'antigravity' as EditorType);
    expect(cmd).toEqual({
      command: expect.any(String),
      args: ['--wait', '--diff', '/old', '/new'],
    });
  });

  it('allowEditorTypeInSandbox returns false for antigravity when SANDBOX is set', () => {
    const origSandbox = process.env.SANDBOX;
    process.env.SANDBOX = 'true';
    expect(allowEditorTypeInSandbox('antigravity' as EditorType)).toBe(false);
    if (origSandbox === undefined) delete process.env.SANDBOX;
    else process.env.SANDBOX = origSandbox;
  });

  it('allowEditorTypeInSandbox returns true for antigravity when SANDBOX is not set', () => {
    const origSandbox = process.env.SANDBOX;
    delete process.env.SANDBOX;
    expect(allowEditorTypeInSandbox('antigravity' as EditorType)).toBe(true);
    if (origSandbox !== undefined) process.env.SANDBOX = origSandbox;
  });
});
```

### GREEN — Update all 6 touchpoints in editor.ts

1. **`EditorType` union**: Add `| 'antigravity'`
2. **`isValidEditorType`**: Add `'antigravity'` to the includes array
3. **`editorCommands`**: Add `antigravity: { win32: ['agy.cmd'], default: ['agy'] }`
4. **`allowEditorTypeInSandbox`**: Add `'antigravity'` to the GUI editors array (alongside vscode, cursor, etc.)
5. **`getDiffCommand`**: Add `case 'antigravity':` that falls through to the `--wait --diff` branch (same as vscode/cursor/windsurf/zed)
6. **`openDiff`**: Add `case 'antigravity':` that falls through to the GUI editors spawn branch

### REFACTOR

- No additional refactor. Existing barrel export in `index.ts` (`export * from './utils/editor.js'`) already covers new types.

---

## EXTRACT 3: `detect-ide.ts` — Antigravity IDE detection + `isCloudShell()`

**File**: `packages/core/src/ide/detect-ide.ts`

### Important: TERM_PROGRAM gate

The current `detectIde()` function returns `undefined` when `TERM_PROGRAM !== 'vscode'`. Antigravity would need its own `TERM_PROGRAM` handling. For now, we add antigravity only to `detectIdeFromEnv()` (which is exported and used independently) and to `IDE_DEFINITIONS`. The `detectIde()` gate issue is a **follow-up** — it requires broader refactoring of the IDE detection pipeline.

### RED — Write failing tests

Create `packages/core/src/ide/__tests__/detect-ide.antigravity.test.ts`:

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { detectIdeFromEnv, IDE_DEFINITIONS } from '../detect-ide.js';

describe('detect-ide.ts antigravity + isCloudShell', () => {
  const savedEnv: Record<string, string | undefined> = {};

  beforeEach(() => {
    // Save all relevant env vars
    for (const key of [
      'ANTIGRAVITY_CLI_ALIAS',
      '__COG_BASHRC_SOURCED',
      'REPLIT_USER',
      'CURSOR_TRACE_ID',
      'CODESPACES',
      'EDITOR_IN_CLOUD_SHELL',
      'CLOUD_SHELL',
      'TERM_PRODUCT',
      'FIREBASE_DEPLOY_AGENT',
      'MONOSPACE_ENV',
    ]) {
      savedEnv[key] = process.env[key];
      delete process.env[key];
    }
  });

  afterEach(() => {
    for (const [key, val] of Object.entries(savedEnv)) {
      if (val === undefined) delete process.env[key];
      else process.env[key] = val;
    }
  });

  it('IDE_DEFINITIONS includes antigravity', () => {
    expect(IDE_DEFINITIONS.antigravity).toEqual({
      name: 'antigravity',
      displayName: 'Antigravity',
    });
  });

  it('detectIdeFromEnv returns antigravity when ANTIGRAVITY_CLI_ALIAS is set', () => {
    process.env.ANTIGRAVITY_CLI_ALIAS = '1';
    expect(detectIdeFromEnv()).toEqual(IDE_DEFINITIONS.antigravity);
  });

  it('detectIdeFromEnv returns cloudshell for CLOUD_SHELL env', () => {
    process.env.CLOUD_SHELL = '1';
    expect(detectIdeFromEnv()).toEqual(IDE_DEFINITIONS.cloudshell);
  });

  it('detectIdeFromEnv returns cloudshell for EDITOR_IN_CLOUD_SHELL env', () => {
    process.env.EDITOR_IN_CLOUD_SHELL = '1';
    expect(detectIdeFromEnv()).toEqual(IDE_DEFINITIONS.cloudshell);
  });
});
```

Also test `isCloudShell()`:

```typescript
// In the same file or separate:
import { isCloudShell } from '../detect-ide.js';

describe('isCloudShell()', () => {
  // (save/restore env in beforeEach/afterEach as above)

  it('returns true when CLOUD_SHELL is set', () => {
    process.env.CLOUD_SHELL = 'true';
    expect(isCloudShell()).toBe(true);
  });

  it('returns true when EDITOR_IN_CLOUD_SHELL is set', () => {
    process.env.EDITOR_IN_CLOUD_SHELL = '1';
    expect(isCloudShell()).toBe(true);
  });

  it('returns false when neither cloud shell env is set', () => {
    expect(isCloudShell()).toBe(false);
  });
});
```

### GREEN — Implement changes

1. Add `antigravity` to `IDE_DEFINITIONS`:
   ```typescript
   antigravity: { name: 'antigravity', displayName: 'Antigravity' },
   ```

2. Add `isCloudShell()` exported helper:
   ```typescript
   export function isCloudShell(): boolean {
     return !!(process.env['EDITOR_IN_CLOUD_SHELL'] || process.env['CLOUD_SHELL']);
   }
   ```

3. In `detectIdeFromEnv()`:
   - Add antigravity check (before vscode fallback):
     ```typescript
     if (process.env['ANTIGRAVITY_CLI_ALIAS']) {
       return IDE_DEFINITIONS.antigravity;
     }
     ```
   - Refactor cloud shell check to use `isCloudShell()`:
     ```typescript
     if (isCloudShell()) {
       return IDE_DEFINITIONS.cloudshell;
     }
     ```

### REFACTOR

- `isCloudShell` is already exported via `export { IDE_DEFINITIONS, detectIdeFromEnv, type IdeInfo } from './ide/detect-ide.js'` in `index.ts`.
- **Update barrel export** in `packages/core/src/index.ts`: Add `isCloudShell` to the named export from `detect-ide.js`:
  ```typescript
  export {
    IDE_DEFINITIONS,
    detectIdeFromEnv,
    isCloudShell,
    type IdeInfo,
  } from './ide/detect-ide.js';
  ```

---

## EXTRACT 4: `models.ts` — Model alias constants + helpers

**File**: `packages/core/src/config/models.ts`

### Verification: PREVIEW_GEMINI_MODEL

**CONFIRMED: Does NOT exist.** Searched entire codebase — only found in plan documents. Must be added.

### RED — Write failing tests

Create `packages/core/src/config/__tests__/models.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';
import {
  GEMINI_MODEL_ALIAS_PRO,
  GEMINI_MODEL_ALIAS_FLASH,
  GEMINI_MODEL_ALIAS_FLASH_LITE,
  PREVIEW_GEMINI_MODEL,
  resolveModel,
  isGemini2Model,
} from '../models.js';

describe('model alias constants', () => {
  it('GEMINI_MODEL_ALIAS_PRO is defined', () => {
    expect(GEMINI_MODEL_ALIAS_PRO).toBe('gemini-pro');
  });

  it('GEMINI_MODEL_ALIAS_FLASH is defined', () => {
    expect(GEMINI_MODEL_ALIAS_FLASH).toBe('gemini-flash');
  });

  it('GEMINI_MODEL_ALIAS_FLASH_LITE is defined', () => {
    expect(GEMINI_MODEL_ALIAS_FLASH_LITE).toBe('gemini-flash-lite');
  });

  it('PREVIEW_GEMINI_MODEL is defined', () => {
    expect(PREVIEW_GEMINI_MODEL).toBe('gemini-3-pro-preview');
  });
});

describe('resolveModel()', () => {
  it('resolves gemini-pro alias to DEFAULT_GEMINI_MODEL when preview disabled', () => {
    const result = resolveModel('gemini-pro', false);
    expect(result).toBe('gemini-2.5-pro');
  });

  it('resolves gemini-flash alias to DEFAULT_GEMINI_FLASH_MODEL', () => {
    const result = resolveModel('gemini-flash', false);
    expect(result).toBe('gemini-2.5-flash');
  });

  it('resolves gemini-flash-lite alias to DEFAULT_GEMINI_FLASH_LITE_MODEL', () => {
    const result = resolveModel('gemini-flash-lite', false);
    expect(result).toBe('gemini-2.5-flash-lite');
  });

  it('returns model as-is when not an alias', () => {
    const result = resolveModel('custom-model-v1', false);
    expect(result).toBe('custom-model-v1');
  });

  it('resolves gemini-pro to preview model when preview enabled', () => {
    const result = resolveModel('gemini-pro', true);
    expect(result).toBe('gemini-3-pro-preview');
  });
});

describe('isGemini2Model()', () => {
  it('returns true for gemini-2.5-pro', () => {
    expect(isGemini2Model('gemini-2.5-pro')).toBe(true);
  });

  it('returns true for gemini-2.5-flash', () => {
    expect(isGemini2Model('gemini-2.5-flash')).toBe(true);
  });

  it('returns false for gemini-3-pro-preview', () => {
    expect(isGemini2Model('gemini-3-pro-preview')).toBe(false);
  });

  it('returns false for a non-gemini model', () => {
    expect(isGemini2Model('claude-3-opus')).toBe(false);
  });

  it('returns true for gemini-2.0-flash', () => {
    expect(isGemini2Model('gemini-2.0-flash')).toBe(true);
  });
});
```

### GREEN — Add to models.ts

Only add **constants + pure helper functions**. No integration into router/fallback.

```typescript
// Alias constants (user-facing short names)
export const GEMINI_MODEL_ALIAS_PRO = 'gemini-pro';
export const GEMINI_MODEL_ALIAS_FLASH = 'gemini-flash';
export const GEMINI_MODEL_ALIAS_FLASH_LITE = 'gemini-flash-lite';

// Preview model
export const PREVIEW_GEMINI_MODEL = 'gemini-3-pro-preview';

/**
 * Resolves a model alias to a concrete model name.
 * When previewFeaturesEnabled is true, the pro alias resolves to the preview model.
 */
export function resolveModel(
  alias: string,
  previewFeaturesEnabled: boolean,
): string {
  switch (alias) {
    case GEMINI_MODEL_ALIAS_PRO:
      return previewFeaturesEnabled
        ? PREVIEW_GEMINI_MODEL
        : DEFAULT_GEMINI_MODEL;
    case GEMINI_MODEL_ALIAS_FLASH:
      return DEFAULT_GEMINI_FLASH_MODEL;
    case GEMINI_MODEL_ALIAS_FLASH_LITE:
      return DEFAULT_GEMINI_FLASH_LITE_MODEL;
    default:
      return alias;
  }
}

/**
 * Returns true if the model string indicates a Gemini 2.x model.
 */
export function isGemini2Model(model: string): boolean {
  return model.startsWith('gemini-2');
}
```

### REFACTOR

- Already exported via `export * from './config/models.js'` in `index.ts`. No barrel update needed.

---

## EXTRACT 5: `settingsSchema.ts` — `previewFeatures` setting

**File**: `packages/cli/src/config/settingsSchema.ts`

### RED — Write failing tests

Create `packages/cli/src/config/__tests__/settingsSchema.previewFeatures.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';
import { SETTINGS_SCHEMA } from '../settingsSchema.js';

describe('settingsSchema previewFeatures', () => {
  it('previewFeatures setting exists in the schema', () => {
    expect(SETTINGS_SCHEMA.previewFeatures).toBeDefined();
  });

  it('previewFeatures has type boolean', () => {
    expect(SETTINGS_SCHEMA.previewFeatures.type).toBe('boolean');
  });

  it('previewFeatures defaults to false', () => {
    expect(SETTINGS_SCHEMA.previewFeatures.default).toBe(false);
  });

  it('previewFeatures requires restart', () => {
    expect(SETTINGS_SCHEMA.previewFeatures.requiresRestart).toBe(true);
  });

  it('previewFeatures is shown in dialog', () => {
    expect(SETTINGS_SCHEMA.previewFeatures.showInDialog).toBe(true);
  });

  it('previewFeatures has category General', () => {
    expect(SETTINGS_SCHEMA.previewFeatures.category).toBe('General');
  });
});
```

### GREEN — Add to SETTINGS_SCHEMA

Add `previewFeatures` as a top-level property in `SETTINGS_SCHEMA` (near other General settings like `model`, `enablePromptCompletion`):

```typescript
previewFeatures: {
  type: 'boolean',
  label: 'Preview Features',
  category: 'General',
  requiresRestart: true,
  default: false,
  description: 'Enable preview features such as preview models.',
  showInDialog: true,
},
```

### REFACTOR — Regenerate schema

After settingsSchema.ts changes, regenerate `schemas/settings.schema.json`:

```bash
npm run build --workspace @vybestack/llxprt-code-core
```

Then verify the generated schema includes `previewFeatures`:
```bash
grep -c previewFeatures schemas/settings.schema.json
```

---

## EXTRACT 6: `config.ts` — `previewFeatures` getter/setter

**File**: `packages/core/src/config/config.ts`

### Storage pattern analysis

LLxprt's `Config` class uses the **constructor param + private field** pattern for boolean feature flags. Examples:
- `private readonly folderTrust: boolean` ← set from `params.folderTrust ?? false`
- `private readonly extensionManagement: boolean` ← set from `params.extensionManagement ?? false`
- `private readonly enablePromptCompletion: boolean` ← set from `params.enablePromptCompletion ?? false`

Follow this same pattern. The value flows: CLI bootstrap reads from SettingsService → passes into `ConfigParameters` → constructor stores in private field → getter exposes it.

### RED — Write failing tests

Create `packages/core/src/config/__tests__/config.previewFeatures.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';

// Minimal test that validates the interface and getter exist
// Full Config construction requires extensive mocking; test the interface contract
describe('config.ts previewFeatures', () => {
  it('ConfigParameters type includes previewFeatures', async () => {
    // Dynamic import to verify the type compiles
    const configModule = await import('../config.js');
    // If this compiles, ConfigParameters has previewFeatures
    const params: Partial<configModule.ConfigParameters> = {
      previewFeatures: true,
    };
    expect(params.previewFeatures).toBe(true);
  });

  it('ConfigParameters previewFeatures defaults to undefined', async () => {
    const configModule = await import('../config.js');
    const params: Partial<configModule.ConfigParameters> = {};
    expect(params.previewFeatures).toBeUndefined();
  });
});
```

### GREEN — Implement changes

1. **Add to `ConfigParameters` interface**:
   ```typescript
   previewFeatures?: boolean;
   ```

2. **Add private field to `Config` class** (near other boolean flags):
   ```typescript
   private readonly previewFeatures: boolean;
   ```

3. **Initialize in constructor** (near `this.enablePromptCompletion`):
   ```typescript
   this.previewFeatures = params.previewFeatures ?? false;
   ```

4. **Add getter**:
   ```typescript
   getPreviewFeatures(): boolean {
     return this.previewFeatures;
   }
   ```

**SKIP**: No `setPreviewFeatures()` — this is a restart-required setting (like `folderTrust`, `extensionManagement`), so it should be immutable after construction. Follows the existing pattern.

### REFACTOR

- Already exported via `export * from './config/config.js'` in `index.ts`. No barrel update needed.

---

## EXTRACT 7: `googleQuotaErrors.ts` — 404 → `ModelNotFoundError` classification

**File**: `packages/core/src/utils/googleQuotaErrors.ts`

**Dependency**: Extract 1 must be complete (ModelNotFoundError in retry.ts).

### RED — Write failing tests

Create `packages/core/src/utils/__tests__/googleQuotaErrors.404.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';
import { classifyGoogleError } from '../googleQuotaErrors.js';
import { ModelNotFoundError } from '../retry.js';

describe('classifyGoogleError 404 classification', () => {
  it('classifies a 404 error as ModelNotFoundError', () => {
    const error = { status: 404, message: 'Model not found' };
    const result = classifyGoogleError(error);
    expect(result).toBeInstanceOf(ModelNotFoundError);
  });

  it('preserves the error message in ModelNotFoundError', () => {
    const error = { status: 404, message: 'Model gemini-99 not found' };
    const result = classifyGoogleError(error);
    expect(result).toBeInstanceOf(ModelNotFoundError);
    expect((result as ModelNotFoundError).message).toContain(
      'Model gemini-99 not found',
    );
  });

  it('sets code to 404 on ModelNotFoundError', () => {
    const error = { status: 404, message: 'not found' };
    const result = classifyGoogleError(error);
    expect((result as ModelNotFoundError).code).toBe(404);
  });

  it('does not classify 500 errors as ModelNotFoundError', () => {
    const error = { status: 500, message: 'Internal server error' };
    const result = classifyGoogleError(error);
    expect(result).not.toBeInstanceOf(ModelNotFoundError);
  });

  it('does not classify 429 errors as ModelNotFoundError', () => {
    const error = { status: 429, message: 'Rate limited' };
    const result = classifyGoogleError(error);
    expect(result).not.toBeInstanceOf(ModelNotFoundError);
  });
});
```

### GREEN — Update classifyGoogleError

1. Add import at top of `googleQuotaErrors.ts`:
   ```typescript
   import { getErrorStatus, ModelNotFoundError } from './retry.js';
   ```

2. Add 404 check at the **beginning** of `classifyGoogleError()`, before the `parseGoogleApiError` call:
   ```typescript
   // Check for 404 (model not found) before parsing as Google API error
   const status = getErrorStatus(error);
   if (status === 404) {
     const message = error instanceof Error ? error.message : String(error);
     return new ModelNotFoundError(message, 404);
   }
   ```

### REFACTOR

- Import chain: `googleQuotaErrors.ts` → `retry.ts` (both in `utils/`). Clean, no circular dependency.
- No barrel update needed — `googleQuotaErrors.ts` is not currently exported from `index.ts` (it's imported directly by consumers).

---

## Execution Order

Must be executed in this sequence due to dependencies:

| Step | Extraction | Depends On | Files Modified |
|------|-----------|------------|----------------|
| 1 | #1 ModelNotFoundError | — | `retry.ts` + new test |
| 2 | #4 models.ts helpers | — | `models.ts` + new test |
| 3 | #2 editor.ts antigravity | — | `editor.ts` + new test |
| 4 | #3 detect-ide.ts antigravity | — | `detect-ide.ts` + `index.ts` barrel + new test |
| 5 | #5 settingsSchema | — | `settingsSchema.ts` + new test |
| 6 | #6 config.ts preview | — | `config.ts` + new test |
| 7 | #7 googleQuotaErrors 404 | #1 | `googleQuotaErrors.ts` + new test |
| 8 | Schema regen | #5 | `schemas/settings.schema.json` |

Steps 1–6 can be parallelized (no interdependencies) but step 7 requires step 1 to be complete.

---

## Explicitly SKIPPED from this commit (70+ files)

- **All routing**: `modelRouterService.ts`, `classifierStrategy.ts`, `fallbackStrategy.ts`, `overrideStrategy.ts`
- **All fallback**: `handler.ts`, `types.ts`
- **All UI/UX**: `Banner.tsx`, `ProQuotaDialog.tsx`, `ModelDialog.tsx` rewrite, `AppHeader.tsx` banner logic, `Composer.tsx` banner prop, `DialogManager.tsx`, `InputPrompt.tsx` banner, `UIStateContext.tsx` banner/quota state, `UIActionsContext.tsx` banner actions, `slashCommandProcessor.ts` banner
- **All experiments**: `flagNames.ts`
- **All docs**: `gemini-3.md`, `settings.md`, model.md updates, configuration.md, sidebar.json, index.md
- **Persistence**: `persistentState.ts`
- **Telemetry/hooks**: `useQuotaAndFallback.ts`
- **Editor settings**: `editorSettingsManager.ts` (just an import move)
- **Integration tests**: `test-helper.ts`
- **retry.ts getErrorStatus**: LLxprt's implementation is already more advanced (bucket failover, transient error detection). No move/refactor.
- **client.ts / geminiChat.ts**: Gemini-specific client code (thinking support for gemini-3, thoughtSignature, preview model bypass)
- **httpErrors.ts**: Not created — `ModelNotFoundError` added directly to `retry.ts` to avoid duplication

---

## Verification

After all extractions:

```bash
npm run lint && npm run typecheck && npm run test && npm run build
```

Specific test commands:
```bash
# Individual test files
npx vitest run packages/core/src/utils/__tests__/retry.ModelNotFoundError.test.ts
npx vitest run packages/core/src/config/__tests__/models.test.ts
npx vitest run packages/core/src/utils/__tests__/editor.antigravity.test.ts
npx vitest run packages/core/src/ide/__tests__/detect-ide.antigravity.test.ts
npx vitest run packages/cli/src/config/__tests__/settingsSchema.previewFeatures.test.ts
npx vitest run packages/core/src/config/__tests__/config.previewFeatures.test.ts
npx vitest run packages/core/src/utils/__tests__/googleQuotaErrors.404.test.ts
```

Verify schema was regenerated:
```bash
grep previewFeatures schemas/settings.schema.json
```
