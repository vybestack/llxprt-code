# REIMPLEMENT Playbook: 472e775a1

## Commit and feature
- Upstream commit: `472e775a1`
- Feature intent: `/permissions modify trust for other directories`
- Strategy in LLxprt: **REIMPLEMENT** (not cherry-pick)

## Why cherry-pick failed / why REIMPLEMENT is required
Cherry-pick is not safe here because LLxprtâ€™s current trust flows and command architecture differ from upstream assumptions:
- `packages/cli/src/ui/commands/permissionsCommand.ts` currently only opens a `permissions` dialog and has no subcommand wiring.
- Trust mutation logic is implemented in hook/UI layer (`packages/cli/src/ui/hooks/usePermissionsModifyTrust.ts`) and writes via `loadTrustedFolders().setValue(...)` for `process.cwd()` only.
- Folder trust UX and restart behavior is managed in `packages/cli/src/ui/hooks/useFolderTrust.ts` with existing startup messaging and trust-state transitions.
- Slash command processing file location differs from requested path; in LLxprt it is at `packages/cli/src/ui/hooks/slashCommandProcessor.ts` (and tested in `packages/cli/src/ui/hooks/slashCommandProcessor.test.ts`).

Because of these structural differences, a direct patch transplant risks breaking existing command discovery, dialog behavior, and trust persistence semantics. REIMPLEMENT lets us preserve LLxprt conventions and multi-provider neutrality.

## Files to inspect/modify (current expected existence)
### Must inspect (confirmed present)
- `packages/cli/src/ui/commands/permissionsCommand.ts`
- `packages/cli/src/ui/commands/directoryCommand.tsx`
- `packages/cli/src/ui/hooks/slashCommandProcessor.ts` (LLxprt location)
- `packages/cli/src/ui/hooks/usePermissionsModifyTrust.ts`
- `packages/cli/src/ui/hooks/useFolderTrust.ts`

### Tests to inspect/modify/add (confirmed present)
- `packages/cli/src/ui/commands/permissionsCommand.test.ts`
- `packages/cli/src/ui/hooks/usePermissionsModifyTrust.test.tsx`
- `packages/cli/src/ui/hooks/useFolderTrust.test.ts`
- `packages/cli/src/ui/hooks/slashCommandProcessor.test.ts`

### Additional tests likely to update/add (confirmed present)
- `packages/cli/src/ui/commands/directoryCommand.test.tsx` (for compatibility checks)

## Behavior requirements
Implement a way to modify trust for directories other than CWD via `/permissions`, while preserving existing dialog flow.

Required behavior:
1. Keep existing `/permissions` behavior (no args => open permissions dialog).
2. Add explicit non-interactive trust modification path for a target directory.
3. Support the same trust levels already used in codebase:
   - `TRUST_FOLDER`
   - `TRUST_PARENT`
   - `DO_NOT_TRUST`
4. Normalize/resolve target path consistently with current path helpers (cross-platform safe).
5. Persist using existing trusted-folders backend (`loadTrustedFolders().setValue(...)`).
6. Return/emit user-facing success or error messages via existing command response patterns.

Edge cases:
- Missing path argument when trust-level intent is supplied.
- Invalid trust level token.
- Path with spaces and/or commas; ensure argument parsing rules are explicit and tested.
- Relative paths, `~`, `%userprofile%` expansion behavior consistency.
- `setValue` throwing (I/O or validation failure) should surface actionable error text.

## Negative checks (what NOT to change)
- Do **not** rename `/permissions` command or remove dialog action.
- Do **not** add provider-specific branding or Google-only language; keep LLxprt multi-provider neutral.
- Do **not** alter unrelated slash command loading architecture in `useSlashCommandProcessor`.
- Do **not** change trust file schema/format beyond existing `setValue` contract.
- Do **not** change `/directory add` trust gate behavior in this commit (that belongs to `9786c4dcf`).

## TDD workflow (project mandate)

### RED (tests first)
1. Extend `permissionsCommand.test.ts` with failing behavioral tests for new non-interactive trust modification mode:
   - modifies trust for an explicit target directory
   - rejects invalid trust levels
   - reports error when target path omitted
   - preserves existing dialog behavior with no args
2. Add focused tests (or upgrade weak hook tests) around trust mutation helper behavior in `usePermissionsModifyTrust.test.tsx` if helper extraction occurs.
3. If parser/routing changes are needed for slash invocation, add failing tests in `slashCommandProcessor.test.ts` verifying command action receives expected args unchanged.

Run targeted tests to confirm failure before implementation.

### GREEN (minimal implementation)
1. Implement minimal argument parsing and trust-level mapping in `permissionsCommand.ts` (or delegated utility) with least invasive API change.
2. Reuse existing trusted folder persistence path (`loadTrustedFolders().setValue`).
3. Add minimal message responses and error handling.
4. Keep existing dialog open behavior as default fallback.

Run targeted tests until green.

### REFACTOR
1. Extract parsing/normalization into small pure helper if needed for readability/testability.
2. Align messages/constants with existing command style.
3. Remove duplication between permission trust mutation paths (command vs hook) only if safe and test-covered.

Re-run targeted tests after refactor.

## Verification commands
Minimum required during implementation:
- `npm run lint`
- `npm run typecheck`
- Targeted tests:
  - `npm run test -- packages/cli/src/ui/commands/permissionsCommand.test.ts`
  - `npm run test -- packages/cli/src/ui/hooks/usePermissionsModifyTrust.test.tsx`
  - `npm run test -- packages/cli/src/ui/hooks/slashCommandProcessor.test.ts`

Full verify before declaring task complete (per repo mandate):
- `npm run format`
- `npm run lint`
- `npm run typecheck`
- `npm run test`
- `npm run build`
- `node scripts/start.js --profile-load synthetic --prompt "write me a haiku"`

## Implementation notes for LLxprt compatibility
- Keep command responses and text generic to LLxprt (no provider-specific assumptions).
- Respect existing trust model and settings-driven feature behavior.
- Ensure cross-platform path handling remains consistent with current code patterns (`path.normalize`, home expansion helpers).