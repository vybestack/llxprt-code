# Phase 17: Session Cleanup Implementation — COMPLETED

## Phase ID
`PLAN-20260211-SESSIONRECORDING.P17`

## Completed
2026-02-13

## Summary
Implemented the real logic in `sessionCleanupUtils.ts` replacing Phase 15 stubs. All 27 Phase 16 tests pass.

## Files Modified

### `packages/core/src/recording/sessionCleanupUtils.ts`
- **`readSessionHeader(filePath)`** — Reads the first 4096 bytes of a .jsonl file, parses the first line as JSON, and extracts `sessionId` and `startTime` from the `session_start` event payload.
- **`isPidAlive(pid)`** — Checks PID liveness using `process.kill(pid, 0)`.
- **`readLockPid(lockPath)`** — Reads and parses a lock file to extract the PID.
- **`getAllJsonlSessionFiles(chatsDir, currentSessionId?)`** — Scans directory for `session-*.jsonl` files, stats each, reads session header, builds `JsonlSessionFileEntry` array. Handles ENOENT gracefully.
- **`shouldDeleteSession(entry)`** — Checks for `entry.filePath + '.lock'` sidecar lock file. No lock → `'delete'`. Lock with live PID → `'skip'`. Lock with dead PID → `'stale-lock-only'`.
- **`cleanupStaleLocks(chatsDir)`** — Reads directory for `.lock` files. Orphaned locks (no corresponding data file) are deleted. Stale locks (dead PID) are deleted. Active locks (live PID) are preserved. Returns count of cleaned locks.

### `packages/core/src/recording/sessionCleanupUtils.test.ts`
- **Minimal bug fix**: Test 1 used session IDs `session-aaa11111`, `session-bbb22222`, `session-ccc33333` which all produce `session-` from `sessionId.slice(0, 8)`, causing filename collisions. Fixed to use UUID-style IDs `aaa11111-0000-...`, `bbb22222-0000-...`, `ccc33333-0000-...` matching the convention used by all other tests in the file.

## Key Design Decisions

1. **File-path-based locks**: Lock files use `<sessionFile>.lock` convention (not session-ID-based `<sessionId>.lock`) matching what the tests create and expect.
2. **Direct PID checking**: Used `process.kill(pid, 0)` directly instead of going through `SessionLockManager` since the lock file convention differs (file-path-based vs session-ID-based).
3. **Stale lock ≠ delete**: `shouldDeleteSession` returns `'stale-lock-only'` for stale locks (dead PID) — the data file is NOT auto-deleted. Retention policy is the sole arbiter of data file deletion.

## Pseudocode Alignment
- `getAllJsonlSessionFiles`: session-cleanup.md lines 13-38
- `shouldDeleteSession`: session-cleanup.md lines 50-74
- `cleanupStaleLocks`: session-cleanup.md lines 85-130

## Verification Results

```
TypeScript: [OK] All packages compile cleanly
Target tests: [OK] 27/27 passed (sessionCleanupUtils.test.ts)
Full suite:   [OK] 10,462 passed, 150 skipped across all packages
Regressions:  [OK] None
```
