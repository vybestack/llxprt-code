# Phase 07 Completion: Replay Engine TDD

## Phase ID
`PLAN-20260211-SESSIONRECORDING.P07`

## Completed
2026-02-13

## Deliverables
- `packages/core/src/recording/ReplayEngine.test.ts` — Comprehensive test suite for ReplayEngine

## Test Coverage Summary
- **Total tests**: 65 (45 deterministic + 20 property-based)
- **Property-based ratio**: 30.7% (exceeds 30% threshold)
- **Tests failing against stub**: 61 (expected TDD behavior)
- **Tests passing against stub**: 4 (error-result tests that expect ok: false)

## Test Categories Covered
1. **Content Accumulation** (Tests 1-2): user+AI messages, tool_call blocks
2. **Compression Handling** (Tests 3-4): single compression, multiple compressions
3. **Rewind Handling** (Tests 5-7): basic rewind, exceeding history, rewind after compression
4. **Corruption Handling** (Tests 8-9): corrupt last line (silent discard), corrupt mid-file (warning)
5. **Error Results** (Tests 10-12): missing session_start, empty file, project hash mismatch
6. **Unknown Events & Seq** (Tests 13-14): unknown types, non-monotonic seq
7. **Metadata Tracking** (Tests 15-18): provider_switch, directories_changed, lastSeq, eventCount
8. **readSessionHeader** (Tests 19-20): valid and invalid files
9. **session_event Handling** (Tests 21-22): collected in sessionEvents, not in history
10. **Golden Replay Tests** (Tests 23-27): new session, resumed, compressed, multi-resume, resume+compression+resume
11. **Interleaved Events** (Tests 28-29): compression→rewind→content sequences
12. **Malformed Payloads** (Tests 30-38): all event types with missing required fields
13. **Repeated Resume Cycles** (Tests 39-40): seq monotonicity, history accumulation
14. **Malformed Event Summary** (Tests 41-42): summary reporting, 5% threshold
15. **BOM Handling** (Tests 42a-42b): BOM on replaySession, BOM on readSessionHeader
16. **Property-Based Tests** (Tests 43-62): content length, compression, rewind, idempotency, metadata, lastSeq, eventCount, round-trip, warnings, seq monotonicity, interleaving, malformed payloads, provider switch, directories_changed, session_events, BOM, multi-compression, readSessionHeader, corrupt last line

## Verification Results
- [OK] File exists: `packages/core/src/recording/ReplayEngine.test.ts`
- [OK] `npm run typecheck` passes (all workspaces)
- [OK] Tests compile and run (65 total, 61 fail against stub as expected)
- [OK] Property-based tests: 20/65 = 30.7% (≥30%)
- [OK] No mock theater (0 toHaveBeenCalled)
- [OK] No reverse testing (0 NotYetImplemented)
- [OK] @requirement markers: 101
- [OK] @plan markers: 83
- [OK] Uses SessionRecordingService for happy-path test file generation
- [OK] Hand-crafts JSONL for corruption/edge-case tests
- [OK] Behavioral assertions (toBe, toEqual, toContain)

## Test File Generation Strategy
- **Happy-path tests**: Use `SessionRecordingService` to generate valid JSONL files, then replay
- **Corruption/edge-case tests**: Hand-craft JSONL strings (corrupt JSON, missing fields, BOM, partial lines, unknown events)
