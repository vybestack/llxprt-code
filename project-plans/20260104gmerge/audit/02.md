# Batch 02 Audit

## Intent
Batch 02 aimed to apply five upstream CLI changes: prevent queuing slash/shell commands, update shell tool call colors, fix non-interactive `--allowed-tools` substring matching, add `stream-json` output format, and avoid unconditional git clone fallback when installing extensions.

## Claimed Action
- PROGRESS.md and NOTES.md state Batch 02 was fully processed with 4 reimplementations and 1 skip (colors), plus the extension install fallback marked partial/not implemented.
- AUDIT.md records:
  - `4f17eae5` REIMPLEMENTED (queue blocking UI wiring).
  - `d38ab079` SKIP (aesthetic colors).
  - `2e6d69c9` REIMPLEMENTED (substring matching).
  - `47f69317` REIMPLEMENTED (stream-json output).
  - `8c1656bf` PARTIAL (install fallback not applied).

## Code Evidence
- Queue blocking and error UI wiring:
  - `packages/cli/src/ui/AppContainer.tsx:509` (queueErrorMessage state + timeout cleanup).
  - `packages/cli/src/ui/contexts/UIStateContext.tsx:178` (queueErrorMessage in UI state).
  - `packages/cli/src/ui/contexts/UIActionsContext.tsx:135` (setQueueErrorMessage action).
  - `packages/cli/src/ui/components/Composer.tsx:32` (passes queueErrorMessage + setter).
  - `packages/cli/src/ui/components/InputPrompt.tsx:250` (blocks slash/shell queue and sets error).
- `--allowed-tools` substring matching fix:
  - `packages/core/src/utils/tool-utils.ts:23` (doesToolInvocationMatch accepts string invocation, command matching logic).
  - `packages/core/src/tools/shell.ts:116` (non-interactive allowlist check uses doesToolInvocationMatch).
- Stream JSON output format:
  - `packages/core/src/utils/output-format.ts:12` (STREAM_JSON enum + StreamJsonFormatter).
  - `packages/cli/src/nonInteractiveCli.ts:39` (stream-json mode, stream event emission).
  - `packages/cli/src/config/config.ts:199` (output-format includes stream-json).
- Extension install fallback still defaults to git when releases missing:
  - `packages/cli/src/commands/extensions/install.ts:60` (fallback to git clone when release check fails).
  - `packages/cli/src/config/extensions/github.ts:257` (downloadFromGitHubRelease throws on failure, no structured result).
  - `packages/cli/src/config/extension.ts:483` (installOrUpdateExtension assumes github-release download succeeds; no consent-driven fallback).

## Gaps/Mismatches
- Shell tool call color changes were skipped (no evidence of the upstream color adjustments).
- The “don’t always fall back on git clone” change is not implemented; the installer still falls back to git if releases are missing or checks fail and downloadFromGitHubRelease throws on errors without a fallback/consent flow.

## Verdict
partial
