# Phase 08: Integration Wiring - COMPLETED

## Phase ID
`PLAN-20250217-CREDPROXY-REMEDIATION.P08`

## Completion Date
2025-02-17

## Summary
Wired real OAuth providers into the credential proxy system through SandboxProxyLifecycle.

## Changes Made

### 1. Updated sandbox-proxy-lifecycle.ts

**File**: `packages/cli/src/auth/proxy/sandbox-proxy-lifecycle.ts`

Added:
- Import of real flow classes: `AnthropicDeviceFlow`, `CodexDeviceFlow`, `QwenDeviceFlow` from core
- Import of `OAuthToken` type from core
- Import of `RefreshCoordinator` from `./refresh-coordinator.js`
- `QWEN_DEVICE_FLOW_CONFIG` constant with Qwen OAuth configuration
- `CodexFlowAdapter` class - adapter that wraps `CodexDeviceFlow` to match `OAuthFlowInterface`
  - Implements `initiateDeviceFlow` using Codex's device code flow
  - Implements `pollForToken` using Codex's `pollForDeviceToken` + `completeDeviceAuth`
  - Implements `refreshToken` delegation to wrapped flow
- `buildDefaultFlowFactories()` function that creates flow factories for:
  - `anthropic` → `AnthropicDeviceFlow`
  - `codex` → `CodexFlowAdapter` (wraps CodexDeviceFlow)
  - `qwen` → `QwenDeviceFlow` with config
- Updated `createAndStartProxy()` to:
  - Build flow factories using `buildDefaultFlowFactories()`
  - Create `RefreshCoordinator` with 30s cooldown
  - Pass `flowFactories` and `refreshCoordinator` to `CredentialProxyServer`

### 2. CodexFlowAdapter

The `CodexDeviceFlow` class doesn't have `initiateDeviceFlow()` - it uses different methods (`buildAuthorizationUrl()` for browser redirect, `requestDeviceCode()` for device code). Created an adapter that:
- Uses `requestDeviceCode()` to get device auth credentials
- Maps the response to the expected `DeviceCodeResponse` interface
- Implements polling via `pollForDeviceToken()` + `completeDeviceAuth()`

## Verification Results

### TypeScript Compilation
```bash
npm run typecheck
# [OK] All packages pass
```

### Tests
```bash
npm test -- packages/cli/src/auth/proxy/ --reporter=verbose
# [OK] 239 passed | 3 skipped (242)
```

### Lint
```bash
npm run lint
# [OK] No warnings or errors
```

### Build
```bash
npm run build
# [OK] All packages build successfully
```

### Flow Factories Wired
```bash
grep -n "flowFactories\|buildDefaultFlowFactories" packages/cli/src/auth/proxy/sandbox-proxy-lifecycle.ts
# 140:function buildDefaultFlowFactories(): Map<string, () => OAuthFlowInterface> {
# 175:  const flowFactories = buildDefaultFlowFactories();
# 181:      const flowFactory = flowFactories.get(provider);
# 205:    flowFactories,
```

### RefreshCoordinator Wired
```bash
grep -n "RefreshCoordinator" packages/cli/src/auth/proxy/sandbox-proxy-lifecycle.ts
# 34:import { RefreshCoordinator } from './refresh-coordinator.js';
# 177:  // Create RefreshCoordinator for rate-limited, deduplicated refresh
# 178:  const refreshCoordinator = new RefreshCoordinator({
```

### Real Flow Classes Imported
```bash
grep -n "AnthropicDeviceFlow\|QwenDeviceFlow\|CodexDeviceFlow" packages/cli/src/auth/proxy/sandbox-proxy-lifecycle.ts
# 25:  AnthropicDeviceFlow,
# 26:  CodexDeviceFlow,
# 27:  QwenDeviceFlow,
# 62: * Adapter that wraps CodexDeviceFlow to match OAuthFlowInterface.
# 69:  private flow: CodexDeviceFlow;
# 72:    this.flow = new CodexDeviceFlow();
# 142:    ['anthropic', () => new AnthropicDeviceFlow() as OAuthFlowInterface],
# 146:      () => new QwenDeviceFlow(QWEN_DEVICE_FLOW_CONFIG) as OAuthFlowInterface,
```

## Success Criteria Met

1. [OK] `SandboxProxyLifecycle` builds default flowFactories via `buildDefaultFlowFactories()`
2. [OK] `SandboxProxyLifecycle` builds default providers (via flowFactories pattern)
3. [OK] `SandboxProxyLifecycle` creates RefreshCoordinator with 30s cooldown
4. [OK] `CredentialProxyServer` receives all dependencies (flowFactories, refreshCoordinator)
5. [OK] Real flow classes (AnthropicDeviceFlow, CodexDeviceFlow via adapter, QwenDeviceFlow) are used
6. [OK] TypeScript compiles
7. [OK] All existing tests pass

## Notes

- The `CodexDeviceFlow` required an adapter because its interface differs from `OAuthFlowInterface`
- Codex uses `requestDeviceCode()` + `pollForDeviceToken()` + `completeDeviceAuth()` instead of `initiateDeviceFlow()`
- The adapter enables device code flow for Codex in sandbox mode (no localhost callback server needed)
- Gemini OAuth is not included (uses google-auth-library, needs special handling as noted in plan)

## Next Phase
Phase 08a: Integration Wiring Verification
