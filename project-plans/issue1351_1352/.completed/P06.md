# P06: Implement KeyringTokenStore — COMPLETED

**Plan ID:** PLAN-20260213-KEYRINGTOKENSTORE.P06
**Component:** `packages/core/src/auth/keyring-token-store.ts`
**Completed:** 2026-02-14

## Summary

Replaced all `NotYetImplemented` stubs in `KeyringTokenStore` with real
implementations following the approved pseudocode at
`project-plans/issue1351_1352/analysis/pseudocode/keyring-token-store.md`.

## Methods Implemented

| Method | Pseudocode Lines | Key Behavior |
|---|---|---|
| `ensureLockDir` | 141-143 | `fs.mkdir(LOCK_DIR, { recursive: true, mode: 0o700 })` |
| `saveToken` | 38-44 | Validate → `passthrough().parse()` → JSON.stringify → `secureStore.set()` |
| `getToken` | 45-77 | Three-layer error handling: SecureStoreError(CORRUPT)→null, JSON.parse→null, Zod→null |
| `removeToken` | 78-86 | Best-effort delete; all errors swallowed and logged |
| `listProviders` | 87-102 | Parse keys → unique providers → sorted; returns `[]` on error |
| `listBuckets` | 103-119 | Filter by `provider:` prefix → extract bucket → sorted; returns `[]` on error |
| `getBucketStats` | 120-132 | Delegates to `getToken`; returns placeholder stats or null |
| `acquireRefreshLock` | 144-199 | Exclusive file create (`flag: 'wx'`), stale lock detection, polling loop |
| `releaseRefreshLock` | 200-214 | `fs.unlink` with ENOENT tolerance (idempotent) |

## Key Design Decisions

- **`OAuthTokenSchema.passthrough().parse()`** used on both save and read paths
  to preserve Codex extra fields (account_id, id_token)
- **`SecureStoreError`** imported and checked by `instanceof + .code === 'CORRUPT'`
  in `getToken` — CORRUPT returns null, all others propagate
- **`hashIdentifier()`** used in all warning logs — never exposes raw provider:bucket
- **Lock file format:** `{ pid, timestamp }` JSON — enables stale lock detection
- **Sleep helper:** inline `const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms))`

## Test File Fixes (Infrastructure Only)

The test file (`keyring-token-store.test.ts`) required 3 minimal fixes to run
with the project's fast-check v4.5.3 (package.json declares `^4.2.0`):

1. `fc.stringOf(arb, opts)` → `fc.string({ unit: arb, ...opts })` (2 occurrences)
   — `stringOf` was removed in fast-check v4; `string` with `unit` is the replacement
2. Removed unnecessary `// eslint-disable-next-line no-console` directive
3. Renamed `mockKeyring` → `_mockKeyring` to satisfy `@typescript-eslint/no-unused-vars`

No test logic or contracts were changed.

## Verification

- **58/58 tests PASS** — `npx vitest run src/auth/__tests__/keyring-token-store.test.ts`
- **typecheck PASS** — `npm run typecheck`
- **lint PASS** — `npm run lint`
