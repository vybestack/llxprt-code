# Phase 10: ProxyTokenStore TDD — COMPLETED

## Phase ID
`PLAN-20250214-CREDPROXY.P10`

## Completed
- Date: 2025-02-16

## Deliverables
- `packages/core/src/auth/proxy/__tests__/proxy-token-store.test.ts` — 18 behavioral tests

## Test Coverage

### getToken (3 tests)
1. Sends correct operation/provider/bucket, returns token from response
2. Returns null when server responds with NOT_FOUND status
3. Passes undefined bucket when none specified

### saveToken (2 tests)
4. Sends token data with correct operation/provider/bucket
5. Resolves without error on success response

### removeToken (2 tests)
6. Sends remove request with provider/bucket
7. Resolves without error on success

### listProviders (2 tests)
8. Returns array of provider names from server response
9. Returns empty array when no providers

### listBuckets (2 tests)
10. Returns array of bucket names for a provider
11. Returns empty array when no buckets

### getBucketStats (2 tests)
12. Returns placeholder BucketStats when token exists
13. Returns null when server responds NOT_FOUND

### Lock no-ops (2 tests)
14. acquireRefreshLock returns true without contacting server
15. releaseRefreshLock resolves without contacting server

### Error handling (2 tests)
16. Rejects when server returns INTERNAL_ERROR status
17. Rejects when server sends UNAUTHORIZED status

### Connection lifecycle (1 test)
18. Lazy connection — no connect in constructor, connects on first call

## Verification Results
- `npm run typecheck` — PASS
- `grep -c "toHaveBeenCalled"` → 0 (no mock theater)
- `grep -c "NotYetImplemented"` → 0 (no reverse testing)
- 24 behavioral assertions across 18 tests

## Architecture Notes
- All tests use REAL Unix domain sockets with `net.createServer()`
- Test server speaks the framing protocol (length-prefixed JSON)
- Each test configures server response behavior via a `RequestHandler` callback
- No mocking of ProxySocketClient internals — tests exercise the full stack
- Tests will FAIL until Phase 11 implements the ProxyTokenStore methods
