# Phase 19: RefreshCoordinator TDD — COMPLETED

**Phase ID:** PLAN-20250214-CREDPROXY.P19
**Completed:** 2025-02-16

## Deliverables

### Created
- `packages/cli/src/auth/proxy/__tests__/refresh-coordinator.test.ts` — 17 behavioral tests

### Test Coverage

#### Basic Refresh (3 tests)
1. Reads current token, calls refreshFn, merges result, saves merged token, returns sanitized token
2. Returns status 'ok' with sanitized token (no refresh_token)
3. Returns error status when no token exists in store

#### Rate Limiting (3 tests)
4. Returns rate_limited with retryAfter for second refresh within cooldown
5. Allows refresh after cooldown period expires
6. Rate limits independently per provider+bucket

#### Concurrent Deduplication (2 tests)
7. Deduplicates concurrent refresh calls for the same provider+bucket
8. Handles concurrent refresh calls for different providers independently

#### Error Handling (3 tests)
9. Returns auth_error for 401/invalid_grant errors without retrying
10. Retries transient errors up to 2 times then returns error
11. Returns ok when transient error succeeds on retry

#### Token Handling (2 tests)
12. Sanitizes returned token by removing refresh_token
13. Preserves existing refresh_token when refreshFn omits it

#### Reset (2 tests)
14. Clears rate limiting state so immediate refresh is allowed
15. Clears inflight map allowing fresh requests

### (2 additional tests within the above groups)

## Verification
- `npm run typecheck` — PASSES
- No `toHaveBeenCalled` mock theater
- No `NotYetImplemented` in assertions
- 46 assertions across 17 tests
- Uses `vi.useFakeTimers()` for time-dependent tests
- InMemoryTokenStore is a real implementation (class with Maps)
- refreshFn is a controllable function, not a vi.fn mock
