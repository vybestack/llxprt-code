# Phase 07: Token Sanitization & Merge TDD — COMPLETED

**Plan:** PLAN-20250214-CREDPROXY.P07
**Completed:** 2025-02-16

## Deliverables

### `packages/core/src/auth/__tests__/token-sanitization.test.ts` (11 tests)
1. Strips refresh_token from a complete token
2. Preserves access_token
3. Preserves expiry
4. Preserves token_type
5. Preserves scope when present
6. Preserves provider-specific fields (account_id, id_token)
7. Handles token with no refresh_token (returns same fields)
8. Handles token with empty string refresh_token (removes it)
9. Returns new object — does not mutate input
10. Handles minimal token (only required fields)
11. Result does NOT have refresh_token key (checked via `in` operator)
12. Preserves resource_url when present

### `packages/core/src/auth/__tests__/token-merge.test.ts` (14 tests)
1. access_token always uses new value
2. expiry always uses new value
3. refresh_token: uses new if provided and non-empty
4. refresh_token: preserves existing when new is undefined
5. refresh_token: preserves existing when new is empty string
6. scope: uses new if provided
7. scope: keeps existing when new is undefined
8. token_type: uses new if provided
9. token_type: keeps existing when new is undefined
10. resource_url: preserved when new does not have it
11. Provider-specific field (account_id) preserved from current
12. Provider-specific field from new overwrites current
13. Does not mutate input objects
14. Handles new token with only access_token and expiry

## Verification
- `npm run typecheck` — [OK] passes
- No mock theater (`toHaveBeenCalled`) — [OK] clean
- No reverse testing (`NotYetImplemented`) — [OK] clean
- Tests exercise real behavioral contracts (will fail until Phase 08 implements functions)
