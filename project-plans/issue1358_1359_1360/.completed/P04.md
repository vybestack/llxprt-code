# Phase 04: Framing Protocol TDD — COMPLETED

**Plan:** PLAN-20250214-CREDPROXY.P04
**Completed:** 2025-02-16

## Deliverables

### `packages/core/src/auth/proxy/__tests__/framing.test.ts` (16 tests)

| # | Test | Requirement |
|---|------|-------------|
| 1 | produces a 4-byte uint32 BE length prefix | R5.1 |
| 2 | writes correct UTF-8 JSON payload after the prefix | R5.1 |
| 3 | roundtrips encode → decode to produce the original object | R5.1 |
| 4 | handles empty payload {} | R5.1 |
| 5 | handles payload with newlines and unicode characters | R5.1 |
| 6 | throws when payload exceeds MAX_FRAME_SIZE bytes | R5.2 |
| 7 | produces a frame whose total length is 4 + JSON byte length | R5.1 |
| 8 | decodes a single complete frame | R5.3 |
| 9 | returns parsed JSON objects from feed | R5.3 |
| 10 | decodes multiple frames from one chunk | R5.3 |
| 11 | reassembles a frame split across two chunks | R5.3 |
| 12 | reassembles a frame split across three chunks with header split | R5.3 |
| 13 | throws on oversized length prefix before allocating buffer | R5.2 |
| 14 | decodes a zero-length-ish frame with empty JSON "{}" | R5.3 |
| 15 | starts a timer when an incomplete frame is received | R5.3 |
| 16 | cancels timer when frame completes before timeout | R5.3 |

### `packages/core/src/auth/proxy/__tests__/proxy-socket-client.test.ts` (11 tests)

| # | Test | Requirement |
|---|------|-------------|
| 1 | stores socketPath from constructor | R6.1 |
| 2 | sends a handshake frame with version 1 on connect | R6.2 |
| 3 | rejects handshake on version mismatch | R6.2 |
| 4 | generates a unique UUID for each request | R6.3 |
| 5 | rejects request after 30s timeout | R6.3 |
| 6 | triggers gracefulClose after idle timeout | R24.1 |
| 7 | surfaces "Credential proxy connection lost" on connection error | R24.2 |
| 8 | correlates concurrent responses by request ID | R6.3 |
| 9 | sends new handshake on reconnection after idle close | R6.4 |
| 10 | rejects pending requests when close() is called | R6.5 |
| 11 | gracefulClose ends socket without rejecting (no pending requests) | R6.5 |

## Verification

- `npm run typecheck` — PASSED
- No mock theater (`toHaveBeenCalled`): VERIFIED (0 matches)
- No reverse testing (`NotYetImplemented`): VERIFIED (0 matches)
- All tests exercise REAL behavior (actual encoding, actual Unix sockets)
- Tests are expected to FAIL until Phase 05 implements the stubs
