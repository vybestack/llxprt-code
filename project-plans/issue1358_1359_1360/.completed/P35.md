# Phase 35: Migration — Instantiation Sites → Factory Functions

## Completion Status: [OK] COMPLETE

**Date:** 2025-02-16
**Plan:** PLAN-20250214-CREDPROXY

## Requirements Implemented

### R2.3: All Instantiation Sites Use Factories
- [OK] Detection logic centralized in factory functions
- [OK] ZERO direct `KeyringTokenStore` instantiation at consumer sites
- [OK] ZERO direct `getProviderKeyStorage()` calls at consumer sites
- [OK] Host-side proxy code (sandbox-proxy-lifecycle.ts) correctly uses direct instantiation

### R12.5: mergeRefreshedToken Extraction
- [OK] Merge logic extracted to shared utility in `packages/core/src/auth/token-merge.ts`
- [OK] Exported from `@vybestack/llxprt-code-core` main index
- [OK] `OAuthManager` imports from `@vybestack/llxprt-code-core`
- [OK] `CredentialProxyServer` and `RefreshCoordinator` import from same source

### R26.1: Non-Sandbox Unaffected
- [OK] Non-sandbox mode behavior identical to pre-Phase code
- [OK] Factory returns `KeyringTokenStore` when `LLXPRT_CREDENTIAL_SOCKET` unset
- [OK] Factory returns direct `ProviderKeyStorage` when env unset

## Files Changed

### Core Package
- `packages/core/src/index.ts` - Added exports for:
  - `mergeRefreshedToken` and `OAuthTokenWithExtras` from token-merge.ts
  - `FrameDecoder`, `FrameError`, `encodeFrame` from framing.ts
  - `sanitizeTokenForProxy` from token-sanitization.ts

### CLI Package - Migration
- `packages/cli/src/auth/oauth-manager.ts`:
  - Removed local `mergeRefreshedToken` function
  - Removed local `OAuthTokenWithExtras` type alias
  - Now imports from `@vybestack/llxprt-code-core`
  - Added plan markers for R12.5

- `packages/cli/src/runtime/runtimeSettings.ts`:
  - Migrated `resolveNamedKey` to use `createProviderKeyStorage()` from factory
  - Added import for factory function
  - Updated plan markers for R2.3

- `packages/cli/src/auth/proxy/sandbox-proxy-lifecycle.ts`:
  - Added clarifying comments that host-side direct instantiation is correct
  - Updated plan markers

- `packages/cli/src/auth/proxy/credential-proxy-server.ts`:
  - Fixed imports to use main `@vybestack/llxprt-code-core` export
  - Removed deep path imports that didn't work with package exports

- `packages/cli/src/auth/proxy/refresh-coordinator.ts`:
  - Fixed imports to use main `@vybestack/llxprt-code-core` export

### Test Files
- `packages/cli/src/runtime/__tests__/authKeyName.test.ts`:
  - Added mock for `createProviderKeyStorage` from factory
  - Tests now work with migrated code

- `packages/cli/src/auth/proxy/__tests__/credential-proxy-server.test.ts`:
  - Fixed dynamic import to use main core export

- `packages/cli/src/auth/proxy/__tests__/migration-completeness.test.ts` (NEW):
  - Tests for factory usage at consumer sites
  - Tests for mergeRefreshedToken extraction
  - Tests for non-sandbox mode unchanged behavior
  - Tests for token merge contract consistency

## Verification Results

```bash
# ZERO direct KeyringTokenStore at consumers
grep -rn "new KeyringTokenStore" packages/cli/src/ --include="*.ts" | \
  grep -v "credential-store-factory" | grep -v "__tests__" | \
  grep -v "node_modules" | grep -v "proxy" | grep -v "\.spec\." | grep -v "\.test\."
# Exit code: 1 (no matches - PASS)

# ZERO direct getProviderKeyStorage at consumers (only comment found)
grep -rn "getProviderKeyStorage\b" packages/cli/src/ --include="*.ts" | \
  grep -v "credential-store-factory" | grep -v "__tests__" | \
  grep -v "node_modules" | grep -v "proxy" | grep -v "\.spec\." | grep -v "\.test\."
# Only comment match - PASS

# mergeRefreshedToken shared
grep -rn "mergeRefreshedToken" packages/core/src/auth/token-merge.ts packages/cli/src/auth/oauth-manager.ts
# Shows: core defines, cli imports - PASS

# All verification passes
npm run typecheck  # PASS
npm run test       # PASS (3997 tests)
npm run lint       # PASS
npm run format     # PASS
npm run build      # PASS
node scripts/start.js --profile-load synthetic "haiku" # PASS
```

## Architecture Summary

After Phase 35, credential store instantiation follows this pattern:

1. **Consumer Code** (e.g., OAuthManager, runtimeSettings):
   - Calls `createTokenStore()` or `createProviderKeyStorage()` from factory
   - Factory detects proxy mode via `LLXPRT_CREDENTIAL_SOCKET` env var
   - Returns appropriate implementation (proxy or direct)

2. **Host-Side Proxy Code** (sandbox-proxy-lifecycle.ts):
   - Directly instantiates `KeyringTokenStore` and calls `getProviderKeyStorage()`
   - This is correct because it IS the credential source for proxied requests

3. **Shared Utilities** (token-merge.ts, framing.ts, token-sanitization.ts):
   - Exported from `@vybestack/llxprt-code-core` main index
   - Used by both OAuthManager (cli) and CredentialProxyServer (cli)

## Notes

- Fixed pre-existing issue with deep import paths (`@vybestack/llxprt-code-core/src/...`)
- These paths didn't work because the symlinked package points to src/ which has .ts files, not .js files
- Solution: Export all needed symbols from the main core index
