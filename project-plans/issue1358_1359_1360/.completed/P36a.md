# Phase 36a: Deprecation â€” Verification

**Verified by:** LLxprt Code  
**Date:** 2026-02-16  
**Status:** [OK] PASS

---

## 1. Structural Verification

### P36 Plan Markers
```bash
grep -r "@plan:PLAN-20250214-CREDPROXY.P36" packages/
```
**Result:** No explicit `@plan:PLAN-20250214-CREDPROXY.P36` format found, but `@plan PLAN-20250214-CREDPROXY.P36` (without colon) markers are present in:
- `packages/cli/src/auth/proxy/credential-store-factory.ts` (lines 16-17)
- `packages/core/src/auth/keyring-token-store.ts` (line 14)
- `packages/core/src/storage/provider-key-storage.ts` (in JSDoc for getProviderKeyStorage)

### TypeScript Compilation
```
npm run typecheck
```
**Result:** [OK] All 4 workspaces pass typecheck with no errors.

---

## 2. Deferred Implementation Detection

```bash
grep -rn -E "(TODO|FIXME|HACK|STUB|XXX|TEMPORARY)" packages/cli/src/auth/proxy/ packages/core/src/auth/ | grep -v ".test.ts" | grep -v node_modules
```
**Result:** [OK] No deferred implementation markers found.

---

## 3. Deprecation Verification

### Zero Direct KeyringTokenStore Instantiation at Consumer Sites
```bash
grep -rn "new KeyringTokenStore" packages/cli/src/ --include="*.ts" | grep -v "credential-store-factory" | grep -v "__tests__" | grep -v "node_modules" | grep -v "proxy/" | grep -v ".spec.ts" | grep -v ".test.ts"
```
**Output:**
```
ZERO MATCHES - PASS
```
[OK] No direct instantiation at consumer sites (test files are appropriately excluded).

### Zero Direct getProviderKeyStorage() Calls at Consumer Sites
```bash
grep -rn "getProviderKeyStorage\b" packages/cli/src/ --include="*.ts" | grep -v "credential-store-factory" | grep -v "__tests__" | grep -v "node_modules" | grep -v "proxy/" | grep -v ".spec.ts" | grep -v ".test.ts"
```
**Output:**
```
packages/cli/src/runtime/runtimeSettings.ts:53:// @requirement:R2.3 - Use factory instead of direct getProviderKeyStorage
packages/cli/src/runtime/runtimeSettings.ts:2428:  // R2.3: Use factory instead of direct getProviderKeyStorage to support proxy mode
```
[OK] These are **comment documentation only**, not actual function calls. No violations.

### mergeRefreshedToken Has Exactly One Definition
```bash
grep -rn "function mergeRefreshedToken\|mergeRefreshedToken =" packages/ --include="*.ts" | grep -v "node_modules" | grep -v "__tests__"
```
**Output:**
```
packages/core/dist/src/auth/token-merge.d.ts:16:export declare function mergeRefreshedToken(...)
packages/core/src/auth/token-merge.ts:20:export function mergeRefreshedToken(
```
[OK] One source definition in `token-merge.ts`, plus generated `.d.ts` declaration. No duplicates.

---

## 4. Guard Documentation Verification

### KeyringTokenStore @internal Marker
```typescript
// packages/core/src/auth/keyring-token-store.ts (lines 57-60)
/**
 * @internal **DO NOT instantiate directly in consumer code.**
 * Use `createTokenStore()` from `credential-store-factory.ts` instead.
 * This ensures proper environment detection (sandbox vs. direct mode)
 */
export class KeyringTokenStore implements TokenStore { ... }
```
[OK] Has `@internal` marker and factory usage note.

### getProviderKeyStorage @internal Marker
```typescript
// packages/core/src/storage/provider-key-storage.ts (lines 123-132)
/**
 * @internal **DO NOT call directly in consumer code.**
 * Use `createProviderKeyStorage()` from `credential-store-factory.ts` instead.
 * This ensures proper environment detection (sandbox vs. direct mode)
 * and consistent behavior across the application.
 *
 * @pseudocode lines 70-74
 * @plan PLAN-20250214-CREDPROXY.P36
 */
export function getProviderKeyStorage(): ProviderKeyStorage { ... }
```
[OK] Has `@internal` marker and factory usage note.

### Factory Module Documentation
```typescript
// packages/cli/src/auth/proxy/credential-store-factory.ts (lines 8-19)
/**
 * Factory functions for creating credential stores that automatically detect
 * whether we're running inside a sandbox (proxy mode) or on the host (direct mode).
 *
 * **This module is the single entry point for obtaining TokenStore and
 * ProviderKeyStorage instances.** Direct instantiation of `KeyringTokenStore`
 * or calls to `getProviderKeyStorage()` from consumer code are prohibited.
 * Use `createTokenStore()` and `createProviderKeyStorage()` instead.
 *
 * @plan PLAN-20250214-CREDPROXY.P32
 * @plan PLAN-20250214-CREDPROXY.P36
 * @requirement R2.3, R2.4, R9.5
 */
```
[OK] Factory module has documentation noting single entry point.

---

## 5. Non-Regression Check

### TypeScript
```
npm run typecheck
```
[OK] All 4 workspaces pass.

### Tests
```
npm run test
```
**Summary:**
- **@vybestack/llxprt-code-core:** 7045 passed, 95 skipped (43.00s)
- **@vybestack/llxprt-code (cli):** 3929 passed, 62 skipped (41.26s)
- **@vybestack/llxprt-code-a2a-server:** 49 passed (2.77s)
- **llxprt-code-vscode-ide-companion:** 32 passed, 1 skipped (1.58s)

[OK] **Total: 11,055 tests passed, 158 skipped, 0 failures.**

### Lint
```
npm run lint
```
[OK] Passes with 0 warnings.

---

## 6. Anti-Fraud Checks

### deprecation-guard.test.ts Uses Behavioral Tests
**File:** `packages/cli/src/auth/proxy/__tests__/deprecation-guard.test.ts`

The test file uses **grep-based file system scans** (execSync + grep) to verify deprecation guards:
- `grepFiles()` helper runs actual grep commands against the codebase
- Tests check for `new KeyringTokenStore`, `getProviderKeyStorage()`, and `function mergeRefreshedToken` patterns
- No mock objects or stub implementations
- Tests verify actual file contents, not simulated behavior

**Test categories (all behavioral):**
1. R2.3: No Direct KeyringTokenStore Instantiation at Consumer Sites
2. R2.3: No Direct getProviderKeyStorage() Calls at Consumer Sites
3. R12.5: mergeRefreshedToken Not Duplicated
4. Factory Module is Single Entry Point
5. R26.1: Non-Sandbox Mode Behavioral Equivalence

[OK] All tests are **behavioral grep-based scans**, not mock theater.

---

## 7. What Was Deprecated

| Component | Deprecated Pattern | Replacement |
|-----------|-------------------|-------------|
| `KeyringTokenStore` | `new KeyringTokenStore()` at consumer sites | `createTokenStore()` from factory |
| `getProviderKeyStorage()` | Direct calls at consumer sites | `createProviderKeyStorage()` from factory |
| N/A | `mergeRefreshedToken` duplication | Single canonical definition in `token-merge.ts` |

---

## 8. Issues Found

**None.** All deprecation guards are in place and functioning correctly.

---

## Verdict

# [OK] PASS

**Justification:**
1. Zero direct `KeyringTokenStore` instantiation at consumer sites (excluding tests and factory)
2. Zero direct `getProviderKeyStorage()` calls at consumer sites (only comment references)
3. Single `mergeRefreshedToken` definition exists (in `token-merge.ts`)
4. All deprecated APIs have `@internal` markers with factory usage instructions
5. Factory module is documented as the single entry point
6. All 11,055 tests pass
7. TypeScript compilation succeeds
8. Linting passes with 0 warnings
9. deprecation-guard.test.ts uses behavioral grep-based tests, not mocks
