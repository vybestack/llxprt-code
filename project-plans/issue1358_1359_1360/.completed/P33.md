# P33: Factory Function + Detection Wiring - COMPLETED

**Plan:** PLAN-20250214-CREDPROXY.P33
**Completed:** 2026-02-16

## Summary

Phase 33 wires the factory functions from Phase 32 into all consumer code, replacing direct `KeyringTokenStore` and `getProviderKeyStorage()` instantiation with factory calls that automatically detect proxy mode.

## Requirements Implemented

- **R2.3: Factory Functions at Instantiation Sites** - Consumer code no longer knows whether it's using proxy or direct stores
- **R17.4: authCommand Proxy Dispatch** - When `LLXPRT_CREDENTIAL_SOCKET` is set, auth uses `ProxyOAuthAdapter`
- **R16.8: OAuthManager Skips Proactive Renewal in Proxy Mode** - Proactive renewal timers are not scheduled in proxy mode (host handles refresh)

## Files Modified

### Core Package
- `packages/core/src/index.ts` - Added exports for `ProxyTokenStore`, `ProxyProviderKeyStorage`, `ProxySocketClient`

### Consumer Code Updates
- `packages/cli/src/ui/commands/authCommand.ts` - Uses `createTokenStore()`
- `packages/cli/src/providers/providerManagerInstance.ts` - Uses `createTokenStore()`
- `packages/cli/src/runtime/runtimeContextFactory.ts` - Uses `createTokenStore()`
- `packages/cli/src/ui/commands/profileCommand.ts` - Uses `createTokenStore()` (2 instances)
- `packages/cli/src/ui/commands/keyCommand.ts` - Uses `createProviderKeyStorage()` (6 instances)
- `packages/cli/src/auth/oauth-manager.ts` - Added proxy mode check in `scheduleProactiveRenewal()`
- `packages/cli/src/providers/oauth-provider-registration.ts` - Changed `KeyringTokenStore` â†’ `TokenStore` interface

### Import Path Fixes
- `packages/cli/src/auth/proxy/credential-store-factory.ts` - Fixed imports to use main package export
- `packages/cli/src/auth/proxy/proxy-oauth-adapter.ts` - Fixed imports to use main package export
- `packages/cli/src/auth/proxy/__tests__/integration.test.ts` - Fixed imports
- `packages/cli/src/auth/proxy/__tests__/credential-proxy-server.test.ts` - Fixed imports

### Tests
- `packages/cli/src/auth/proxy/__tests__/factory-detection-wiring.test.ts` - Behavioral tests for factory wiring
- `packages/cli/src/ui/commands/keyCommand.subcommands.test.ts` - Added mock for credential-store-factory

## Key Implementation Details

### Factory Detection
The factory functions (`createTokenStore()`, `createProviderKeyStorage()`) check `process.env.LLXPRT_CREDENTIAL_SOCKET` at call time:
- If set: Returns proxy implementations that communicate via Unix domain socket
- If unset: Returns direct implementations (KeyringTokenStore, getProviderKeyStorage())

### Proactive Renewal Skip (R16.8)
In `oauth-manager.ts`, the `scheduleProactiveRenewal()` method now checks for proxy mode:
```typescript
private scheduleProactiveRenewal(...): void {
  // R16.8: Skip proactive renewal in proxy mode - host handles token refresh
  if (process.env.LLXPRT_CREDENTIAL_SOCKET) {
    return;
  }
  // ... normal scheduling logic
}
```

### Interface vs Concrete Type
`oauth-provider-registration.ts` was updated to accept `TokenStore` interface instead of `KeyringTokenStore` concrete type, allowing the factory to return either proxy or direct implementations.

## Verification Results

All verification commands passed:
- `npm run typecheck` [OK]
- `npm run test` [OK] (3889 tests, 285 CLI tests)
- `npm run lint` [OK]
- `npm run format` [OK]
- `npm run build` [OK]
- Smoke test [OK] (`node scripts/start.js --profile-load synthetic --keyfile ~/.llxprt/keys/.synthetic2_key "write me a haiku"`)

## Notes

- The factory functions return singletons cached per mode
- `getProviderKeyStorage()` from core is a module-level singleton that cannot be reset; the factory caches its reference
- Test isolation uses `resetFactorySingletons()` which clears the factory's internal cache but not the core singleton
