# P31 Integration TDD Completion

Phase: `PLAN-20250214-CREDPROXY.P31`

## Prerequisite Check

- P30a completion file exists:
  - `project-plans/issue1358_1359_1360/.completed/P30a.md` [OK]
- P30 marker check evidence:
  - `packages/cli/src/auth/proxy/credential-store-factory.ts` contains `@plan:PLAN-20250214-CREDPROXY.P30`
  - `packages/cli/src/auth/proxy/sandbox-proxy-lifecycle.ts` contains `@plan:PLAN-20250214-CREDPROXY.P30`

## Files Changed

- `packages/cli/src/auth/proxy/__tests__/integration.test.ts`
- `project-plans/issue1358_1359_1360/.completed/P31.md`

No production files were modified.

## Artifact Quality Status

- Verdict: **PASS** (for P31 test artifact quality)
- Test count: **23** (required: 20â€“25)
- Required marker present: `@plan:PLAN-20250214-CREDPROXY.P31`
- Every test includes `@requirement` and `@scenario`
- No `toHaveBeenCalled` / `toHaveBeenCalledWith`
- No `toThrow('NotYetImplemented')`
- No `expect(...).not.toThrow()`
- `npm run typecheck` exits 0

## Command Outcomes (truthful)

1. `test -f packages/cli/src/auth/proxy/__tests__/integration.test.ts`
   - Exit code: **0**

2. `grep -n "@plan:PLAN-20250214-CREDPROXY.P31" packages/cli/src/auth/proxy/__tests__/integration.test.ts`
   - Exit code: **0**
   - Output:
     - `15:/** @plan:PLAN-20250214-CREDPROXY.P31 */`

3. `grep -n "toHaveBeenCalled\|toHaveBeenCalledWith" packages/cli/src/auth/proxy/__tests__/integration.test.ts`
   - Exit code: **1**
   - Interpretation: no forbidden mock-theater assertions found.

4. `grep -n "toThrow.*NotYetImplemented\|expect.*not\.toThrow()" packages/cli/src/auth/proxy/__tests__/integration.test.ts`
   - Exit code: **1**
   - Interpretation: no forbidden reverse-test patterns found.

5. `npm run typecheck`
   - Exit code: **0**

6. `npm --workspace @vybestack/llxprt-code test -- src/auth/proxy/__tests__/integration.test.ts`
   - Exit code: **1**
   - Summary: expected red state in TDD phase, with failures tied to incomplete/stubbed integration behavior:
     - Factory/lifecycle stubs still throw `NotYetImplemented`
     - `get_bucket_stats` operation not implemented on server
     - API key mutation error message mismatch vs planned contract
     - OAuth operations incomplete for adapter/server parity
     - provider scoping behavior not yet enforced as test expects

## Why Red State Is Expected in P31

P31 is an integration TDD phase. Tests are intentionally written against target end-to-end behavior before full implementation parity exists. Failures now define the implementation work for P32.

## Coverage Categories Included

- R2: factory mode detection and singleton behavior
- R25: lifecycle behavior and socket lifecycle checks
- R8: token operations over real socket path
- R9: provider key operations over real socket path
- R10: token sanitization invariant (`refresh_token` never returned)
- R17: OAuth login/refresh integration expectations
- R3/R24: unauthorized and connection-loss behavior
