# P16 â€” CredentialProxyServer TDD

**Status:** PASS
**Date:** 2025-02-16
**Phase:** 16 (PLAN-20250214-CREDPROXY.P16)

## Checklist Results

| # | Check | Result |
|---|-------|--------|
| 1 | Test file at `packages/cli/src/auth/proxy/__tests__/credential-proxy-server.test.ts` | [OK] |
| 2 | 21 behavioral tests (within 20-28 range) | [OK] |
| 3 | 53 behavioral assertions (toBe, toEqual, toContain, etc.) | [OK] |
| 4 | No mock theater (0 `toHaveBeenCalled`) | [OK] |
| 5 | No `vi.fn`, `vi.mock`, or `vi.spyOn` | [OK] |
| 6 | No reverse testing (`not.toThrow()` or `NotYetImplemented` in assertions) | [OK] |
| 7 | Real Unix sockets (ProxySocketClient connects to server socket path) | [OK] |
| 8 | In-memory test doubles (InMemoryTokenStore, InMemoryProviderKeyStorage) | [OK] |
| 9 | `npm run typecheck` passes (all 4 workspaces clean) | [OK] |
| 10 | All 21 tests fail naturally with `NotYetImplemented` from stub | [OK] |

## Test Coverage Summary

### Lifecycle (4 tests)
- start creates a Unix socket and returns the socket path
- stop removes the socket file and rejects new connections
- getSocketPath returns null before start, path after start
- start can only be called once (second call throws)

### Handshake (2 tests)
- Accepts handshake with correct version, returns handshake_ack
- Rejects handshake with wrong version

### Token Operations (6 tests)
- get_token returns token from store with refresh_token stripped
- get_token returns NOT_FOUND for missing token
- save_token saves to underlying store
- remove_token removes from underlying store
- list_providers returns provider list
- list_buckets returns bucket list for provider

### Key Operations (4 tests)
- get_api_key returns key from storage
- get_api_key returns NOT_FOUND for missing key
- list_api_keys returns key names
- has_api_key returns exists true/false

### Security (2 tests)
- get_token response does NOT include refresh_token (CRITICAL)
- save_token from inner process strips refresh_token before storing

### Error Handling (2 tests)
- Unknown operation returns INVALID_REQUEST error
- Malformed request returns error and does not crash server

### Multiple Clients (1 test)
- Handles multiple sequential client connections

## Architecture

- **InMemoryTokenStore**: Implements full `TokenStore` interface with Map-backed storage
- **InMemoryProviderKeyStorage**: Implements `saveKey`, `getKey`, `deleteKey`, `listKeys`, `hasKey` with Map-backed storage
- **ProxySocketClient**: Real client from core connects to server's Unix socket
- **Raw socket test**: Handshake version rejection uses raw `net.createConnection` + `FrameDecoder` for protocol-level testing

## Requirements Covered
R6.1-R6.2, R7.1-R7.2, R8.1-R8.6, R9.1-R9.4, R10.1-R10.2, R25.1-R25.5
