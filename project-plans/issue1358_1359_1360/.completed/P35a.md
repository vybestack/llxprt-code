# Phase 35a Verification Report

**Date:** 2026-02-16  
**Verifier:** LLxprt Code Assistant  
**Status:** [OK] PASS

## Summary

Phase 35 completed the migration of all instantiation sites to factories and extracted `mergeRefreshedToken` to a shared utility.

## Structural Verification

### P35 Markers Present
Found P35 markers in key locations:
- `packages/core/src/index.ts` - Token merge utility export
- `packages/cli/src/auth/oauth-manager.ts` - mergeRefreshedToken import
- `packages/cli/src/runtime/runtimeSettings.ts` - Factory import
- `packages/cli/src/auth/proxy/sandbox-proxy-lifecycle.ts` - Host-side verification
- `packages/cli/src/auth/proxy/__tests__/migration-completeness.test.ts` - Test coverage

### TypeScript Compilation
[OK] All packages compile successfully:
- @vybestack/llxprt-code-core
- @vybestack/llxprt-code
- @vybestack/llxprt-code-a2a-server
- @vybestack/llxprt-code-test-utils

## Deferred Implementation Detection

[OK] No TODO/FIXME/HACK/STUB/XXX/TEMPORARY markers found in `packages/core/src/auth/token-merge.ts`

## Migration Completeness

### Direct Instantiation at Consumer Sites
The grep for `new KeyringTokenStore` outside of factory/tests/proxy found only **test files**:
- `oauth-manager-initialization.spec.ts` (test file - acceptable)
- `oauth-manager.refresh-race.spec.ts` (test file - acceptable)
- `oauth-timing.integration.test.ts` (test file - acceptable)

[OK] **ZERO direct instantiation at production consumer sites**

### getProviderKeyStorage Usage
Found only:
- `keyCommand.subcommands.test.ts` (test file - acceptable)
- `runtimeSettings.ts:53` - Comment explaining R2.3 factory usage requirement

[OK] **Production code uses factories exclusively**

## mergeRefreshedToken Extraction Verification

### Location
Exported from `packages/core/src/auth/token-merge.ts`

### Function Contract
```typescript
export function mergeRefreshedToken(
  current: OAuthTokenWithExtras,
  next: Partial<OAuthTokenWithExtras>,
): OAuthTokenWithExtras {
  const merged = { ...current, ...next };
  if (next.refresh_token === undefined || next.refresh_token === '') {
    merged.refresh_token = current.refresh_token;
  }
  return merged;
}
```

### Importers (Production)
1. **OAuthManager** (`packages/cli/src/auth/oauth-manager.ts`)
   - Import: `import { mergeRefreshedToken, ... } from '@vybestack/llxprt-code-core';`
   - Uses at lines 732, 1074, 1346

2. **RefreshCoordinator** (`packages/cli/src/auth/proxy/refresh-coordinator.ts`)
   - Import: `import { mergeRefreshedToken, ... } from '@vybestack/llxprt-code-core';`
   - Uses at line 132

### Contract Verification
- [OK] access_token from new token
- [OK] expiry from new token
- [OK] refresh_token preserved if new is undefined or empty string

## Non-Regression Check

### Test Results
```
Test Files  287 passed | 1 skipped (288)
     Tests  3920 passed | 62 skipped (3982)
```

Plus additional package tests:
- a2a-server: 49 passed
- vscode-ide-companion: 32 passed | 1 skipped

[OK] **All tests pass**

## Anti-Fraud Check

### Environment Detection in Auth Code
Found NODE_ENV references only in `qwen-oauth-provider.ts`:
- Line 389: `if (process.env.NODE_ENV === 'test')`
- Line 470: `if (process.env.NODE_ENV === 'test')`

These are **pre-existing** and **unrelated to P35** - they're part of Qwen OAuth provider's test mode handling, not P35 migration code.

[OK] **No test-mode fraud in P35 changes**

## What Was Migrated

1. **Factory Functions Created** (earlier phases, verified in P35):
   - `createTokenStore()` - returns KeyringTokenStore or ProxyTokenStore
   - `createProviderKeyStorage()` - returns ProviderKeyStorage or ProxyProviderKeyStorage

2. **mergeRefreshedToken Extracted**:
   - From: OAuthManager internal function
   - To: `packages/core/src/auth/token-merge.ts`
   - Exported via: `packages/core/src/index.ts`

3. **Consumer Sites Updated**:
   - `runtimeSettings.ts` - uses `createProviderKeyStorage()`
   - `OAuthManager` - imports `mergeRefreshedToken` from core
   - `RefreshCoordinator` - imports `mergeRefreshedToken` from core

## Issues Found

None. The migration is complete and correct.

## Verdict

### [OK] PASS

Phase 35 migration is complete:
- All production consumer sites use factory functions
- `mergeRefreshedToken` is properly extracted to shared location
- Both OAuthManager and RefreshCoordinator import from the shared source
- All tests pass
- No deferred implementations found
- No anti-fraud concerns
