# Phase 36: Deprecation â€” Remove Direct KeyringTokenStore Instantiation at Consumer Sites

## Completion Status: [OK] COMPLETE

**Date:** 2025-02-16
**Plan:** PLAN-20250214-CREDPROXY

## Requirements Implemented

### R2.3 (final enforcement): No Bypass of Factory
- [OK] Guard comments added to `KeyringTokenStore` class with `@internal` marker
- [OK] Guard comments added to `getProviderKeyStorage()` function with `@internal` marker
- [OK] Factory module documentation updated as single entry point
- [OK] Deprecation guard tests created to prevent re-introduction
- [OK] Tests use grep-based scans to detect direct instantiation

### R26.1 (final verification): Non-Sandbox Unchanged
- [OK] Non-sandbox mode behavior verified identical to pre-migration
- [OK] `KeyringTokenStore` still exported from core (for factory use)
- [OK] `getProviderKeyStorage()` still exported from core (for factory use)
- [OK] Tests verify factory returns correct implementations when env unset

## Files Changed

### Core Package
- `packages/core/src/auth/keyring-token-store.ts`:
  - Added `@internal` JSDoc marker
  - Added documentation directing consumers to use `createTokenStore()`
  - Added plan marker `@plan PLAN-20250214-CREDPROXY.P36`

- `packages/core/src/storage/provider-key-storage.ts`:
  - Added `@internal` JSDoc marker to `getProviderKeyStorage()`
  - Added documentation directing consumers to use `createProviderKeyStorage()`
  - Added plan marker `@plan PLAN-20250214-CREDPROXY.P36`

### CLI Package
- `packages/cli/src/auth/proxy/credential-store-factory.ts`:
  - Updated module documentation to state it's the single entry point
  - Added documentation that direct instantiation is prohibited
  - Added plan markers to factory functions
  - Added `@plan PLAN-20250214-CREDPROXY.P36` markers

### Test Files
- `packages/cli/src/auth/proxy/__tests__/deprecation-guard.test.ts` (NEW):
  - Grep-based tests for detecting direct `KeyringTokenStore` instantiation
  - Grep-based tests for detecting direct `getProviderKeyStorage()` calls
  - Test for `mergeRefreshedToken` not duplicated (exactly one definition)
  - Tests verifying factory module is single entry point
  - Tests verifying consumer modules (runtimeContextFactory, providerManagerInstance, authCommand) use factory
  - Tests verifying classes/functions still exported from core for factory use

## Verification Results

```bash
# FINAL SWEEP: zero direct instantiation
grep -rn "new KeyringTokenStore" packages/cli/src/ --include="*.ts" | \
  grep -v "credential-store-factory" | grep -v "__tests__" | \
  grep -v "node_modules" | grep -v "proxy/" | grep -v ".spec.ts" | grep -v ".test.ts"
# Expected: ZERO matches - PASS

# Verify mergeRefreshedToken not duplicated
grep -rn "function mergeRefreshedToken\|mergeRefreshedToken =" packages/ --include="*.ts" | \
  grep -v "node_modules" | grep -v "__tests__" | grep -v ".spec.ts" | grep -v ".test.ts" | grep -v "dist/"
# Expected: exactly 1 definition (in token-merge.ts) - PASS

npm run typecheck  # PASS
npm run test       # PASS (all tests including new deprecation-guard tests)
npm run lint       # PASS
npm run format     # PASS
npm run build      # PASS
```

## Test Details

The deprecation-guard.test.ts file includes:

1. **R2.3: No Direct KeyringTokenStore Instantiation at Consumer Sites**
   - Uses grep to scan cli/src for `new KeyringTokenStore`
   - Filters out allowed locations (factory, proxy/, test files)
   - Expects ZERO violations

2. **R2.3: No Direct getProviderKeyStorage() Calls at Consumer Sites**
   - Uses grep to scan cli/src for `getProviderKeyStorage()`
   - Filters out allowed locations (factory, proxy/, test files)
   - Expects ZERO violations

3. **R12.5: mergeRefreshedToken Not Duplicated**
   - Uses grep to find function definitions
   - Expects exactly ONE definition in token-merge.ts
   - Checks for no variable assignment patterns

4. **Factory Module is Single Entry Point**
   - Verifies `createTokenStore` and `createProviderKeyStorage` are exported from factory
   - Verifies consumer modules (runtimeContextFactory, providerManagerInstance, authCommand) import from factory

5. **R26.1: Non-Sandbox Mode Behavioral Equivalence**
   - Verifies `KeyringTokenStore` still exported from core
   - Verifies `getProviderKeyStorage` still exported from core

## Architecture Summary

The final deprecation enforcement establishes:

1. **Guard Comments**: JSDoc `@internal` markers on raw classes/functions warn developers
2. **Factory Documentation**: Clear statements that factory is the ONLY sanctioned entry point
3. **Automated Guards**: Grep-based tests will catch any attempt to reintroduce direct instantiation
4. **Consumer Validation**: Tests verify actual consumer modules use factory correctly

This completes the migration to factory-based credential store creation with proper guards against regression.
