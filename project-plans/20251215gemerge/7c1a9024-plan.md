# Implementation Plan: 7c1a9024 - Retry Logic for Fetch Errors

## Summary of Upstream Changes

Upstream commit `7c1a9024` ("fix(core): add retry logic for specific fetch errors (#11066)"):
- Adds retry on "fetch failed sending request" error message

## Current State in LLxprt

### File: `/Users/acoliver/projects/llxprt-code-branches/llxprt-code-1/packages/core/src/utils/retry.ts`

**Line 39-57:** `TRANSIENT_ERROR_PHRASES` array already includes:
```typescript
const TRANSIENT_ERROR_PHRASES = [
  'connection error',
  'connection terminated',
  'terminated',
  'connection reset',
  'socket hang up',
  'socket hung up',
  'socket closed',
  'socket timeout',
  'network timeout',
  'network error',
  'fetch failed',  // â† ALREADY COVERS THIS PATTERN
  'request aborted',
  'request timeout',
  'stream closed',
  'stream prematurely closed',
  'read econnreset',
  'write econnreset',
];
```

**Line 189-218:** `isNetworkTransientError()` function checks error messages:
- Collects messages from error chain via `collectErrorDetails(error)`
- Searches for any phrase from `TRANSIENT_ERROR_PHRASES` (line 194-198)
- Also checks against `TRANSIENT_ERROR_REGEXES` and `TRANSIENT_ERROR_CODES`

**Existing coverage:** The pattern `'fetch failed'` on line 50 will match any error message containing "fetch failed", including "fetch failed sending request".

### File: `/Users/acoliver/projects/llxprt-code-branches/llxprt-code-1/packages/core/src/utils/retry.test.ts`

**Line 371-391:** Existing test already verifies basic "fetch failed" error:
```typescript
it('should retry on fetch failed error', async () => {
  let attempts = 0;
  const mockFn = vi.fn(async () => {
    attempts++;
    if (attempts === 1) {
      throw new Error('fetch failed');
    }
    return 'success';
  });
  // ... test passes
});
```

## Implementation Decision: NOP (No Operation)

**Verdict:** This batch is already fully covered by LLxprt's existing retry logic.

### Rationale:
1. The phrase `'fetch failed'` in `TRANSIENT_ERROR_PHRASES` uses substring matching (line 194-198)
2. Error message "fetch failed sending request" contains "fetch failed" and will match
3. Existing test at line 371-391 confirms retry behavior works for "fetch failed" errors
4. `isNetworkTransientError()` function properly traverses error chains to find messages

### Verification Steps:

**Test 1: Verify existing "fetch failed" test passes**
```bash
npm test -- retry.test.ts -t "should retry on fetch failed error"
```

**Test 2: Add specific test for the upstream pattern (optional, for documentation)**
```typescript
// In packages/core/src/utils/retry.test.ts, after line 391
it('should retry on "fetch failed sending request" error', async () => {
  let attempts = 0;
  const mockFn = vi.fn(async () => {
    attempts++;
    if (attempts === 1) {
      throw new Error('exception TypeError: fetch failed sending request body');
    }
    return 'success';
  });

  const promise = retryWithBackoff(mockFn, {
    maxAttempts: 3,
    initialDelayMs: 10,
  });

  await vi.runAllTimersAsync();
  const result = await promise;

  expect(result).toBe('success');
  expect(mockFn).toHaveBeenCalledTimes(2);
});
```

## Files to Review (No Modifications Needed)

| File | Current State |
|------|---------------|
| `/Users/acoliver/projects/llxprt-code-branches/llxprt-code-1/packages/core/src/utils/retry.ts` | Lines 39-57: `TRANSIENT_ERROR_PHRASES` includes `'fetch failed'` |
| `/Users/acoliver/projects/llxprt-code-branches/llxprt-code-1/packages/core/src/utils/retry.ts` | Lines 189-218: `isNetworkTransientError()` checks all phrases |
| `/Users/acoliver/projects/llxprt-code-branches/llxprt-code-1/packages/core/src/utils/retry.test.ts` | Lines 371-391: Test confirms "fetch failed" triggers retry |

## Acceptance Criteria

- [x] Pattern "fetch failed" already in `TRANSIENT_ERROR_PHRASES` (line 50)
- [x] `isNetworkTransientError()` properly checks error messages (lines 194-198)
- [x] Existing test confirms retry behavior works (lines 371-391)
- [ ] Optional: Add explicit test for "fetch failed sending request" pattern (for documentation)

## Recommendation

**No code changes required.** LLxprt's retry logic is more comprehensive than the upstream change. The existing pattern `'fetch failed'` covers all variations including "fetch failed sending request".

Optionally, add the specific test case above to document that the exact upstream pattern is covered, but this is not functionally necessary.
