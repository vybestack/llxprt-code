# Implementation Plan: 5e688b81 - Replace Test Skip (NOP)

## Summary of Upstream Changes

Upstream commit `5e688b81` ("Skip should fail safely when old_string is not found test (#10853)"):
- Changed `it('should fail safely when old_string is not found', async () => {` to `it.skip(...)`
- Added TODO comment referencing upstream issue #10851
- Skipped the test due to flakiness

## Current State in LLxprt

**LLxprt ALREADY FIXED this test instead of skipping it.**

The test at `integration-tests/replace.test.ts:95` is:
- **NOT skipped** - uses `it()`, not `it.skip()`
- **Enhanced with defensive code** to prevent flakiness
- **Stronger than upstream** - includes fixes that prevent the flakiness that caused upstream to skip

### LLxprt Improvements (commits 2bb64333e and 40e85927b)

**Commit 2bb64333e** (Dec 6, 2025) - "fix(test): improve robustness of flaky e2e replace test (#725)":
- Added `rig.sync()` after file creation to ensure filesystem flush before child process spawns
- Made file content assertion the primary check (tests behavior not implementation)
- Added extensive diagnostic logging when test fails to capture LLM arguments for debugging
- Fixes LLxprt issue #725

**Commit 40e85927b** (Dec 9, 2025) - "fix(tests): Prevent LLM from bypassing replace test with write_file tool":
- Added `excludeTools: ['write_file']` to test configuration
- Prevents LLM from bypassing the expected failure by using write_file to rewrite the file
- Ensures test is deterministic by restricting available tools
- Fixes LLxprt issue #751

### Key Differences from Upstream

| Aspect | Upstream (5e688b81) | LLxprt (current) |
|--------|---------------------|------------------|
| Test status | `it.skip()` | `it()` - ACTIVE |
| excludeTools | Not present | `['write_file']` |
| File sync | Not present | `rig.sync()` |
| Diagnostic logging | Basic | Extensive |
| Primary assertion | Tool call success | File content unchanged |

## Implementation Decision

**This is a NOP (No Operation).**

LLxprt's version is STRONGER than upstream's approach:
1. Upstream chose to skip a flaky test
2. LLxprt fixed the root causes of flakiness instead
3. LLxprt's test provides better coverage and more robust validation

**Action: Keep LLxprt's version unchanged.**

## Verification Steps

Verify that LLxprt's improvements are in place:

```bash
# Verify test is NOT skipped
grep -n "it('should fail safely when old_string is not found'" integration-tests/replace.test.ts

# Verify excludeTools is present
grep -A 5 "excludeTools.*write_file" integration-tests/replace.test.ts

# Verify rig.sync() is present
grep -n "rig.sync()" integration-tests/replace.test.ts

# Verify defensive logging is present
grep -n "FLAKY TEST DIAGNOSTIC" integration-tests/replace.test.ts
```

## Files Modified

None - this is a NOP.

## Acceptance Criteria

- [x] Test remains active (not skipped) in LLxprt
- [x] excludeTools setting is present
- [x] rig.sync() is present
- [x] Defensive diagnostic logging is present
- [x] File content assertion is the primary check
- [x] Verification confirms all improvements are in place

## Notes

This is an example of LLxprt taking a more rigorous approach to test quality. Rather than skip flaky tests, LLxprt identified and fixed the root causes:
1. Race condition (fixed with rig.sync())
2. LLM bypassing expected behavior (fixed with excludeTools)
3. Implementation-focused assertions (fixed by making file content the primary assertion)

The test has been stable in LLxprt since these fixes were applied.
