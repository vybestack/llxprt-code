# Implementation Plan: 558be873 - UI Margins + Full Width Setting

## Summary of Upstream Changes

Upstream commit `558be873` ("Re-land bbiggs changes to reduce margin on narrow screens with fixes + full width setting (#10522)"):
- Adds `ui.useFullWidth` boolean setting (NESTED under ui.properties)
- Creates `src/utils/math.ts` with `lerp()` function
- Creates `src/ui/utils/ui-sizing.ts` with `calculateMainAreaWidth()`
- Updates `AppContainer.tsx` to use dynamic width calculation
- Responsive margins: 98% width at ≤80 cols, 90% width at ≥132 cols, interpolated between

## Implementation Steps

### Step 1: Add Setting to UI Properties

**File:** `packages/cli/src/config/settingsSchema.ts`

**Location:** Inside the `ui.properties` object (around line 399-675)

Add this property inside the `properties` object of the `ui` setting:

```typescript
useFullWidth: {
  type: 'boolean',
  label: 'Use Full Width',
  category: 'UI',
  requiresRestart: false,
  default: false,
  description: 'Use the entire width of the terminal for output.',
  showInDialog: true,
},
```

**Important:** This must be NESTED under `ui.properties`, NOT a top-level setting. Place it after `showTodoPanel` property (around line 674).

### Step 2: Create Math Utility

**File:** `packages/cli/src/utils/math.ts` (NEW FILE)

```typescript
/**
 * @license
 * Copyright 2025 Vybestack LLC
 * SPDX-License-Identifier: Apache-2.0
 */

/**
 * Linearly interpolates between two values.
 *
 * @param start The start value.
 * @param end The end value.
 * @param t The interpolation amount (typically between 0 and 1).
 */
export const lerp = (start: number, end: number, t: number): number =>
  start + (end - start) * t;
```

### Step 3: Create UI Sizing Utility

**File:** `packages/cli/src/ui/utils/ui-sizing.ts` (NEW FILE)

```typescript
/**
 * @license
 * Copyright 2025 Vybestack LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import { lerp } from '../../utils/math.js';
import { type LoadedSettings } from '../../config/settings.js';

const getMainAreaWidthInternal = (terminalWidth: number): number => {
  if (terminalWidth <= 80) {
    return Math.round(0.98 * terminalWidth);
  }
  if (terminalWidth >= 132) {
    return Math.round(0.9 * terminalWidth);
  }

  // Linearly interpolate between 80 columns (98%) and 132 columns (90%).
  const t = (terminalWidth - 80) / (132 - 80);
  const percentage = lerp(98, 90, t);

  return Math.round(percentage * terminalWidth * 0.01);
};

export const calculateMainAreaWidth = (
  terminalWidth: number,
  settings: LoadedSettings,
): number =>
  settings.merged.ui?.useFullWidth
    ? terminalWidth
    : getMainAreaWidthInternal(terminalWidth);
```

### Step 4: Update AppContainer.tsx

**File:** `packages/cli/src/ui/AppContainer.tsx`

**Changes:**

1. **Add import** (around line 113):
```typescript
import { calculateMainAreaWidth } from './utils/ui-sizing.js';
```

2. **Replace hardcoded mainAreaWidth calculation** (currently line 1455):

**BEFORE:**
```typescript
const mainAreaWidth = Math.floor(terminalWidth * 0.9);
```

**AFTER:**
```typescript
const mainAreaWidth = calculateMainAreaWidth(terminalWidth, settings);
```

This replaces the static 90% width calculation with:
- Dynamic responsive margins based on terminal width
- Full width support when `ui.useFullWidth` is enabled
- Narrow screens (≤80 cols): 98% width
- Wide screens (≥132 cols): 90% width
- Between: linearly interpolated percentage

### Step 5: Test Changes

**Test files to run:**
```bash
npm test -- AppContainer.test.tsx
npm test -- Footer.test.tsx
npm test -- InputPrompt.test.tsx
```

**Expected snapshot changes:**
- `packages/cli/src/ui/components/__snapshots__/Footer.test.tsx.snap`
- `packages/cli/src/ui/components/__snapshots__/InputPrompt.test.tsx.snap`

These snapshots may need updates due to changed width calculations. Review carefully:
- Verify widths are reasonable for test terminal sizes
- Check that content still wraps properly
- Ensure no layout breakage

**Manual testing:**
1. Run llxprt-code in terminal with width ≤80 columns → verify ~98% width
2. Run in terminal with width ≥132 columns → verify ~90% width
3. Run in terminal between 80-132 columns → verify interpolated width
4. Enable `/settings` → toggle "Use Full Width" → verify 100% width when enabled

## Files to Modify/Create

| File | Action | Lines Changed (approx) |
|------|--------|----------------------|
| `packages/cli/src/config/settingsSchema.ts` | MODIFY | Add ~8 lines around line 674 |
| `packages/cli/src/utils/math.ts` | CREATE | ~15 lines |
| `packages/cli/src/ui/utils/ui-sizing.ts` | CREATE | ~31 lines |
| `packages/cli/src/ui/AppContainer.tsx` | MODIFY | Add 1 import, change 1 line (line 1455) |

## Type Definitions

No type definition updates needed - `LoadedSettings` type already supports nested `ui.useFullWidth` via the properties mechanism.

## Acceptance Criteria

- [ ] New setting appears in `/settings` dialog under "UI" category
- [ ] Enabling `useFullWidth` visibly expands content to terminal edges
- [ ] Narrow screens (≤80 cols) show ~98% width by default
- [ ] Wide screens (≥132 cols) show ~90% width by default
- [ ] Medium screens show interpolated width
- [ ] Tests pass with updated snapshots
- [ ] No TypeScript errors
- [ ] No linting errors

## Notes

- This change improves readability on narrow terminals while maintaining comfortable margins on wide displays
- The `useFullWidth` setting provides an escape hatch for users who want maximum screen real estate
- The responsive margin system is transparent to users - it just works without configuration
