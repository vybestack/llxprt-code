# Implementation Plan: 99c7108b - Integration Test Static Error Fixes

## Summary of Upstream Changes

Upstream commit `99c7108bb08e52b6550743dbe721a579af58c1f8` fixes TypeScript static errors and improves test reliability in integration tests. The primary focus is making `run_shell_command` tests properly enforce tool allowlisting by conditionally adding `--yolo` flag.

**Files Modified:**
- `integration-tests/test-helper.ts` - Added `yolo?: boolean` option to `run()`, added `matchArgs` parameter to `waitForToolCall()`
- `integration-tests/globalSetup.ts` - Fixed TypeScript bracket notation for `process.env` access
- `integration-tests/run_shell_command.test.ts` - Updated tests to use `yolo: false` when testing allowlists, added success assertions, fixed test reliability
- `integration-tests/stdin-context.test.ts` - Fixed null safety with optional chaining
- `integration-tests/write_file.test.ts` - Fixed `expect()` argument order
- `integration-tests/context-compress-interactive.test.ts` - Skipped unreliable test, fixed typo (upstream has this file; LLxprt does not)

## Current State in LLxprt

### What LLxprt Already Has

**File:** `integration-tests/test-helper.ts` (lines 253-360)

Current `run()` signature:
```typescript
run(
  promptOrOptions:
    | string
    | { prompt?: string; stdin?: string; stdinDoesNotEnd?: boolean },
  ...args: string[]
): Promise<string>
```

Current behavior:
- Line 297: **Always includes `--yolo` flag** unconditionally
- Line 360: Additional args from `...args` are appended to command
- Args passing **does work** in LLxprt (unlike what the original plan stated)

**File:** `integration-tests/run_shell_command.test.ts`

LLxprt has 11 tests, all passing `args` array correctly. Tests that check allowlists (lines 89-263) currently pass **because `--yolo` is always on**, making allowlist checks vacuous.

### What Needs to Change

The upstream changes are about **test correctness**, not fixing broken functionality:

1. **Test harness should support conditional yolo mode** - Tests that verify allowlisting should be able to disable `--yolo` to actually test the permission system
2. **Enhanced tool call matching** - `waitForToolCall()` should support argument matching to verify specific commands were called
3. **TypeScript strictness** - Use bracket notation for `process.env` access
4. **Success assertions** - Verify tool calls succeeded, not just that they were called

## Implementation Steps

### Step 1: Add `yolo` Option to TestRig.run()

**File:** `integration-tests/test-helper.ts`

Update the `run()` method signature and implementation:

```typescript
run(
  promptOrOptions:
    | string
    | {
        prompt?: string;
        stdin?: string;
        stdinDoesNotEnd?: boolean;
        yolo?: boolean;  // ADD THIS
      },
  ...args: string[]
): Promise<string> {
  // Determine yolo mode: default true unless explicitly set to false
  const yolo =
    typeof promptOrOptions === 'string' || promptOrOptions.yolo !== false;

  // Build command args array
  const commandArgs = [
    'node',
    this.bundlePath,
    ...(yolo ? ['--yolo'] : []),  // CONDITIONAL instead of always present
    '--ide-mode',
    'disable',
    '--provider',
    provider,
    '--model',
    model,
  ];
```

**Location:** Around line 253-297

**Rationale:** Tests that verify allowlisting need to disable `--yolo` to actually test the permission system. Default to `true` for backwards compatibility.

### Step 2: Add `matchArgs` Parameter to waitForToolCall()

**File:** `integration-tests/test-helper.ts`

Update `waitForToolCall()` signature and implementation:

```typescript
async waitForToolCall(
  toolName: string,
  timeout?: number,
  matchArgs?: (args: string) => boolean,
) {
  // Use environment-specific timeout
  if (!timeout) {
    timeout = this.getDefaultTimeout();
  }

  // Wait for telemetry to be ready before polling for tool calls
  await this.waitForTelemetryReady();

  return this.poll(
    () => {
      const toolLogs = this.readToolLogs();
      return toolLogs.some(
        (log) =>
          log.toolRequest.name === toolName &&
          (matchArgs?.call(this, log.toolRequest.args) ?? true),
      );
    },
    timeout,
    100,
  );
}
```

**Location:** Around line 599-616

**Rationale:** Allows tests to verify not just that a tool was called, but that it was called with specific arguments (e.g., verifying specific commands in `run_shell_command`).

### Step 3: Fix globalSetup.ts TypeScript Env Access

**File:** `integration-tests/globalSetup.ts`

Replace all `process.env.FOO` with `process.env['FOO']`:

```typescript
// Line ~8:
if (process.env['NO_COLOR'] !== undefined) {
  delete process.env['NO_COLOR'];
}

// Throughout the file, update all process.env accesses:
process.env['INTEGRATION_TEST_FILE_DIR'] = runDir;
// Do not set *INTEGRATION_TEST marker env vars (LLXPRT uses --ide-mode disable instead)
process.env['TELEMETRY_LOG_FILE'] = join(runDir, 'telemetry.log');
// Ensure IDE detection doesn't trigger during tests
delete process.env['TERM_PROGRAM'];

if (process.env['KEEP_OUTPUT']) {
  console.log(`Keeping output for test run in: ${runDir}`);
}
process.env['VERBOSE'] = process.env['VERBOSE'] ?? 'false';

if (process.env['KEEP_OUTPUT'] !== 'true' && runDir) {
  // ...
}
```

**Rationale:** TypeScript strict mode requires bracket notation for dynamic property access on `process.env`.

### Step 4: Update run_shell_command.test.ts Tests

**File:** `integration-tests/run_shell_command.test.ts`

For tests that check allowlisting (lines 89-263), update to:

1. Pass `yolo: false` in the options object
2. Move `args` from options object to varargs
3. Add success assertions

**Example changes:**

```typescript
// Test: "should run allowed sub-command in non-interactive mode" (line ~89)
// FROM:
const result = await rig.run({
  stdin: prompt,
  args: [`--allowed-tools=run_shell_command(${tool})`],
});

// TO:
const result = await rig.run(
  {
    stdin: prompt,
    yolo: false,
  },
  `--allowed-tools=run_shell_command(${tool})`,
);

// ADD after existing assertions:
const toolCall = rig
  .readToolLogs()
  .filter((t) => t.toolRequest.name === 'run_shell_command')[0];
expect(toolCall.toolRequest.success).toBe(true);
```

Apply similar changes to these tests:
- "should run allowed sub-command in non-interactive mode" (~line 89)
- "should succeed with no parens in non-interactive mode" (~line 117)
- "should work with ShellTool alias" (~line 177)
- "should combine multiple --allowed-tools flags" (~line 207)
- "should allow all with ShellTool and other specifics" (~line 236)

For the `--yolo` mode test (~line 144):
```typescript
// FROM:
const result = await rig.run(
  {
    prompt: prompt,
  },
  '--yolo',
);

// TO:
const result = await rig.run({
  prompt: prompt,
  yolo: true,  // Explicit instead of flag
});
```

**Note:** The upstream version skips "should combine multiple --allowed-tools flags" test due to unreliability. Consider whether to skip it in LLxprt as well.

### Step 5: Fix stdin-context.test.ts Null Safety

**File:** `integration-tests/stdin-context.test.ts`

```typescript
// FROM:
const lastRequest = rig.readLastApiRequest();
expect(lastRequest).not.toBeNull();
const historyString = lastRequest.attributes.request_text;

// TO:
const lastRequest = rig.readLastApiRequest();
expect(lastRequest?.attributes?.request_text).toBeDefined();
const historyString = lastRequest!.attributes!.request_text!;
```

**Rationale:** Proper TypeScript null safety with optional chaining and non-null assertions.

### Step 6: Fix write_file.test.ts Expect Argument Order

**File:** `integration-tests/write_file.test.ts`

```typescript
// FROM:
expect(foundToolCall, 'Expected to find a write_file tool call').toBeTruthy(
  createToolCallErrorMessage(
    'write_file',
    allTools.map((t) => t.toolRequest.name),
    result,
  ),
);

// TO:
expect(
  foundToolCall,
  createToolCallErrorMessage(
    'write_file',
    allTools.map((t) => t.toolRequest.name),
    result,
  ),
).toBeTruthy();
```

**Rationale:** Correct vitest `expect()` API usage - message should be second parameter.

### Step 7: Update ParsedLog Interface

**File:** `integration-tests/test-helper.ts`

Add `request_text` to the `ParsedLog` interface (around line 158):

```typescript
interface ParsedLog {
  attributes?: {
    'event.name'?: string;
    function_name?: string;
    function_args?: string;
    success?: boolean;
    duration_ms?: number;
    request_text?: string;  // ADD THIS
  };
  // ... rest unchanged
}
```

**Rationale:** TypeScript compliance for telemetry log parsing.

## Files to Modify

| File | Changes | Priority |
|------|---------|----------|
| `integration-tests/test-helper.ts` | Add `yolo` option, add `matchArgs`, update `ParsedLog` | High |
| `integration-tests/globalSetup.ts` | Bracket notation for `process.env` | Medium |
| `integration-tests/run_shell_command.test.ts` | Update allowlist tests, add success assertions | High |
| `integration-tests/stdin-context.test.ts` | Fix null safety | Low |
| `integration-tests/write_file.test.ts` | Fix expect() argument order | Low |

## Decision: REIMPLEMENT (Partial)

**Status:** REIMPLEMENT - Apply changes that exist in LLxprt test infrastructure

**Rationale:**
- `context-compress-interactive.test.ts` does not exist in LLxprt - SKIP those changes
- All other affected files exist in LLxprt and should be updated
- Core changes to `test-helper.ts`, `globalSetup.ts`, and `run_shell_command.test.ts` are valuable for test correctness
- Changes ensure allowlist tests actually test the permission system rather than passing vacuously

## Acceptance Criteria

- [ ] `yolo: false` tests actually disable `--yolo` flag (verify in command args)
- [ ] Allowlist tests properly enforce permissions (not passing vacuously)
- [ ] Tool success assertions verify tool calls succeeded
- [ ] TypeScript compiles: `npm run typecheck`
- [ ] All integration tests pass: `npm run test:e2e`
- [ ] `waitForToolCall()` can match on specific arguments
- [ ] No regression in existing tests

## Testing Strategy

1. Run `npm run typecheck` to verify TypeScript compliance
2. Run specific allowlist tests individually to verify `--yolo` is disabled
3. Run full integration test suite: `npm run test:e2e`
4. Verify telemetry logs show `success: true` for tool calls

## Notes

- This is primarily a **test quality** improvement, not a bug fix
- The original plan incorrectly claimed args passing was broken - it works in LLxprt
- Main value: ensures allowlist tests actually test the allowlist system
- Upstream skipped one test for reliability - consider doing the same in LLxprt
- Use LLxprt branding in all comments and documentation
