# Phase 16: End-to-End Verification

## Phase ID
`PLAN-20250218-HOOKSYSTEM.P16`

## Prerequisites

- Required: Phase 15a (integration verification) completed
- Verification: `grep -r "PLAN-20250218-HOOKSYSTEM.P15" packages/core/src/hooks/__tests__/`
- ALL prior tests must be passing

## Purpose

Final verification that the complete hook system refactor is production-ready.
This phase runs the full verification suite, checks for lingering anti-patterns
across the entire codebase, and produces an authoritative attestation that all
requirements are satisfied.

No new code is written in this phase — only verification and audit.

## E2E Verification Script

Create `project-plans/hooksystemrefactor/plan/e2e-verify.sh`:

```bash
#!/usr/bin/env bash
# @plan PLAN-20250218-HOOKSYSTEM.P16
# End-to-end verification for hook system refactor

set -euo pipefail
PASS_COUNT=0
FAIL_COUNT=0
FAILURES=()

check() {
  local name="$1"
  local cmd="$2"
  local expected="${3:-0}"

  if eval "$cmd" > /dev/null 2>&1; then
    echo "[OK] PASS: $name"
    PASS_COUNT=$((PASS_COUNT + 1))
  else
    echo "[ERROR] FAIL: $name"
    FAIL_COUNT=$((FAIL_COUNT + 1))
    FAILURES+=("$name")
  fi
}

echo "=== Hook System Refactor E2E Verification ==="
echo "Plan ID: PLAN-20250218-HOOKSYSTEM"
echo ""

# ---- TRACEABILITY: All phases executed ----
echo "--- Traceability ---"
for PHASE in P03 P04 P05 P06 P07 P08 P09 P10 P11 P12 P13 P14 P15; do
  check "Phase $PHASE markers in codebase" \
    "grep -r 'PLAN-20250218-HOOKSYSTEM.$PHASE' packages/core/src/hooks/ | grep -v '.md'"
done

# ---- REQUIREMENTS: All REQ tags present ----
echo "--- Requirement Coverage ---"
for req in DELTA-HSYS-001 DELTA-HSYS-002 \
           DELTA-HEVT-001 DELTA-HEVT-002 DELTA-HEVT-003 DELTA-HEVT-004 \
           DELTA-HRUN-001 DELTA-HRUN-002 DELTA-HRUN-003 DELTA-HRUN-004 \
           DELTA-HPAY-001 DELTA-HPAY-002 DELTA-HPAY-003 DELTA-HPAY-004 DELTA-HPAY-005 DELTA-HPAY-006 \
           DELTA-HBUS-001 DELTA-HBUS-002 DELTA-HBUS-003 \
           DELTA-HTEL-001 DELTA-HTEL-002 DELTA-HTEL-003 \
           DELTA-HAPP-001 DELTA-HAPP-002 \
           DELTA-HFAIL-001 DELTA-HFAIL-002 DELTA-HFAIL-003 DELTA-HFAIL-004 DELTA-HFAIL-005; do
  check "Requirement $req covered" \
    "grep -r '$req' packages/core/src/hooks/ | grep -v '.md'"
done

# ---- FILES: Required files exist ----
echo "--- Required Files ---"
check "hookEventHandler.ts exists" "ls packages/core/src/hooks/hookEventHandler.ts"
check "hookSystem.ts exists" "ls packages/core/src/hooks/hookSystem.ts"
check "hookBusContracts.ts exists" "ls packages/core/src/hooks/hookBusContracts.ts"
check "hookValidators.ts exists" "ls packages/core/src/hooks/hookValidators.ts"

# ---- ANTI-PATTERNS: Forbidden patterns absent ----
echo "--- Anti-Pattern Detection ---"
check "No EMPTY_SUCCESS_RESULT in catch blocks" \
  "! grep -n 'return EMPTY_SUCCESS_RESULT[^(]' packages/core/src/hooks/hookEventHandler.ts"

check "No TODO/FIXME in production hooks code" \
  "! grep -rn -E '(TODO|FIXME|HACK|STUB|XXX)' packages/core/src/hooks/ --include='*.ts' | grep -v '.test.ts' | grep -v '.md'"

check "No stubs remaining in validators" \
  "! grep 'return false; // stub' packages/core/src/hooks/hookValidators.ts"

check "No stub no-ops remaining in semantics methods" \
  "! grep '// Stub\|// no-op until P14\|// stub' packages/core/src/hooks/hookEventHandler.ts"

check "No console.log in production hooks" \
  "! grep -rn 'console\.' packages/core/src/hooks/ --include='*.ts' | grep -v '.test.ts'"

check "No V2/New/Copy version files created" \
  "! find packages/core/src/hooks -name '*V2*' -o -name '*New*' -o -name '*Copy*' | grep -q ."

# ---- TYPE SAFETY: HookEventName enum used everywhere ----
echo "--- Type Safety ---"
check "HookEventName used in validateEventPayload switch" \
  "grep 'HookEventName\.' packages/core/src/hooks/hookEventHandler.ts | grep -q 'case'"

check "SessionStartSource imported/used" \
  "grep -q 'SessionStartSource' packages/core/src/hooks/hookEventHandler.ts"

check "SessionEndReason imported/used" \
  "grep -q 'SessionEndReason' packages/core/src/hooks/hookEventHandler.ts"

check "Type predicates in hookValidators" \
  "[ \$(grep -c 'input is ' packages/core/src/hooks/hookValidators.ts) -ge 8 ]"

# ---- TESTS: Full test suite ----
echo "--- Test Suites ---"
check "Full test suite passes" "npm test 2>&1 | tail -5 | grep -qiE 'passed|Tests?.*passed'"

check "Lifecycle tests (P04)" \
  "npm test -- --testPathPattern='hookSystem-lifecycle' 2>&1 | grep -q 'passed'"

check "MessageBus TDD tests (P07)" \
  "npm test -- --testPathPattern='hookEventHandler-messagebus' 2>&1 | grep -q 'passed'"

check "Validation tests (P10)" \
  "npm test -- --testPathPattern='hookValidators' 2>&1 | grep -q 'passed'"

check "Semantics tests (P13)" \
  "npm test -- --testPathPattern='hookSemantics' 2>&1 | grep -q 'passed'"

check "Integration tests (P15)" \
  "npm test -- --testPathPattern='hookSystem-integration' 2>&1 | grep -q 'passed'"

check "Pre-existing application tests" \
  "npm test -- --testPathPattern='hooks-caller-application' 2>&1 | grep -q 'passed'"

check "Pre-existing integration tests" \
  "npm test -- --testPathPattern='hooks-caller-integration' 2>&1 | grep -q 'passed'"

# ---- BUILD ----
echo "--- Build ---"
check "TypeScript typechecks" "npm run typecheck"
check "Build succeeds" "npm run build"
check "Lint passes" "npm run lint"
check "Format passes" "npm run format --check 2>/dev/null || npm run format"

# ---- SYSTEM TEST (REAL ENTRYPOINT — production composition root, no mocks) ----
echo "--- System Test (Real Entrypoint) ---"
check "Haiku test uses real entrypoint node scripts/start.js" \
  "node scripts/start.js --profile-load synthetic 'write me a haiku' 2>&1 | grep -qi 'haiku\|syllable\|poetry\|petals\|dew\|wind'"

# Verify hook system is exercised through real entrypoint (not unit-level mocks)
check "No vi.mock/jest.mock in E2E verification script" \
  "! grep -E 'vi\.mock|jest\.mock' project-plans/hooksystemrefactor/plan/e2e-verify.sh"

# Verify observable process-boundary effects (stdout from real process)
check "Hook execution reaches process stdout (no silent failure)" \
  "node scripts/start.js --profile-load synthetic 'write me a haiku' 2>&1 | wc -c | awk '{exit ($1 < 50)}'"

# ---- FINAL SUMMARY ----
echo ""
echo "=============================================="
echo "PASS: $PASS_COUNT"
echo "FAIL: $FAIL_COUNT"

if [ ${#FAILURES[@]} -gt 0 ]; then
  echo ""
  echo "Failed checks:"
  for f in "${FAILURES[@]}"; do
    echo "  - $f"
  done
  echo ""
  echo "RESULT: [ERROR] E2E VERIFICATION FAILED"
  exit 1
else
  echo ""
  echo "RESULT: [OK] E2E VERIFICATION PASSED"
fi
```

## E2E Strictness Requirements (HARDENED)

E2E verification MUST use the real production entrypoint and composition root. Unit-level mocks are FORBIDDEN in E2E tests.

### Strictness Rules

1. **Real entrypoint**: All system-level tests MUST invoke `node scripts/start.js` — the same command
   a production user would run. No direct module imports that bypass CLI argument parsing, config loading,
   or composition root wiring.

2. **Production composition root**: The hook system under test MUST be the instance created by the
   production composition root (the same code path activated by `scripts/start.js`). No test-specific
   factory functions that assemble a "test version" of the hook system.

3. **No unit-level mocks**: E2E tests MUST NOT use `vi.mock`, `jest.mock`, or any module-level mock.
   The only acceptable test doubles are:
   - Filesystem/network stubs at the OS level (e.g., a local mock HTTP server for LLM responses)
   - Profile configuration files that route to a synthetic provider (e.g., `--profile-load synthetic`)
   These are infrastructure-level doubles, not unit-level mocks.

4. **Observable runtime effect**: Every E2E check MUST verify an observable effect at the process
   boundary — stdout output, exit code, or a file written to disk. Tests that only verify internal
   state without process-boundary observation do not qualify as E2E.

### Manual System Test

Run the haiku test to verify no regression to the main application:

```bash
# MANDATORY: use real entrypoint — node scripts/start.js (not direct module import)
node scripts/start.js --profile-load synthetic "write me a haiku"
# Expected: A haiku is produced. No crash, no hook-related error.
# Observable effect: stdout contains haiku content (verified by grep below)

# Verify observable effect at process boundary
node scripts/start.js --profile-load synthetic "write me a haiku" 2>&1 | \
  grep -qiE "haiku|syllable|poetry|petals|dew|wind|blossom|mountain|moon" && \
  echo "PASS: haiku output observed" || echo "FAIL: no haiku content in output"

# Paste FULL actual output into phase completion marker:
node scripts/start.js --profile-load synthetic "write me a haiku" 2>&1
```

## Implementation Tasks (Non-Code)

### Audit: DELTA-HFAIL-005 — HookEventName enum for internal methods

```bash
# Verify all internal routing methods use HookEventName, not raw string
grep -n "eventName: string\b" packages/core/src/hooks/hookEventHandler.ts
# Expected: 0 (internal methods should use HookEventName, not string)
grep -n "string" packages/core/src/hooks/hookEventHandler.ts | grep "eventName"
# Review each — should be HookEventName in internal scope
```

### Audit: DELTA-HBUS-001 — HookExecutionRequest/Response used exclusively on bus

```bash
grep -n "HookExecutionRequest\|HookExecutionResponse" packages/core/src/hooks/hookEventHandler.ts
# Expected: imports from hookBusContracts.ts, used in onBusRequest and publish paths
```

### Audit: DELTA-HFAIL-003 — No-match paths return success with empty outputs

```bash
grep -A 5 "makeEmptySuccessResult\|EMPTY_SUCCESS_RESULT" packages/core/src/hooks/hookEventHandler.ts
# Expected: no-match short-circuit paths return makeEmptySuccessResult() (success, empty outputs)
# NOT: buildFailureEnvelope for no-match (no-match is a SUCCESS outcome per Rule F3)
```

## Mutation Testing

Run a final mutation test pass to confirm the full test suite catches real defects:

```bash
npx stryker run --mutate packages/core/src/hooks/hookEventHandler.ts
MUTATION_SCORE=$(jq -r '.metrics.mutationScore' .stryker-tmp/reports/mutation-report.json)
[ $(echo "$MUTATION_SCORE >= 80" | bc -l) -eq 1 ] && echo "PASS" || { echo "FAIL: $MUTATION_SCORE%"; exit 1; }
```

## E2E Strictness Verification

```bash
# Verify E2E tests use real entrypoint (not direct module imports)
grep -rn "require(\|import.*from" project-plans/hooksystemrefactor/plan/e2e-verify.sh 2>/dev/null
# Expected: 0 (bash script, not a Node module — uses shell commands only)

# Verify no unit-level mocks in E2E context
grep -E "vi\.mock|jest\.mock|jest\.fn|vi\.fn" project-plans/hooksystemrefactor/plan/e2e-verify.sh
# Expected: 0

# Verify all system checks use node scripts/start.js (real entrypoint)
grep -c "node scripts/start.js" project-plans/hooksystemrefactor/plan/e2e-verify.sh
# Expected: 2+ (haiku test + hook observable effect check)

# Verify observable process-boundary effects checked
grep -c "2>&1\|grep -qi\|wc -c" project-plans/hooksystemrefactor/plan/e2e-verify.sh
# Expected: 3+ (multiple stdout-level verifications)
```

## Verification Commands

```bash
# Run full E2E script
bash project-plans/hooksystemrefactor/plan/e2e-verify.sh
# Expected: 0 failures

# Count total test assertions in this plan
grep -r "PLAN-20250218-HOOKSYSTEM" packages/core/src/hooks/ --include="*.ts" | \
  grep "@plan:" | wc -l
# Expected: 30+

# Count total test files created this plan
find packages/core/src/hooks/__tests__ -name "*.test.ts" -newer \
  project-plans/hooksystemrefactor/analysis/domain-model.md
# Expected: 4+ new test files (P04, P07/P10, P13, P15 test files)
```

## Success Criteria

- e2e-verify.sh reports 0 failures
- Haiku test passes via `node scripts/start.js` (real entrypoint — NOT direct module import)
- All requirements tagged in production code
- All 4 new test files present
- No anti-patterns (EMPTY_SUCCESS_RESULT in catch, stubs, console.log, TODO)
- TypeScript compiles, lint passes, build succeeds
- Mutation score ≥ 80% on hookEventHandler.ts
- E2E strictness: no unit-level mocks (`vi.mock`/`jest.mock`) in e2e-verify.sh
- E2E strictness: all system checks use production composition root via `node scripts/start.js`
- E2E strictness: observable process-boundary effects verified (stdout content, exit code)

## Failure Recovery

This is the final phase. If it fails:
1. Identify failing check from e2e-verify.sh output
2. Trace to which implementation phase introduced the failure
3. Fix in that phase's files (without modifying tests)
4. Re-run full e2e-verify.sh from scratch

## Phase Completion Marker

Create: `project-plans/hooksystemrefactor/.completed/P16.md`

```markdown
Phase: P16
Completed: YYYY-MM-DD HH:MM
E2E Script: PASS (N/N checks)
Haiku Test: PASS
Actual haiku output: [paste here]
All Requirements Tagged: YES
All Anti-Patterns Absent: YES
TypeScript: PASS
Lint: PASS
Build: PASS
PLAN-20250218-HOOKSYSTEM: COMPLETE [OK]
```
