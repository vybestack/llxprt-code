# Phase 13: Semantics TDD — Completion Marker

Phase: P13
Plan ID: PLAN-20250218-HOOKSYSTEM
Completed: 2026-02-18 16:35
Status: RED PHASE COMPLETE

## Test File Created

`packages/core/src/hooks/__tests__/hookSemantics.test.ts`

## Test Count

- **Total tests:** 18
- **Failing (expected):** 12
- **Passing (stub defaults):** 6
- **Property-based tests:** 5 (30%+ of total)

## Requirements Covered

| Requirement | Tests |
|-------------|-------|
| DELTA-HRUN-002 (stop semantics) | 4 tests |
| DELTA-HRUN-003 (systemMessage/suppressOutput) | 2 tests |
| DELTA-HRUN-004 (empty batch defaults) | 1 test |
| DELTA-HTEL-001 (per-hook logging) | 2 tests |
| DELTA-HTEL-002 (batch summary) | 2 tests |
| DELTA-HAPP-001/002 (stop intent surfacing) | 2 tests |

## RED Evidence Summary

### Failing Tests (12)

1. `surfaces stop intent from first hook` - stub returns shouldStop=false
2. `first stop intent wins when multiple hooks signal stop` - stub returns shouldStop=false
3. `extracts systemMessage from hook output` - stub returns undefined
4. `sets suppressOutput when hook output specifies it` - stub returns false
5. `trims whitespace from stopReason` - stub returns undefined
6. `emits one log record per hook result when logger injected` - stub is no-op
7. `emits failure diagnostic for failed hooks` - stub is no-op
8. `emits one batch_summary record per event` - stub is no-op
9. `batch summary has correct hookCount, successCount, failureCount` - stub is no-op
10. `METAMORPHIC: shouldStop=true iff at least one hook has stopReason` - stub ignores stopReason
11. `METAMORPHIC: emitPerHookLogs emits at least one record per hook result` - stub is no-op
12. `METAMORPHIC: first systemMessage in allOutputs is surfaced` - stub returns undefined

### Passing Tests (6) — Stub Defaults Are Correct

1. `no stop when no hooks signal stop` - shouldStop=false matches stub
2. `returns safe defaults for empty allOutputs` - stub matches expected empty defaults
3. `normalizes undefined stopReason to undefined` - stub matches
4. `no log records when debugLogger absent` - no-op is correct
5. `METAMORPHIC: stopReason output is trim-idempotent` - undefined is already trimmed
6. `METAMORPHIC: batch summary successCount + failureCount === hookCount` - no records to validate

## Failure Output Excerpt

```
FAIL  src/hooks/__tests__/hookSemantics.test.ts > processCommonHookOutputFields @plan:PLAN-20250218-HOOKSYSTEM.P13 > stop semantics (DELTA-HRUN-002, DELTA-HAPP-001/002) > surfaces stop intent from first hook @plan:PLAN-20250218-HOOKSYSTEM.P13
AssertionError: expected false to be true // Object.is equality

FAIL  src/hooks/__tests__/hookSemantics.test.ts > emitPerHookLogs and emitBatchSummary @plan:PLAN-20250218-HOOKSYSTEM.P13 > per-hook logging (DELTA-HTEL-001) > emits one log record per hook result when logger injected @plan:PLAN-20250218-HOOKSYSTEM.P13
AssertionError: expected +0 to be 2 // Object.is equality

FAIL  src/hooks/__tests__/hookSemantics.test.ts > Property-based tests @plan:PLAN-20250218-HOOKSYSTEM.P13 > METAMORPHIC: shouldStop=true iff at least one hook has stopReason @plan:PLAN-20250218-HOOKSYSTEM.P13 (with seed=1076276559)
Error: Property failed after 1 tests
Counterexample: [[{"hasStopReason":true,"stopReason":" ","continueFlag":false}]]
```

## Verification

- [x] 18 behavioral tests written
- [x] 5+ property-based tests (30%+)
- [x] All tests have @plan/@requirement markers
- [x] Tests fail against P12 stubs (RED evidence captured)
- [x] Lint passes
- [x] Typecheck passes
- [x] All other tests pass (11,613 in core+cli+a2a+vscode)

## Next Phase

P13a: Verification — confirm test coverage and metamorphic invariants are correctly formulated.
