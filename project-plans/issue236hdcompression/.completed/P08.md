Phase: P08
Completed: 2026-02-11T16:12:00Z
Files Modified:
  - packages/core/src/services/history/HistoryService.ts [+103 lines, -13 lines]
  - packages/core/vitest.config.ts [+1 line, -1 line] (fix: timeout → testTimeout for vitest 3.x)
Tests Passing: 23/23 from density-history.test.ts

## Verification Output
```
TypeScript: 0 errors (npx tsc --noEmit clean)
Density tests: 23 passed, 0 failed
Full suite: 399 test files passed, 1 pre-existing failure (compressionStrategyFactory high-density — future phase)
Plan markers: 3 @plan HIGHDENSITY.P08 markers
Pseudocode refs: 3 @pseudocode history-service markers
Deferred impl: none (no TODO/FIXME/HACK/STUB)
Stubs: none remaining (all 3 NotYetImplemented stubs replaced)
```

## Holistic Functionality Assessment

All three methods are fully implemented with real logic, not stubs:

1. **applyDensityResult()**: Validates 4 invariants (duplicate removals, conflict between removals/replacements, removal bounds, replacement bounds) throwing appropriate CompressionStrategyError codes. Applies replacements first via direct index assignment (no array length change), then removals in reverse index order via splice. Calls recalculateTotalTokens() at the end.

2. **getRawHistory()**: Returns `this.history` directly — same array reference, no defensive copy. Readonly typing provides the mutation contract.

3. **recalculateTotalTokens()**: Chains on `this.tokenizerLock` to serialize with pending `updateTokenCount()` calls. Uses local accumulator (`newTotal`) then atomically swaps into `this.totalTokens`. Emits `tokensUpdated` event with offset-adjusted total.

All methods follow existing HistoryService patterns (tokenizerLock chaining, debug logging, event emission shape). The feature is reachable — methods are public on HistoryService and will be called from ensureDensityOptimized() in a later phase.

## Implementation Trace
- getRawHistory(): pseudocode lines 10-15 → HistoryService.ts lines ~613-619
- applyDensityResult(): pseudocode lines 20-82 → HistoryService.ts lines ~529-606
- recalculateTotalTokens(): pseudocode lines 90-120 → HistoryService.ts lines ~627-656

## Additional Fix
- packages/core/vitest.config.ts: Changed `timeout: 30000` to `testTimeout: 30000` — the `timeout` key in vitest 3.x does not apply to test timeouts (default is 5000ms). The property-based tests with real tokenizers require >5s per test, but the config intended 30s. This was a pre-existing config bug unrelated to the density work.
