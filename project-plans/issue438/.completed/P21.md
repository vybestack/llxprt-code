# P21 Completion Evidence

## Scope
Made `packages/lsp/test/rpc-channel.test.ts` intentionally RED against current P20 behavior for RPC-channel P22-only expectations.

## Marker block present
- `@plan:PLAN-20250212-LSP.P21`
- `@requirement REQ-ARCH-020`
- `@requirement REQ-ARCH-070`
- `@pseudocode rpc-channel.md lines 01-42`

## Test coverage/assertions added
- Active tests: 11 (no skip/todo/placeholders)
- In-memory `MessageConnection` pair used (`PassThrough` + `StreamMessageReader/Writer`)
- Methods covered:
  - `lsp/checkFile`
  - `lsp/diagnostics`
  - `lsp/status`
  - `lsp/shutdown`
  - unknown method (`lsp/not-real`)
- Behavioral output assertions included (payload content and error code)

## Commands and outcomes
1. `cd packages/lsp && bunx tsc --noEmit`
   - Exit code: 0 (PASS)
2. `cd packages/lsp && bunx vitest run test/rpc-channel.test.ts`
   - Exit code: 1 (expected RED)
   - Result: 11 tests total, 6 passed, 5 failed
   - Failures align to intended P22-only behavior assertions:
     - checkFile error fallback to `[]`
     - diagnostics key alphabetical sorting
     - diagnostics error fallback to `{}`
     - status error fallback to `[]`
     - shutdown errors swallowed with `null` response

## Success condition check
- `tsc` passes: [OK]
- `vitest` fails in behavioral assertions/rejections (not syntax/import): [OK]
