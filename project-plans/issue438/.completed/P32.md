# Phase 32: Write Tool Integration - COMPLETED

**Phase ID**: `PLAN-20250212-LSP.P32`
**Completion Date**: 2025-02-12
**Status**: [OK] PASS

## Summary

Successfully implemented LSP diagnostics integration for the write-file tool with multi-file diagnostic support, graceful degradation, and proper ordering/capping.

## Files Modified

1. **packages/core/src/tools/write-file.ts**
   - Added LSP diagnostics integration after successful file write (lines 437-512)
   - Implements REQ-DIAG-040: Multi-file diagnostics after write
   - Implements REQ-DIAG-050: Written file labeled "in this file", others "in other files"
   - Implements REQ-DIAG-060: Other files capped at maxProjectDiagnosticsFiles (default 5)
   - Implements REQ-DIAG-070: Total lines capped at 50
   - Implements REQ-GRACE-050/055: Try/catch wraps all LSP code, silent failure
   - Uses in-core formatting logic to avoid cross-package imports

2. **packages/core/src/lsp/types.ts**
   - Added `maxProjectDiagnosticsFiles?: number` to LspConfig interface
   - Allows configuration of cap on number of other files to include in diagnostics

3. **packages/core/src/tools/__tests__/write-file-lsp-integration.test.ts** (NEW)
   - Created comprehensive test suite with 13 tests covering:
     - No LSP client (undefined)
     - Dead LSP client (isAlive=false)
     - Diagnostics in written file only
     - No diagnostics case
     - Severity filtering (warnings excluded by default)
     - Per-file cap (maxDiagnosticsPerFile=20)
     - Total line cap across multiple files (maxTotalLines=50)
     - LSP error during checkFile (graceful degradation)
     - LSP error during getAllDiagnostics (graceful degradation)
     - Multiple file diagnostics present
     - Deterministic file ordering (written file first, others alphabetical)
     - Other files capped at maxProjectDiagnosticsFiles (default 5)
     - Overflow suffix shown without counting toward total cap

## Test Results

```bash
# All 13 LSP integration tests pass
[OK] write-file-lsp-integration.test.ts (13 tests) - 17ms

# All 8 existing parameter tests still pass
[OK] write-file-params.test.ts (8 tests) - 15ms

# TypeScript compilation passes
[OK] npx tsc --noEmit (no errors)
```

## Requirements Satisfied

- [OK] **REQ-DIAG-040**: Multi-file diagnostics from getAllDiagnostics (line 443)
- [OK] **REQ-DIAG-045**: Known files from getAllDiagnostics (line 443)
- [OK] **REQ-DIAG-050**: Written file labeled "in this file", others "in other files" (lines 483-488)
- [OK] **REQ-DIAG-060**: Other files capped at maxProjectDiagnosticsFiles (line 451)
- [OK] **REQ-DIAG-070**: Total lines capped at 50 (lines 454, 460)
- [OK] **REQ-GRACE-050**: Try/catch wraps all LSP code (lines 436, 511)
- [OK] **REQ-GRACE-055**: Silent failure, no error text (line 511-513)

## Implementation Details

The implementation follows the plan's pseudocode structure:

1. Gets LSP client and checks if alive (line 438-439)
2. Calls `checkFile(filePath)` to trigger diagnostics for written file (line 441)
3. Calls `getAllDiagnostics()` to get all known-file diagnostics (line 444)
4. Extracts config values (includeSeverities, caps) (lines 447-450)
5. Applies maxProjectDiagnosticsFiles cap to other files (lines 452-456)
6. Formats multi-file diagnostics with:
   - Written file first (line 458)
   - Other files sorted alphabetically (line 458)
   - Severity filtering (line 466)
   - Per-file cap (line 470)
   - Total line cap (line 460)
   - Proper section labels (lines 483-488)
7. Wraps in try/catch for graceful degradation (lines 436, 511-513)

## Verification

- [OK] Plan marker `@plan:PLAN-20250212-LSP.P32` present in write-file.ts
- [OK] All tests pass (13/13 LSP integration, 8/8 params)
- [OK] TypeScript compiles without errors
- [OK] No deferred implementation code (no TODO, FIXME, placeholders)
- [OK] Cross-package imports avoided (uses in-core formatting)
- [OK] Graceful degradation verified by tests

## Notes

- Implementation uses mocks in tests following the pattern established in edit-lsp-integration
- Since `formatMultiFileDiagnostics` is in the LSP package (not accessible from core), equivalent formatting logic is implemented inline
- All caps are applied in correct order: severity → per-file → total lines (REQ-FMT-068)
- Overflow suffix lines do not count toward the total line cap (line 477)
