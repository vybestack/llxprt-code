{"body":"### What happened?\n\nif the llm kicks off a long shell call esc shows cancelled but the shell contiues\n\n### What did you expect to happen?\n\nto cancel /kill the shell job too\n\n### Client information\n\nv0.7.0-nightly.251222.e40c645db\n\n### Login information\n\n_No response_\n\n### Anything else we need to know?\n\n_No response_","coderabbit_comments":[{"author":"coderabbitai","body":"\u003c!-- This is an auto-generated issue plan by CodeRabbit --\u003e\n\n\u003cdetails\u003e\n\u003csummary\u003e\u003cb\u003eüîó Similar Issues\u003c/b\u003e\u003c/summary\u003e\n\n**Possible Duplicates**\n- https://github.com/vybestack/llxprt-code/issues/521\n\n**Related Issues**\n- https://github.com/vybestack/llxprt-code/issues/307\n- https://github.com/vybestack/llxprt-code/issues/61\n- https://github.com/vybestack/llxprt-code/issues/619\n- https://github.com/vybestack/llxprt-code/issues/525\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003e\u003cb\u003eüë§ Suggested Assignees\u003c/b\u003e\u003c/summary\u003e\n\n- [acoliver](https://github.com/acoliver)\n- [e2720pjk](https://github.com/e2720pjk)\n\u003c/details\u003e\n\n\n---\n\u003cdetails\u003e\n\u003csummary\u003eEnable issue planning\u003c/summary\u003e\n\n\u003csub\u003eTo enable issue planning, add the following to your `.coderabbit.yaml`:\u003c/sub\u003e\n```yaml\nissue_enrichment:\n  planning:\n    enabled: true\n```\n\n\u003csub\u003eYou can then request a plan by commenting `@coderabbitai plan` on any issue.\u003c/sub\u003e\n\u003c/details\u003e\n\n\u003cdetails\u003e\n\u003csummary\u003e üß™ Issue enrichment is currently in open beta.\u003c/summary\u003e\n\n\nYou can configure auto-planning by selecting labels in the issue_enrichment configuration.\n\nTo disable automatic issue enrichment, add the following to your `.coderabbit.yaml`:\n```yaml\nissue_enrichment:\n  auto_enrich:\n    enabled: false\n```\n\u003c/details\u003e\n\nüí¨ Have feedback or questions? Drop into our [discord](https://discord.gg/coderabbit) or [schedule a call](https://calendly.com/parth-coderabbit/issues-feedback)!","createdAt":"2025-12-23T00:24:01Z","url":"https://github.com/vybestack/llxprt-code/issues/948#issuecomment-3684628374"},{"author":"coderabbitai","body":"\u003c!-- This is an auto-generated reply by CodeRabbit --\u003e\n\u003e [!TIP]\n\u003e For best results, initiate chat on the files or code changes.\n\n\u003cdetails\u003e\n\u003csummary\u003eüß© Analysis chain\u003c/summary\u003e\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Find files related to shell tool execution\necho \"=== Finding shell tool related files ===\"\nfd -e py -e ts -e js -e go shell | head -20\n\necho -e \"\\n=== Searching for shell tool implementation ===\"\nrg -l \"shell.*tool\" --type=py --type=ts --type=js --type=go | head -20\n\necho -e \"\\n=== Searching for process execution and cancellation ===\"\nrg -n \"cancel.*process|kill.*process|abort.*process\" --type=py --type=ts --type=js --type=go -C2 | head -50\n```\n\nLength of output: 5840\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Read the shell tool implementation\necho \"=== Shell Tool Implementation ===\"\ncat packages/core/src/tools/shell.ts\n```\n\nLength of output: 24970\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Read the shell execution service implementation\necho \"=== Shell Execution Service Implementation ===\"\ncat packages/core/src/services/shellExecutionService.ts\n```\n\nLength of output: 18747\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Search for ESC key handling and abort controller usage\necho \"=== Searching for ESC key handling ===\"\nrg -n \"escape|ESC|Escape\" --type=ts --type=tsx -C3 | grep -i \"key\\|cancel\\|abort\" | head -40\n\necho -e \"\\n=== Searching for AbortController creation and usage ===\"\nrg -n \"AbortController|abortController|abort\\(\\)\" --type=ts --type=tsx -C2 | head -60\n\necho -e \"\\n=== Searching for tool execution cancellation ===\"\nrg -n \"cancel.*tool|abort.*tool|tool.*cancel|tool.*abort\" --type=ts --type=tsx -C2 | head -40\n```\n\nLength of output: 231\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Search for ESC key handling and abort controller usage in TS/JS files\necho \"=== Searching for ESC key handling ===\"\nrg -n \"Escape|escape|ESC\" --type=ts --type=js -C3 | head -60\n\necho -e \"\\n=== Searching for AbortController creation and usage ===\"\nrg -n \"new AbortController|abortController\" --type=ts --type=js -C3 | head -60\n```\n\nLength of output: 8893\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Read the keyboard handlers to understand ESC handling\necho \"=== Reading useKeyboardHandlers ===\"\ncat packages/ui/src/hooks/useKeyboardHandlers.ts\n\necho -e \"\\n=== Searching for cancel/abort in UI hooks ===\"\nrg -n \"onCancel|handleCancel|cancelStreaming|abortTool\" packages/ui/src/hooks/ -A3 -B3\n```\n\nLength of output: 8240\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Search for cancelAll implementation and tool execution\necho \"=== Searching for cancelAll implementation ===\"\nrg -n \"cancelAll\\s*=\" --type=ts --type=js -A5 -B2 | head -80\n\necho -e \"\\n=== Searching for tool execution with abort signal ===\"\nrg -n \"executeToolCall|execute.*tool\" --type=ts --type=js -C3 | head -60\n```\n\nLength of output: 4690\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Search for tool execution in the UI and abort handling\necho \"=== Searching for UI component that uses cancelAll ===\"\nfd -e tsx -e ts . packages/ui/src | xargs rg -l \"cancelAll\" | head -10\n\necho -e \"\\n=== Reading files that use cancelAll ===\"\nrg -n \"cancelAll\" packages/ui/src -A10 -B5 | head -100\n```\n\nLength of output: 7126\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Find the CoreToolScheduler implementation\necho \"=== Finding CoreToolScheduler ===\"\nfd -e ts -e js . packages/core/src | xargs rg -l \"class.*ToolScheduler|ToolScheduler.*cancelAll\" | head -10\n\necho -e \"\\n=== Reading CoreToolScheduler cancelAll implementation ===\"\nrg -n \"cancelAll\" packages/core/src -A10 -B5 | head -120\n```\n\nLength of output: 4146\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Read the app.tsx to understand how cancelAll is wired up\necho \"=== Reading app.tsx around cancelAll usage ===\"\ncat packages/ui/src/app.tsx | grep -A30 -B30 \"cancelAll\"\n\necho -e \"\\n=== Check how abort signal is managed in streaming lifecycle ===\"\ncat packages/ui/src/hooks/useStreamingLifecycle.ts\n```\n\nLength of output: 6247\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Check how tools are scheduled and what AbortSignal is passed\necho \"=== Reading useToolScheduler schedule implementation ===\"\ncat packages/ui/src/hooks/useToolScheduler.ts | grep -A50 \"const schedule\"\n\necho -e \"\\n=== Check CoreToolScheduler schedule method ===\"\nrg -n \"schedule.*async|scheduleToolCall\" packages/core/src/core/coreToolScheduler.ts -A20 -B5 | head -100\n```\n\nLength of output: 4204\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Read the CoreToolScheduler schedule method\necho \"=== Reading CoreToolScheduler schedule method ===\"\ncat packages/core/src/core/coreToolScheduler.ts | grep -A80 \"async schedule\"\n\necho -e \"\\n=== Check how tool execution receives abort signal ===\"\nrg -n \"executeToolWithAbortSignal|execute.*AbortSignal\" packages/core/src/core/coreToolScheduler.ts -A10 -B5\n```\n\nLength of output: 105\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Read the entire CoreToolScheduler file to understand the flow\necho \"=== Reading CoreToolScheduler structure ===\"\nrg -n \"schedule\\(|processNext|executeWith\" packages/core/src/core/coreToolScheduler.ts -C5 | head -150\n\necho -e \"\\n=== Search for tool.execute calls in CoreToolScheduler ===\"\nrg -n \"tool\\.execute|invocation\\.execute\" packages/core/src/core/coreToolScheduler.ts -C8 | head -100\n```\n\nLength of output: 1223\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Let's read key sections of CoreToolScheduler\necho \"=== Reading CoreToolScheduler to find where tools are executed ===\"\ncat packages/core/src/core/coreToolScheduler.ts | head -100\n\necho -e \"\\n=== Search for where tool invocations execute ===\"\nrg -n \"executeInvocation|ToolInvocation|confirmationHandle\" packages/core/src/core/coreToolScheduler.ts -C5 | head -150\n```\n\nLength of output: 6833\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Find where the tool invocation's execute method is called\necho \"=== Searching for invocation.execute calls ===\"\nrg -n \"invocation\\.execute\\(\" packages/core/src/core/coreToolScheduler.ts -C10\n\necho -e \"\\n=== Search for executeScheduledToolCall or similar ===\"\nrg -n \"executeScheduled|executeTool|runTool\" packages/core/src/core/coreToolScheduler.ts -C8 | head -100\n```\n\nLength of output: 102\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Let's look at the full _schedule method and processNext\necho \"=== Reading the _schedule method in full ===\"\nrg -n \"private async _schedule\" packages/core/src/core/coreToolScheduler.ts -A100 | head -120\n\necho -e \"\\n=== Look for messageBus and tool execution ===\"\nrg -n \"messageBus|MessageBus\" packages/core/src/core/coreToolScheduler.ts -C5 | head -80\n```\n\nLength of output: 6734\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Look for where the abort signal gets passed to tool invocations\necho \"=== Looking for where tools get executed with signals ===\"\nrg -n \"\\.execute\\(.*signal\" packages/core/src/core/coreToolScheduler.ts -B5 -A15\n\necho -e \"\\n=== Check if there's an AbortController created per tool ===\"\nrg -n \"AbortController|abortController\" packages/core/src/core/coreToolScheduler.ts -C5\n```\n\nLength of output: 1317\n\n---\n\nüèÅ Script executed:\n```\n#!/bin/bash\n# Look for the complete flow of how signals are passed\necho \"=== Check where the signal parameter comes from in _schedule ===\"\nrg -n \"private async _schedule\" packages/core/src/core/coreToolScheduler.ts -A200 | grep -A5 -B5 \"signal\"\n\necho -e \"\\n=== Look for handleConfirmationResponse to see if it uses the new AbortController ===\"\nrg -n \"handleConfirmationResponse\" packages/core/src/core/coreToolScheduler.ts -A30 | head -100\n```\n\nLength of output: 5958\n\n---\n\n\n\n\u003c/details\u003e\n\n@acoliver I've investigated the issue and found the root cause of why shell commands continue running even after ESC shows \"cancelled\".\n\n## Root Cause\n\nThe problem is in the **abort signal propagation** in `CoreToolScheduler`. Here's the flow:\n\n1. **User presses ESC** ‚Üí `handleCancelAll()` is called\n2. This calls `cancelStreaming()` which aborts the main `AbortController`\n3. This also calls `cancelAll()` which marks tools as cancelled in the scheduler\n\nHowever, there's a critical bug at **line 494 in `packages/core/src/core/coreToolScheduler.ts`**:\n\n```typescript\nprivate handleMessageBusResponse(response: ToolConfirmationResponse): void {\n  // ... code ...\n  \n  const abortController = new AbortController();  // ‚ùå NEW controller created!\n  void this.handleConfirmationResponse(\n    callId,\n    waitingToolCall.confirmationDetails.onConfirm,\n    derivedOutcome,\n    abortController.signal,  // ‚ùå New signal, not the original one!\n    response.payload,\n    true,\n  );\n}\n```\n\nWhen tool confirmations are handled via the message bus (e.g., from policy engine auto-approvals), a **brand new `AbortController`** is created. This new signal is completely disconnected from the original signal that was passed to `schedule()`.\n\n## The Problem\n\n- The original `AbortSignal` passed to `schedule(request, signal)` flows through validation and confirmation\n- But when `handleMessageBusResponse` processes an approval, it creates a fresh `AbortController`\n- This new signal is what gets passed to `invocation.execute(signal, ...)`  \n- When the user presses ESC, the **original** signal is aborted, but the shell tool is running with the **new** signal\n- Result: UI shows \"cancelled\" but the shell process never receives the abort signal\n\n## Solution\n\nThe `CoreToolScheduler` needs to track the original `AbortSignal` for each tool call and reuse it throughout the entire lifecycle, including when processing message bus responses. The signal should be stored alongside each tool call in the scheduler's state.\n\nWould you like me to create an issue to track this bug for fixing?","createdAt":"2025-12-23T00:27:27Z","url":"https://github.com/vybestack/llxprt-code/issues/948#issuecomment-3684633449"}],"number":948,"title":"shell tool won't cancel"}
